## Пошаговая инструкция для передачи индикатора состояния "past due" из Business Central в Dynamics 365 Sales

Ниже представлена инструкция для обеспечения доступности индикатора состояния `Past Due` из Microsoft Dynamics 365 Business Central (далее — Business Central) в Microsoft Dynamics 365 Sales (далее — Sales 365) с использованием Power Automate для регулярной передачи данных. Инструкция учитывает требования клиента из пункта 1.2 документа: сделать данные, включая индикаторы состояния, такими как `Past Due`, доступными в Sales 365.

---

### 1. Подготовка данных в Business Central

1.1. Определить источник данных для индикатора `Past Due` в Business Central.  
   - В Business Central информация о просроченных платежах обычно находится в таблице `Customer Ledger Entry` (записи по клиентам). Поле `Due Date` (дата платежа) сравнивается с текущей датой для определения просрочки.  
   - Проверить наличие прямого поля, такого как `Overdue Amount` или аналогичного индикатора. Если такого поля нет, потребуется вычислить статус `Past Due` на основе логики: если `Due Date` меньше текущей даты и платеж не выполнен (`Open` = Yes), то запись считается просроченной.

1.2. Создать вычисляемое поле или запрос в Business Central (при необходимости).  
   - Если прямого булевого поля `Past Due` в таблице `Customer` не существует, настроить запрос (Query) для извлечения клиентов с просроченными платежами.  
   - Пример запроса: выбрать `Customer No.`, `Name` и вычисляемое поле `Past Due`, где `Past Due` = `True`, если есть записи в `Customer Ledger Entry` с `Due Date` < текущей даты и `Open` = `Yes`.  
   - Сохранить запрос, например, как `OverdueCustomers`.

---

### 2. Настройка Sales 365 для отображения индикатора `Past Due`

2.1. Создать новое поле в сущности `Account` в Sales 365.  
   - Перейти в Sales 365: `Settings` → `Advanced Settings` → `Customizations` → `Customize the System`.  
   - Выбрать сущность `Account` в списке сущностей.  
   - Нажать `New Field` для создания нового поля:  
     - `Display Name`: Past Due  
     - `Name`: new_pastdue (генерируется автоматически)  
     - `Type`: Two Options (Yes/No)  
     - `Default Value`: No  
   - Сохранить изменения и опубликовать настройки (`Publish All Customizations`).

2.2. Добавить поле `Past Due` в форму `Account`.  
   - В редакторе решений открыть форму `Account` (например, `Main Form`).  
   - Перетащить поле `Past Due` из списка полей на форму в нужный раздел, например, `Summary`.  
   - Сохранить и опубликовать форму.

---

### 3. Настройка потока в Power Automate для передачи данных

3.1. Создать новый поток в Power Automate.  
   - Перейти в Power Automate: `Home` → `Create` → `Automated cloud flow`.  
   - Задать название потока, например, `Sync Past Due from BC to Sales 365`.  
   - Выбрать триггер `Recurrence` для регулярного запуска. Настроить интервал, например, каждые 15 минут:  
     - `Interval`: 15  
     - `Frequency`: Minute  
   - Нажать `Create`.

3.2. Извлечь данные о клиентах из Business Central.  
   - Добавить действие `Business Central - List records`.  
   - Настроить параметры:  
     - `Environment`: выбрать среду Business Central.  
     - `Company`: выбрать компанию.  
     - `Table`: Customers (или использовать запрос `OverdueCustomers`, если создан в шаге 1.2).  
     - `Select columns`: Customer No., Past Due (или другие поля, если используется запрос).  
   - Применить фильтр (если требуется): например, `filter=Past Due eq true` для извлечения только клиентов с просрочкой.

3.3. Обработать список клиентов из Business Central.  
   - Добавить действие `Apply to each` для обработки каждой записи из шага 3.2.  
   - В поле `Select an output from previous steps` выбрать `value` из действия `List records`.

3.4. Найти соответствующую запись в Sales 365.  
   - Внутри `Apply to each` добавить действие `Dynamics 365 - List records`.  
   - Настроить параметры:  
     - `Organization Name`: выбрать организацию Sales 365.  
     - `Entity Name`: Accounts.  
     - `Filter Query`: customerno eq '@{items('Apply_to_each')['Customer No.']}' (предполагается, что в Sales 365 есть поле `customerno`, сопоставленное с `Customer No.` из Business Central).  
   - Это действие ищет запись в Sales 365 по номеру клиента.

3.5. Обновить запись в Sales 365.  
   - Внутри `Apply to each` добавить ещё одно действие `Apply to each` для обработки результатов поиска из шага 3.4 (на случай, если найдено несколько записей, хотя обычно ожидается одна).  
   - В поле `Select an output from previous steps` выбрать `value` из действия `Dynamics 365 - List records`.  
   - Добавить действие `Dynamics 365 - Update a record`:  
     - `Organization Name`: выбрать организацию Sales 365.  
     - `Entity Name`: Accounts.  
     - `Record identifier`: выбрать `accountid` из динамического содержимого, например, `@{items('Apply_to_each_2')['accountid']}` (где `Apply_to_each_2` — внутренний цикл).  
     - `Past Due`: установить значение из Business Central, например, `@{items('Apply_to_each')['Past Due']}`.  
   - Если значение `Past Due` в Business Central не в формате Yes/No, преобразовать его: например, использовать выражение `if(equals(items('Apply_to_each')['Past Due'], 'true'), 'Yes', 'No')`.

3.6. Сохранить и протестировать поток.  
   - Нажать `Save`, затем `Test` → `Manually`.  
   - Проверить логи выполнения, чтобы убедиться, что данные корректно передаются и обновляются в Sales 365.

---

### 4. Проверка доступности данных в Sales 365

4.1. Проверить обновление записей в Sales 365.  
   - Открыть несколько записей `Account` в Sales 365.  
   - Убедиться, что поле `Past Due` отражает значение из Business Central (Yes для клиентов с просрочкой, No для остальных).  

4.2. Настроить отображение в представлениях (при необходимости).  
   - Перейти в `Advanced Find` → выбрать сущность `Accounts`.  
   - Добавить столбец `Past Due` в представление.  
   - Сохранить как новое представление, например, `Accounts with Past Due Status`.  

---

### 5. Оптимизация и документирование

5.1. Оптимизировать частоту синхронизации.  
   - Установить интервал в триггере `Recurrence` в зависимости от потребностей клиента (например, раз в час вместо каждых 15 минут, если данные не требуют частого обновления).  

5.2. Задокументировать процесс.  
   - Описать источник данных в Business Central (таблица или запрос).  
   - Указать название и настройки поля `Past Due` в Sales 365.  
   - Сохранить схему потока Power Automate с указанием интервала запуска и условий фильтрации.

---

Эта инструкция обеспечивает регулярную передачу индикатора `Past Due` из Business Central в Sales 365 с использованием Power Automate, делая его доступным для сотрудников отдела продаж в интерфейсе Sales 365.