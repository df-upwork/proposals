### Инструкция по обеспечению доступности цен на продукты из Business Central в Dynamics 365 Sales

Данная инструкция описывает процесс настройки регулярной передачи данных о ценах на продукты (product pricing) из Microsoft Dynamics 365 Business Central в Microsoft Dynamics 365 Sales с использованием Power Automate. Цель — обеспечить доступность актуальной информации о ценах для сотрудников отдела продаж в интерфейсе Dynamics 365 Sales. Инструкция учитывает использование стандартных сущностей и предполагает ежедневное обновление данных.

---

#### Предварительные требования

1. Обеспечить наличие учетной записи с правами доступа к Microsoft Dynamics 365 Business Central и Microsoft Dynamics 365 Sales.
2. Подтвердить наличие лицензии Power Automate с доступом к коннекторам для Business Central и Dynamics 365 Sales.
3. Удостовериться, что в Dynamics 365 Sales настроен хотя бы один `Price List` для привязки цен к продуктам.
4. Проверить наличие данных о ценах в Business Central в таблице `Item` или `Sales Price`, в зависимости от конфигурации системы клиента.

---

#### Шаги настройки

##### 1. Подготовка данных в Business Central

1.1. Определить источник данных о ценах в Business Central.  
   - Использовать таблицу `Item` для получения стандартной цены (`Unit Price`) для каждого продукта.  
   - При необходимости задействовать таблицу `Sales Price` для учета специфических цен, если они отличаются от стандартных.  

1.2. Убедиться в наличии уникального идентификатора продукта (например, поле `No.` в таблице `Item`), который будет использоваться для сопоставления с продуктами в Dynamics 365 Sales.

---

##### 2. Настройка Power Automate для передачи данных

2.1. Создать новый поток в Power Automate.  
   - Перейти в Power Automate через портал `make.powerautomate.com`.  
   - Выбрать `Create` → `Automated cloud flow`.  
   - Указать название потока, например, `Sync Product Pricing from BC to D365 Sales`.  

2.2. Настроить триггер `Recurrence`.  
   - Добавить триггер `Recurrence` для запуска потока по расписанию.  
   - Установить интервал выполнения, например, ежедневно в определенное время (например, 02:00 AM).  

2.3. Добавить действие для получения данных из Business Central.  
   - Добавить действие `List records` из коннектора `Dynamics 365 Business Central`.  
   - Выбрать среду (environment) Business Central.  
   - Указать сущность `Item` (или `Sales Price`, если требуется).  
   - Включить поля: `No.` (номер продукта), `Description` (описание), `Unit Price` (цена за единицу).  

2.4. Добавить цикл для обработки каждого продукта.  
   - Использовать действие `Apply to each` для обработки записей, полученных на шаге 2.3.  
   - В качестве входных данных указать результат действия `List records`.  

2.5. Проверить наличие продукта в Dynamics 365 Sales.  
   - Внутри цикла `Apply to each` добавить действие `Get record` из коннектора `Dynamics 365 Sales`.  
   - Указать сущность `Product`.  
   - Использовать фильтр для поиска продукта по полю `Product Number`, сопоставляя его с `No.` из Business Central.  

2.6. Добавить условие для проверки существования продукта.  
   - Добавить действие `Condition`.  
   - Установить условие: если результат действия `Get record` вернул запись (статус 200), продукт существует; в противном случае — нет.  

2.7. Обновить существующий продукт и его цену (ветка «If yes»).  
   - В ветке «If yes» добавить действие `List records` для поиска записи в `Price List Item`, связанной с продуктом и заданным `Price List`.  
   - Указать фильтры:  
     - `Product Id` равен идентификатору продукта из шага 2.5.  
     - `Price List Id` равен идентификатору дефолтного `Price List` в Dynamics 365 Sales.  
   - Если запись найдена:  
     - Добавить действие `Update record` для сущности `Price List Item`.  
     - Установить поле `Amount` значением `Unit Price` из Business Central.  
   - Если запись не найдена:  
     - Добавить действие `Create record` для сущности `Price List Item`.  
     - Указать `Product Id`, `Price List Id`, `Unit Price` из Business Central, а также `Unit Id` (единицу измерения, например, стандартную единицу).  

2.8. Создать новый продукт и его цену (ветка «If no»).  
   - В ветке «If no» добавить действие `Create record` для сущности `Product` в Dynamics 365 Sales.  
   - Заполнить поля:  
     - `Product Number` — значение `No.` из Business Central.  
     - `Name` — значение `Description` из Business Central.  
     - `Default UoM Id` — идентификатор стандартной единицы измерения.  
   - Добавить действие `Create record` для сущности `Price List Item`.  
   - Указать:  
     - `Product Id` — идентификатор созданного продукта.  
     - `Price List Id` — идентификатор дефолтного `Price List`.  
     - `Amount` — значение `Unit Price` из Business Central.  
     - `Unit Id` — идентификатор стандартной единицы измерения.  

2.9. Сохранить и протестировать поток.  
   - Нажать `Save` для сохранения потока.  
   - Выполнить тестовый запуск с использованием кнопки `Test`, выбрав небольшое количество записей для проверки корректности синхронизации.  

---

##### 3. Настройка отображения цен в Dynamics 365 Sales

3.1. Убедиться, что цены доступны в процессе продаж.  
   - Проверить, что при создании `Quote`, `Order` или `Opportunity` в Dynamics 365 Sales используется дефолтный `Price List`, синхронизированный с Business Central.  
   - При добавлении продукта в документ автоматически подтягивается значение `Amount` из связанной записи `Price List Item`.  

3.2. При необходимости настроить отображение цен на форме продукта.  
   - Перейти в `Settings` → `Customizations` → `Customize the System`.  
   - Открыть сущность `Product` и добавить поле `List Price` на форму, если требуется видеть цену непосредственно на карточке продукта.  
   - Обновить значение `List Price` с использованием данных из `Price List Item` через дополнительное действие в Power Automate, если это необходимо.  

---

##### 4. Проверка и мониторинг

4.1. Проверить корректность передачи данных.  
   - Сравнить цены нескольких продуктов в Business Central (поле `Unit Price`) с соответствующими значениями в `Price List Item` в Dynamics 365 Sales после выполнения потока.  

4.2. Настроить мониторинг потока.  
   - В Power Automate открыть историю выполнения потока (`Run history`) и проверить наличие ошибок.  
   - При необходимости добавить действие `Send an email` для уведомления администратора в случае сбоя.  

---

#### Примечания

- Для обеспечения согласованности данных необходимо использовать одинаковую валюту в Business Central и Dynamics 365 Sales. В случае различий добавить преобразование валют в поток Power Automate.
- Если требуется синхронизация нескольких `Price Lists` (например, для разных групп клиентов), расширить поток дополнительными условиями и действиями для обработки каждого `Price List`.
- Рекомендуется протестировать процесс на тестовой среде перед запуском в продуктивной системе, чтобы исключить возможные ошибки.

Выполнение описанных шагов позволит регулярно обновлять информацию о ценах на продукты из Business Central в Dynamics 365 Sales, делая её доступной для отдела продаж через интерфейс системы.