https://g.co/gemini/share/405e1a9853c4
3 https://gemini.google.com/app/66a61f015b30d7c2

# Гипотеза S₁: Некорректная настройка метода оплаты для off-session использования

## Основной тезис
Кастомный процесс регистрации и сохранения платежных данных клиента реализован некорректно и не подходит для будущих списаний, происходящих в отсутствие клиента («off-session»). 
Это является основной точкой отказа в системе.

## Доказательства и анализ:
Проблема, описанная клиентом (O.md::§4), напрямую касается конверсии trial→paid, которая по своей сути является off-session платежным событием. 
Клиент предоставляет данные своей карты во время активной сессии («on-session») при регистрации на 30-дневный пробный период, однако первое фактическое списание средств происходит через 30 дней, когда клиент не взаимодействует с системой.

Современные платежные регуляции, в частности директива Strong Customer Authentication (SCA) в Европе, требуют, чтобы платежные методы, предназначенные для будущего off-session использования, проходили надлежащую аутентификацию во время первоначальной on-session настройки. 
Это необходимо для получения согласия (мандата) от клиента на будущие списания.

Корректным API-примитивом Stripe для данного сценария является SetupIntent API, а не PaymentIntent API. SetupIntent используется для сохранения и аутентификации метода оплаты для будущего использования без немедленного списания средств. В то же время, PaymentIntent предназначен для обработки одного, немедленного платежа.

Вероятнее всего, текущая реализация использует PaymentIntent (возможно, с нулевой суммой или иным обходным путем), что не инициирует необходимый процесс аутентификации (например, 3D Secure) для авторизации будущих off-session списаний. 
Когда пробный период заканчивается и система пытается произвести первое списание, банк-эмитент, не имея должным образом оформленного мандата от первоначальной сессии, отклоняет транзакцию. 
Этот отказ, хотя технически может быть «мягким» (soft decline), в данном контексте является фактически «жестким» (hard decline) с кодом authentication_required, поскольку он требует вмешательства клиента для повторной аутентификации. 
Высокий процент отказов является прямым следствием выбора неверного инструмента API для поставленной задачи, что приводит к предсказуемым сбоям аутентификации в момент первого платежа.

