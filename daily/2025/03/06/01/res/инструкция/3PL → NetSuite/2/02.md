Ниже приведён пример, как может выглядеть фрагмент SuiteScript 2.x, где происходит подключение к SFTP, получение списка файлов в указанной директории и их фильтрация, например, по имени (маска) или дате. Этот код можно адаптировать под **Scheduled Script**, **Map/Reduce Script** или даже **Suitelet**, в зависимости от того, какой тип вы используете.

> **Обратите внимание**: для упрощения примера здесь показан только базовый функционал подключения и фильтрации списка файлов. В реальном проекте следует учесть хранение учётных данных (SFTP-пароль, ключи) в NetSuite (Encryption Keys/Secrets), обработку ошибок, логирование, парсинг и обновление записей в NetSuite и т. п.

---

## Шаг 1. Подготовьте доступ к SFTP в NetSuite

1. **Включите SuiteScript**  
   Убедитесь, что в NetSuite включены нужные функции (Setup → Company → Enable Features → вкладка SuiteCloud → галочка напротив «Server SuiteScript»).

2. **Сохраните пароль/ключи в NetSuite**  
   - Если аутентификация идёт по паролю, нужно создать **Password Guid** через меню **Setup → Company → Certificates/Secret Keys** (в зависимости от версии NetSuite интерфейс может отличаться).  
   - Если аутентификация идёт по ключу, то добавьте соответствующий ключ (Key) и **Host Key** сервера SFTP.  

3. **Получите Host Key 3PL**  
   - SFTP-модуль NetSuite (N/sftp) требует не только URL/порт, но и **Host Key** (и тип ключа, например, RSA или ECDSA). Это можно запросить у 3PL или получить с помощью утилит вроде `ssh-keyscan`.

---

## Шаг 2. Создайте скрипт (пример на Scheduled Script, SuiteScript 2.x)

В этом примере для краткости используется функция `execute`. Вы можете переименовать её и структуру файла, если делаете **Map/Reduce**-скрипт или другой тип.

```js
/**
 * @NApiVersion 2.x
 * @NScriptType ScheduledScript
 */

define(['N/sftp', 'N/log', 'N/record', 'N/file'], 
function(sftp, log, record, file) {

    function execute(context) {
        try {
            // 1) Создаём подключение к SFTP
            var sftpConnection = sftp.createConnection({
                username: 'SFTP_USERNAME',        // Логин для SFTP
                // Если используете пароль:
                passwordGuid: 'custsecret_sftp_password', 
                // Если используете ключ:
                // keyId: 'custsecret_sftp_privatekey',      
                // passphraseGuid: 'custsecret_sftp_passphrase',
                
                // Адрес SFTP (без 'sftp://'), только домен
                url: 'sftp.example3pl.com',  
                
                // Хост-ключ сервера (строка в Base64)
                hostKey: 'AAAAB3NzaC1yc2EAAAADAQABAAABAQD123...XYZ',
                // Тип ключа (RSA, ECDSA и т. п.)
                hostKeyType: sftp.HostKeyType.SSH_RSA,
                
                // Если 3PL использует нестандартный порт
                port: 22
            });

            // 2) Указываем директорию на сервере 3PL, откуда брать файлы
            var remoteDirectory = '/confirmations';

            // 3) Получаем список файлов в директории
            var fileList = sftpConnection.list({
                path: remoteDirectory
            });

            // 4) Фильтруем файлы по маске имени (например, файлы .csv)
            //    Или по дате, если нужно (см. fileObj.milliseconds).
            for (var i = 0; i < fileList.length; i++) {
                var fileObj = fileList[i];
                var fileName = fileObj.name;
                
                // Пример проверки: берем только файлы, оканчивающиеся на .csv
                if (fileName && fileName.toLowerCase().endsWith('.csv')) {
                    log.audit({
                        title: 'Найден файл',
                        details: 'Имя: ' + fileName
                    });

                    // 5) Скачиваем файл
                    var downloadedFile = sftpConnection.download({
                        directory: remoteDirectory,
                        filename: fileName
                    });

                    // 6) Получаем контент файла (строка)
                    var fileContents = downloadedFile.getContents();

                    // Здесь можно распарсить CSV (разбить по строкам/столбцам)
                    // и обновить соответствующие заказы в NetSuite.
                    // Например, используя N/record для поиска и апдейта Sales Orders.

                    // 7) При необходимости можно удалять/перемещать обработанный файл на SFTP,
                    //    чтобы исключить повторную обработку:
                    //    sftpConnection.remove({
                    //        path: remoteDirectory + '/' + fileName
                    //    });
                }
            }

        } catch (e) {
            log.error({
                title: 'Ошибка SFTP',
                details: e
            });
        }
    }

    return {
        execute: execute
    };
});
```

### Объяснение ключевых моментов

1. **sftp.createConnection(...)**  
   - `username`, `passwordGuid`/`keyId`/`passphraseGuid`, `url`, `hostKey`, `hostKeyType`, `port`.  
   - Какую комбинацию использовать (пароль или ключ), зависит от настроек SFTP у 3PL.  
   - `passwordGuid` или `keyId` должны быть идентификаторами тех секретов, которые вы предварительно создали и сохранили в NetSuite (через **Certificates / Secret Keys** или **Passwords**).

2. **list({ path: remoteDirectory })**  
   Возвращает массив объектов вида `{ name: 'имя_файла', type: 'FILE', size: <число>, modifiedDate: <Date>, milliseconds: <число> }`.  
   - `modifiedDate` — дата последнего изменения файла.  
   - `milliseconds` — можно использовать, чтобы фильтровать файлы по дате создания/изменения.

3. **download({ directory, filename })**  
   Возвращает объект типа `FileObject`, у которого метод `getContents()` отдаёт содержимое файла в виде строки.  
   - Если у вас CSV — можно разбить строки через `split('\n')` или использовать CSV-парсер.  
   - Если XML или JSON — парсить соответствующими методами (XML.parse(...) или JSON.parse(...)).

4. **Удаление или перемещение файла**  
   Чтобы не обрабатывать один и тот же файл много раз, после успешной загрузки и обработки стоит либо удалить файл с SFTP, либо переместить в другую директорию. Для этого есть методы:  
   - `sftpConnection.remove({ path: '/folder/filename.csv' })`  
   - `sftpConnection.move(...)` или `sftpConnection.rename(...)` (в зависимости от версии NetSuite).

5. **Фильтрация по маске или дате**  
   - В примере используется проверка `endsWith('.csv')`. При необходимости можно использовать RegExp или любую кастомную логику.  
   - Если нужно фильтровать по дате, можно сравнивать `fileObj.milliseconds` с текущей датой (в миллисекундах) или хранить «последнюю обработанную дату» в кастомной записи в NetSuite и сравнивать с ней.

6. **Безопасность и хранение паролей/ключей**  
   В коде не следует хранить пароли открытым текстом. Вместо этого используйте ссылки на NetSuite Secrets (passwordGuid / keyId / passphraseGuid). Эти GUID задаются при создании Entry в **Setup → Company → Certificates / Secret Keys** (или аналогично, в зависимости от версии интерфейса).

---

## Шаг 3. Настройте запуск скрипта

1. **Загрузите скрипт в File Cabinet**  
   Перейдите в **Customization → Scripting → Scripts → New** и загрузите этот `.js`-файл.

2. **Создайте Script Record**  
   - Определите, что это **Scheduled Script** (в метаданных файла мы указали `@NScriptType ScheduledScript`).  
   - Заполните поля Name, ID, выберите загруженный файл.

3. **Создайте Script Deployment**  
   - Перейдите в **Customization → Scripting → Script Deployments** → New.  
   - Выберите созданный Script.  
   - Укажите имя, Deployment ID, планируйте расписание (Schedule), например: каждый час, один раз в день и т. д.

4. **Тестируйте**  
   - Нажмите **Save & Execute** или **Execute now** в Deployment, проверьте логи (Script Execution Log).  
   - Убедитесь, что файлы действительно скачиваются, данные корректно обрабатываются, а обработанные файлы не загружаются повторно.

---

## Итог

Таким образом, «Создать логику подключения к SFTP-серверу и получения списка новых файлов по маске или дате» означает:

1. **Создать соединение** через `sftp.createConnection(...)`, используя необходимые параметры (логин/пароль или ключ, хост-ключ, порт).  
2. **Вызвать `list()`** для получения массива файлов в нужной папке.  
3. **С помощью JavaScript** (регулярных выражений, проверок `endsWith()`, дат `fileObj.milliseconds`) отфильтровать нужные файлы (например, *только* недавно изменённые или *только* те, что соответствуют определённому формату).  
4. **Дальше — скачивать (`download`) и обрабатывать** (парсить, обновлять заказы в NetSuite), а после успешной обработки **перемещать или удалять** файл, чтобы избежать повторной загрузки.

Все остальные шаги (парсинг CSV, обновление Sales Orders, логирование и т. д.) уже зависят от конкретной бизнес-логики и структуры данных, которую 3PL передаёт обратно в NetSuite.