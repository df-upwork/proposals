# 1. Pros
## 1.1. Изменение источника трафика после миграции
**Score**: **85**
Проблема возникла после миграции с Akamai на AWS Client VPN, что изменяет источник входящего трафика в VPC.
Теперь трафик исходит от сетевых интерфейсов AWS Client VPN Endpoint (E), защищённых группой безопасности SG(E).
Если клиент использует собственные (Custom) DNS-серверы (например, на инстансах EC2), их группы безопасности (SG(DNS)) должны быть обновлены для приёма трафика от нового источника SG(E).
Весьма вероятно, что SG(DNS) всё ещё настроены только на приём трафика от инфраструктуры Akamai, что приводит к блокировке DNS-запросов.
Упущение обновления SG при миграции сетевых решений является распространённой ошибкой.
## 1.2. Потенциальное использование Custom DNS
**Score**: **50**
Клиент работает в секторе «Engineering & Architecture» со штатом 10-99 сотрудников, что допускает использование Microsoft Active Directory для централизованного управления.
Active Directory требует наличия Custom DNS-серверов внутри VPC.
Трафик к таким серверам подлежит фильтрации группами безопасности, что делает гипотезу H возможной в данном сценарии.
## 1.3. Блокировка исходящего трафика на Endpoint
**Score**: **40**
Группа безопасности SG(E) контролирует исходящий трафик от VPN-клиентов в VPC.
Если клиент применяет ограничительные исходящие (Outbound) правила, они должны явно разрешать трафик по порту 53 (UDP/TCP) к Custom DNS-серверам.
Хотя исходящие правила по умолчанию разрешают весь трафик, существует вероятность наличия ограничительной конфигурации, блокирующей DNS-запросы на выходе из E.
# 2. Cons
## 2.1. Иммунитет стандартного Route 53 Resolver (AmazonProvidedDNS)
**Score**: **95**
Если клиент использует стандартный DNS-резолвер VPC (Route 53 Resolver по адресу `<VPC_CIDR_BASE> + 2`), гипотеза H ложна.
Трафик к этому служебному адресу не подвергается фильтрации группами безопасности.
Это подтверждается официальной документацией AWS (Amazon VPC User Guide, «Control traffic to your AWS resources using security groups»): «Security groups do not filter traffic destined to and from the following: Amazon Domain Name Services (DNS)».
В переводе: «Группы безопасности не фильтруют трафик, предназначенный для следующих служб и исходящий от них: Amazon Domain Name Services (DNS)».
Гипотеза H верна только в том случае, если используются Custom DNS-серверы.
## 2.2. Высокая вероятность базовой ошибки конфигурации DNS (Причина 1)
**Score**: **85**
Сбой произошёл сразу после миграции и настройки нового AWS Client VPN Endpoint.
Наиболее частой ошибкой в этом сценарии является некорректная конфигурация IP-адресов DNS-серверов в настройках E.
Возможно, были указаны устаревшие адреса Akamai, или поле было оставлено пустым.
Эта прямая ошибка конфигурации является статистически более вероятной причиной сбоев DNS, чем проблемы с фильтрацией SG.
## 2.3. Поведение клиента в режиме Full-Tunnel
**Score**: **70**
Если конфигурация DNS в E пуста (Причина 1) и используется режим полного туннелирования (full-tunnel), AWS VPN Client блокирует доступ к локальным DNS-серверам для предотвращения утечек.
Это приводит к полному отказу разрешения имён, что точно соответствует описанным симптомам.
Данный механизм делает Причину 1 более сильным объяснением, чем фильтрация SG.
## 2.4. Приоритет правил авторизации (Причина 2)
**Score**: **60**
Для доступа к сети через AWS Client VPN необходимы правила авторизации (Authorization Rules).
Если доступ к сети, где расположены DNS-серверы, не авторизован, трафик будет заблокирован.
Эта проверка происходит до оценки правил групп безопасности, представляя собой альтернативную причину сбоя.
# 3. Verdict
**Score**: **30**
Гипотеза H (фильтрация трафика Security Groups) является возможной, но маловероятной причиной сбоев DNS (P†).
Основное ограничение гипотезы заключается в том, что она полностью зависит от неизвестного фактора: использует ли клиент собственные (Custom) DNS-серверы.
Если клиент использует стандартный Route 53 Resolver (AmazonProvidedDNS), гипотеза H ложна, поскольку трафик к этому сервису не фильтруется группами безопасности согласно документации AWS.
В сценарии, где используются Custom DNS-серверы, гипотеза H становится правдоподобной, так как миграция с Akamai меняет источник трафика, и обновление правил SG могло быть упущено.
Однако, учитывая, что проблема возникла сразу после миграции, значительно более вероятной причиной является базовая ошибка конфигурации (Причина 1): неверное указание IP-адресов DNS-серверов в настройках AWS Client VPN Endpoint.
Эта альтернативная гипотеза объясняет симптомы более прямо и не зависит от типа используемого DNS-резолвера.