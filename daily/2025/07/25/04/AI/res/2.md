

# **Отчет: Стратегический анализ и реализация системы широковещательных push-уведомлений**

## **Раздел 1: Анализ технической предпосылки клиента (PNs)**

### **1.1. Деконструкция терминологии: "Firebase push notification" (PN-F) в сравнении с "broadcast push notification" (PN-B)**

Анализ описания проекта (PD), предоставленного клиентом (C), выявляет фундаментальное семантическое разделение, которое лежит в основе его запроса. Клиент использует две фразы, которые, с технической точки зрения, не являются взаимоисключающими, но в его понимании представляют собой разные сущности: «We were currently using Firebase push notification» (PN-F) и «we should add sending broadcast push notification feature» (PN-B) \[10.2\].

Эта формулировка указывает на ментальную модель, в которой PN-F — это существующая, но ограниченная функциональность, а PN-B — это новая, отсутствующая возможность. PN-F, в контексте текущего использования, с высокой вероятностью относится к отправке целевых (targeted) уведомлений на конкретные устройства по их уникальным регистрационным токенам. Это базовый сценарий использования Firebase Cloud Messaging (FCM), при котором сервер отправляет сообщение одному или несколь-ким конкретным устройствам, чьи токены ему известны.1

Термин PN-B, или "broadcast push notification", является общепринятым в индустрии для обозначения массовой рассылки уведомлений всем или значительной части пользователей приложения. Клиент воспринимает эту возможность как нечто, что нужно «добавить», как если бы это был отдельный модуль или технология, отсутствующая в его текущей реализации.

### **1.2. Формулирование гипотезы о заблуждении клиента**

На основании вышеизложенного анализа можно сформулировать следующую гипотезу: клиент (C) в настоящее время использует FCM для отправки уведомлений отдельным пользователям (например, транзакционных или персонализированных сообщений), управляя их регистрационными токенами на сервере. Он не осведомлен о том, что сервис Firebase Cloud Messaging, который он уже использует, предоставляет нативный механизм для реализации широковещательных рассылок, а именно **FCM Topic Messaging**.3

Вследствие этого пробела в знаниях, клиент воспринимает задачу «отправить сообщение всем» как необходимость внедрения новой, отдельной функциональности. Это заблуждение объясняет, почему он рассматривает миграцию на сторонний сервис: «we will think about converting it into OneSignal if that's the way to do» \[10.2\]. Столкнувшись с потребностью в массовой рассылке, клиент, вероятно, начал поиск решений по ключевым словам "broadcast push notification" и обнаружил OneSignal — платформу, которая активно позиционирует себя как специализированное и простое решение для таких задач, предлагая богатый функционал "из коробки".5

### **1.3. Выводы и влияние на стратегию**

Данное техническое заблуждение клиента — не просто деталь, а ключевой фактор, определяющий всю стратегию ответа на его запрос. Простое и прямолинейное предложение «использовать FCM Topic Messaging» будет технически верным, но стратегически неполным и, скорее всего, неубедительным. Такой ответ не учитывает первопричину, по которой клиент уже смотрит в сторону OneSignal и какие невысказанные требования и опасения могут за этим стоять.

Потребность клиента в "broadcast" может быть не просто желанием отправлять сообщения "всем подряд", а скрытым требованием к **надежности, управляемости и предсказуемости** массовых рассылок. Вероятно, он либо уже столкнулся с трудностями при попытке реализовать массовую рассылку вручную (например, перебором всех токенов), либо интуитивно чувствует, что его текущая архитектура не масштабируется для этой задачи. Упоминание OneSignal — это симптом, указывающий на поиск более надежного и функционального инструмента, а не просто на незнание о существовании FCM Topics.

Следовательно, успешное техническое предложение должно не просто "добавить" функцию, а адресовать эти невысказанные опасения. Оно должно продемонстрировать глубокое понимание проблемы, включая анализ рисков, связанных с различными подходами. Предложение должно сравнивать нативные решения Firebase (с их достоинствами и недостатками) с управляемыми сервисами, такими как OneSignal, чтобы предоставить клиенту полную картину для принятия взвешенного решения. Ответ должен быть на уровне стратегического консалтинга, а не простого технического исполнения.

## **Раздел 2: Критический разбор и выявление упущений в первоначальном предложении (A1)**

Исходя из анализа предпосылок клиента, можно с высокой долей уверенности реконструировать вероятные ошибки и упущения в гипотетическом первоначальном ответе (A1). Эти упущения делают ответ неполным и не соответствующим уровню экспертизы, который запрашивает клиент ("agency or beginners please do not apply") \[10.2\].

### **2.1. Ошибка диагностики: Игнорирование неявного технического заблуждения клиента**

Наиболее вероятная и фундаментальная ошибка A1 заключается в том, что он воспринял запрос клиента (T) буквально, не проведя предварительный анализ PNs. Ответ, скорее всего, не выявил, что клиент концептуально разделяет PN-F и PN-B, и, следовательно, не понял истинную причину, по которой клиент ищет внешнее решение и упоминает OneSignal. Вместо того чтобы адресовать корень проблемы (поиск надежности и управляемости), A1, вероятно, сосредоточился на поверхностной задаче (реализация broadcast).

### **2.2. Неполнота анализа: Поверхностное предложение FCM Topic Messaging**

Вторым серьезным упущением в A1, вероятно, стала рекомендация использовать FCM Topic Messaging как единственное и безальтернативное решение, своего рода "серебряную пулю", без глубокого и честного анализа его существенных недостатков.

Такой анализ упустил бы критически важную для принятия решения информацию, доступную в официальной документации и отраслевых обсуждениях:

* **Оптимизация под пропускную способность, а не задержку:** В документации Firebase прямо указано, что Topic Messaging оптимизирован для пропускной способности (throughput) в ущерб задержке (latency). Это делает его неподходящим для срочных или критически важных уведомлений, где важна скорость доставки.3  
  A1, вероятно, не акцентировал на этом внимание.  
* **Проблемы с надежностью и производительностью:** Что еще более важно, A1 почти наверняка не упомянул, что надежность Topic Messaging ставится под сомнение даже ведущими игроками рынка. Компания OneSignal, которую рассматривает сам клиент, в своей официальной документации заявляет, что **сознательно избегает использования FCM Topic Messaging из\-за его "непредсказуемых характеристик производительности" ("unpredictable performance characteristics")**.7 Это является мощнейшим аргументом против слепого внедрения данного механизма и представляет собой серьезнейшее упущение со стороны  
  A1.  
* **Скрытый троттлинг и сложность отладки:** A1, вероятно, не раскрыл детали механизмов троттлинга в FCM. Превышение лимитов на "fanout" (количество одновременных массовых рассылок) и QPS (запросов в секунду) часто приводит не к явным ошибкам, которые можно отловить и обработать, а к **тихим задержкам** в доставке сообщений.8 Это делает мониторинг и отладку проблем с доставкой крайне нетривиальной задачей, требующей анализа данных в BigQuery.10

### **2.3. Отсутствие стратегических альтернатив и анализа рисков**

A1, сфокусировавшись на одном тактическом решении, скорее всего, не предоставил клиенту спектр возможных стратегий и их компромиссов. Клиент, по сути, стоит перед стратегическим выбором:

1. Доработать существующую систему на Firebase.  
2. Мигрировать на специализированный сервис (OneSignal).

Ответ A1, предложив только один, причем не самый надежный, способ доработки (FCM Topics), не дал клиенту информации для сравнения. Он не сопоставил "быстрое, но потенциально ненадежное" решение (FCM Topics) с "более сложным в реализации, но надежным и контролируемым" решением (серверное управление токенами и multicast-рассылка) или "платным, но максимально функциональным и управляемым" решением (OneSignal).

Таким образом, A1 совершил классическую ошибку, предоставив *тактический* ответ («как сделать X») на *стратегический* по своей сути вопрос («какой инструмент или архитектура лучше всего подходит для решения моей бизнес-задачи Y с учетом рисков и затрат?»). Упоминание клиентом OneSignal уже сигнализирует о том, что он мыслит на уровне сравнения платформ. Ответ эксперта должен соответствовать этому уровню, предоставляя всесторонний анализ рисков, затрат и преимуществ каждого из путей. Отсутствие такого анализа является ключевым провалом A1 и не соответствует ожиданиям от специалиста высокого уровня.

## **Раздел 3: Обновленная техническая стратегия и руководство по реализации**

Данный раздел представляет собой комплексную техническую стратегию, разработанную с учетом анализа предпосылок клиента и недостатков первоначального подхода. Стратегия предлагает несколько путей решения задачи T, оценивая их с точки зрения надежности, сложности, масштабируемости и затрат.

### **3.1. Стратегия 1: Реализация на базе Firebase Cloud Messaging (FCM)**

Этот подход предполагает использование существующих инструментов экосистемы Firebase, что минимизирует зависимость от сторонних сервисов.

#### **3.1.1. Метод А: Рассылка по темам (FCM Topic Messaging)**

Это наиболее прямой и простой способ реализации "broadcast" функциональности в рамках FCM.

* Концепция:  
  Механизм основан на модели "издатель-подписчик" (publish/subscribe). Все клиентские приложения подписываются на одну или несколько общих тем (например, all\_users или news\_alerts). Сервер, вместо отправки сообщений на миллионы индивидуальных токенов, отправляет одно сообщение на определенную тему. FCM берет на себя задачу по "размножению" (fanout) и доставке этого сообщения всем подписанным устройствам.3  
* **Техническая реализация:**  
  * **Клиентская часть (Android/iOS/Web):** При инициализации приложения необходимо добавить код для подписки на глобальную тему. Это однократное действие, которое SDK выполняет асинхронно.  
    * **Пример для Android (Java/Kotlin):** FirebaseMessaging.getInstance().subscribeToTopic("all\_users").3  
    * **Пример для Web (JavaScript/TypeScript):** Требуется получить токен и затем использовать Firebase Admin SDK на сервере для подписки или реализовать логику подписки на клиенте.4  
  * **Серверная часть (Node.js/TypeScript):** Для отправки сообщения используется Firebase Admin SDK. Процесс включает инициализацию SDK с сервисным ключом и вызов метода sendToTopic.  
    TypeScript  
    import \* as admin from 'firebase-admin';

    // Инициализация Firebase Admin SDK (должна быть выполнена один раз)  
    // admin.initializeApp({...});

    const topic \= 'all\_users';  
    const payload \= {  
      notification: {  
        title: 'Breaking News\!',  
        body: 'A new major event has just occurred.'  
      }  
    };

    admin.messaging().sendToTopic(topic, payload)  
     .then((response) \=\> {  
        console.log('Successfully sent message:', response.messageId);  
      })  
     .catch((error) \=\> {  
        console.log('Error sending message:', error);  
      });

    Этот код отправляет уведомление всем устройствам, подписанным на тему all\_users.14  
* **Глубокий анализ компромиссов:**  
  * **Преимущества:**  
    * **Простота реализации:** Требует минимальных изменений в коде как на клиенте, так и на сервере.  
    * **Масштабируемость (теоретическая):** FCM поддерживает неограниченное количество подписчиков на одну тему.3  
    * **Эффективность для сервера:** Серверу нужно отправить только один API-запрос, что снижает нагрузку на него.  
  * **Недостатки (КРИТИЧЕСКИЕ):**  
    * **Надежность и производительность:** Как было отмечено ранее, это ключевая проблема. FCM Topic Messaging оптимизирован для высокой пропускной способности (throughput), а не для низкой задержки (latency).3 Это означает, что система спроектирована для обработки большого количества сообщений, но без гарантий быстрой доставки. Для срочных уведомлений (например, оповещение о начале трансляции) это может быть неприемлемо. Сторонние эксперты, такие как OneSignal, прямо указывают на "непредсказуемую производительность" этой функции как на причину отказа от ее использования в своей платформе, что является серьезным предостережением.7  
    * **Троттлинг и квоты:** FCM накладывает ограничения на скорость рассылки (fanout). Существует лимит в 1000 одновременных рассылок на проект. При превышении этого лимита новые запросы не отклоняются с ошибкой, а ставятся в очередь и задерживаются до завершения предыдущих.8 Это создает "тихие" задержки, которые сложно диагностировать без глубокого анализа. Фактическая скорость рассылки (QPS) не гарантирована и зависит от общей нагрузки на систему FCM.8  
    * **Сложность отладки:** Поскольку нет гарантий доставки и возможны скрытые задержки, диагностика проблем становится сложной. Если сообщение не дошло до части пользователей, определить причину (проблема с подпиской, троттлинг, проблемы на устройстве) крайне затруднительно. Единственный надежный способ анализа — это настройка экспорта данных о доставке в Google BigQuery и последующий анализ логов.10

#### **3.1.2. Метод Б: Серверное управление токенами и Multicast-рассылка**

Этот метод представляет собой более надежную и контролируемую архитектуру, которая устраняет многие недостатки Topic Messaging, но ценой усложнения системы.

* Концепция:  
  Вместо того чтобы делегировать управление аудиторией механизму тем FCM, сервер берет эту задачу на себя. Он поддерживает актуальную базу данных всех активных регистрационных токенов пользователей. Для осуществления широковещательной рассылки сервер извлекает эти токены из своей базы, формирует из них пакеты и отправляет их напрямую в FCM с помощью multicast-запросов.  
* **Архитектура решения:**  
  1. **Хранение токенов:**  
     * Клиентское приложение, при получении нового или обновлении существующего регистрационного токена FCM, отправляет его на защищенный API-endpoint на сервере.  
     * Сервер сохраняет этот токен в базе данных (например, в коллекции device\_tokens в Firebase Cloud Firestore), связывая его с идентификатором пользователя (userId) и временной меткой последнего обновления.  
  2. **Управление жизненным циклом токенов:**  
     * Токены могут становиться недействительными (например, если пользователь удалил приложение). Сервер должен реализовывать логику для очистки устаревших токенов. Это делается путем анализа ответов от FCM на multicast-запросы.  
  3. **Пакетная отправка (Multicast):**  
     * Для запуска broadcast-рассылки серверная логика (например, Cloud Function) считывает все токены из коллекции device\_tokens.  
     * Поскольку FCM API позволяет отправлять multicast-сообщение на группу до 500 токенов за один вызов, сервер должен разбить весь массив токенов на пакеты (chunks) по 500 штук.1  
     * Каждый пакет отправляется с помощью метода sendEachForMulticast (или sendMulticast) из Firebase Admin SDK.

TypeScript  
import \* as admin from 'firebase-admin';

async function sendBroadcastNotification(payload: admin.messaging.MessagingPayload) {  
  const db \= admin.firestore();  
  const tokensSnapshot \= await db.collection('device\_tokens').get();  
  const tokens \= tokensSnapshot.docs.map(doc \=\> doc.id);

  const messaging \= admin.messaging();  
  const chunkSize \= 500;

  for (let i \= 0; i \< tokens.length; i \+= chunkSize) {  
    const chunk \= tokens.slice(i, i \+ chunkSize);  
    const message: admin.messaging.MulticastMessage \= {  
      tokens: chunk,  
      notification: payload.notification,  
      data: payload.data  
    };

    const response \= await messaging.sendEachForMulticast(message);

    // Логика обработки недействительных токенов  
    response.responses.forEach((result, index) \=\> {  
      if (\!result.success) {  
        const error \= result.error;  
        if (error.code \=== 'messaging/registration-token-not-registered') {  
          const invalidToken \= chunk\[index\];  
          // Запланировать удаление недействительного токена из Firestore  
          console.log(\`Deleting invalid token: ${invalidToken}\`);  
          db.collection('device\_tokens').doc(invalidToken).delete();  
        }  
      }  
    });  
  }  
}

* **Глубокий анализ компромиссов:**  
  * **Преимущества:**  
    * **Высокая надежность и предсказуемость:** Этот метод обеспечивает доставку сообщений непосредственно на токены, минуя "непредсказуемый" механизм тем. Успех или неудача доставки каждого сообщения известны серверу.  
    * **Полный контроль над аудиторией:** Сервер точно знает, кому отправляется сообщение. Это позволяет реализовать сложную логику исключений или таргетинга на лету.  
    * **Детальная аналитика:** Сервер может вести подробный лог отправки и статусов доставки для каждого токена, что упрощает отладку и анализ.  
  * **Недостатки:**  
    * **Значительное усложнение архитектуры:** Требуется разработка и поддержка серверной логики для хранения, обновления и очистки токенов, а также для пакетной отправки.  
    * **Затраты на инфраструктуру:** Появляются дополнительные расходы на операции чтения/записи в Firestore и на выполнение Cloud Functions. При большом количестве пользователей (миллионы) чтение всех токенов для каждой рассылки может стать дорогостоящим.  
    * **Производительность сервера:** Отправка сообщений миллионам пользователей потребует значительного времени и вычислительных ресурсов на сервере, так как необходимо выполнить тысячи последовательных API-запросов к FCM.

### **3.2. Стратегия 2: Миграция на управляемый сервис (OneSignal)**

Эта стратегия предполагает делегирование всей сложности управления push-уведомлениями специализированному стороннему сервису.

#### **3.2.1. Архитектура и преимущества OneSignal**

OneSignal — это не просто альтернатива FCM, а сервис-надстройка. Для доставки уведомлений на Android-устройства он использует тот же транспортный уровень FCM, а для iOS — APNs. Однако поверх этого транспорта OneSignal добавляет собственную мощную инфраструктуру и логику, которая решает многие из врожденных проблем нативных сервисов.7

* **Ключевые преимущества:**  
  * **Надежность и Deliverability:** Это основной фокус компании. OneSignal заявляет о высоком аптайме (99.95%+), предоставляет публичный статус-пейдж и использует продвинутые механизмы повторных попыток в случае сбоев на стороне FCM/APNs.5 Как уже упоминалось, они избегают ненадежных функций вроде FCM Topics.  
  * **Расширенная сегментация:** Платформа позволяет создавать сложные динамические сегменты пользователей на основе множества критериев: теги (например, level=10, premium\_user=true), поведение в приложении (количество сессий, время в приложении), геолокация, язык, версия приложения и т.д..19 Это значительно превосходит возможности простых "тем" в FCM.  
  * **Богатая аналитика и A/B тестирование:** Встроенные инструменты для анализа эффективности кампаний (доставка, открытия, клики), отслеживания конверсий и проведения A/B-тестов для оптимизации заголовков, текста и изображений. В FCM для подобного анализа требуется сложная интеграция с BigQuery и разработка собственных дашбордов.5  
  * **Простота использования и UI:** Интуитивно понятная веб\-панель позволяет маркетологам или менеджерам создавать и отправлять кампании без участия разработчиков. API также хорошо документирован и удобен в использовании.5  
  * **Дополнительные каналы:** OneSignal является омниканальной платформой, поддерживая не только push, но и In-App сообщения, Email и SMS, что позволяет выстраивать сложные цепочки взаимодействия с пользователем (Journeys).5

#### **3.2.2. Путь миграции с FCM на OneSignal**

Миграция — это четко определенный процесс, который хорошо документирован OneSignal.

1. **Настройка в OneSignal:** Создать аккаунт и новое приложение в панели OneSignal.  
2. **Связывание с Firebase:** В настройках Android-приложения в OneSignal необходимо указать Server Key и Sender ID из существующего проекта Firebase клиента. Это позволит OneSignal использовать инфраструктуру Google для доставки уведомлений на Android-устройства.25  
3. **Интеграция SDK:** В клиентское приложение (написанное с использованием React/TypeScript для веб\-части или нативных SDK для мобильных) интегрируется OneSignal SDK. Он заменяет собой логику получения токена FCM. Вместо FCM-токена приложение будет получать OneSignal Player ID.  
4. **Импорт аудитории (опционально):** Существующих пользователей можно импортировать в OneSignal для обеспечения бесшовного перехода.  
5. **Перевод серверной логики:** Серверный код, который использовал Firebase Admin SDK для отправки, должен быть переписан для использования OneSignal REST API. Отправка широковещательного уведомления сводится к одному API-запросу, где в качестве цели указывается сегмент "Subscribed Users".26

#### **3.2.3. Таблица 1: Сравнительная матрица функций: OneSignal vs. Firebase (FCM)**

| Функция | Firebase (FCM) | OneSignal | Ключевые отличия и комментарии |
| :---- | :---- | :---- | :---- |
| **Надежность доставки (Broadcast)** | Средняя (с использованием Topics), Высокая (с Multicast). Механизм Topics имеет "непредсказуемую производительность".7 | Высокая. OneSignal использует собственную логику поверх FCM/APNs для повышения надежности, избегая проблемных функций FCM.7 | OneSignal специализируется на надежной доставке как на ключевой особенности своего сервиса. |
| **Скорость доставки (Latency)** | Зависит от метода. Topics оптимизированы под пропускную способность, не скорость.3 Multicast зависит от скорости работы вашего сервера. | Высокая. Оптимизированная инфраструктура для минимизации задержек.6 | Для критичных ко времени уведомлений OneSignal является более предсказуемым решением. |
| **Сегментация аудитории** | Базовая (через Topics). Сложная сегментация требует кастомной серверной логики. | Продвинутая. Динамические сегменты по тегам, поведению, геолокации, событиям и т.д..20 | OneSignal предоставляет мощный инструмент сегментации "из коробки", что является его ключевым преимуществом. |
| **A/B Тестирование** | Отсутствует. Требуется ручная реализация или использование Firebase A/B Testing для других целей. | Встроено. Позволяет тестировать заголовки, текст, изображения и другие элементы уведомлений.5 | Значительно упрощает оптимизацию маркетинговых кампаний. |
| **Аналитика и отчетность** | Базовая (в консоли). Глубокий анализ требует интеграции с Google BigQuery и самостоятельной обработки данных.10 | Продвинутая и встроенная. Детальные отчеты по доставке, открытиям, кликам, конверсиям. Экспорт данных.5 | OneSignal предоставляет готовые аналитические инструменты, доступные даже нетехническим специалистам. |
| **Простота настройки и UI** | Средняя. Требует написания кода для большинства операций. Консоль Firebase мощная, но ориентирована на разработчиков. | Высокая. Интуитивно понятная панель управления для маркетологов. Простая интеграция SDK.5 | OneSignal снижает нагрузку на команду разработки для повседневных задач по отправке уведомлений. |
| **Стоимость (модель ценообразования)** | Бесплатно (FCM). Затраты могут возникнуть на связанные сервисы (Firestore, Functions) при сложной реализации.9 | Freemium модель. Бесплатный план с ограничениями (например, до 10,000 web-подписчиков). Платные планы зависят от количества подписчиков.29 | Firebase дешевле для базовых нужд, но OneSignal может быть выгоднее с учетом экономии на разработке и поддержки. |
| **Управление жизненным циклом подписчиков** | Ручное. Требуется самостоятельная реализация логики отслеживания и удаления неактивных токенов. | Автоматизированное. OneSignal SDK и бэкенд управляют статусами подписки и неактивными устройствами. | OneSignal значительно упрощает управление аудиторией. |

### **3.3. Архитектура безопасности для API-endpoint'а рассылки**

Независимо от выбранной стратегии отправки, создание API-endpoint'а, который может инициировать массовую рассылку на всю базу пользователей, является операцией с высоким риском. Несанкционированный доступ к такому endpoint'у может привести к рассылке спама, фишинговых сообщений и нанести серьезный репутационный и финансовый ущерб. Поэтому его защита является обязательным требованием.

#### **3.3.1. Защита конечной точки Node.js с использованием Firebase Authentication**

Самый надежный и интегрированный способ защиты — использовать существующую систему аутентификации Firebase.

* Концепция:  
  Каждый запрос к API рассылки должен быть аутентифицирован. Это означает, что сервер должен убедиться, что запрос исходит от известного и вошедшего в систему пользователя (администратора).  
* **Реализация:**  
  1. **Клиент (административная панель):** Приложение, из которого будет инициироваться рассылка (например, внутренняя админ-панель), должно использовать Firebase Client SDK для аутентификации администратора. После успешного входа SDK предоставляет ID-токен (JWT). Этот токен должен быть включен в заголовок Authorization каждого запроса к бэкенду в формате Bearer \<ID\_TOKEN\>.31  
  2. **Сервер (Node.js/TypeScript):** На сервере создается middleware-функция для Express.js, которая перехватывает все запросы к защищенному роуту. Эта функция извлекает токен из заголовка и использует метод admin.auth().verifyIdToken(idToken) из Firebase Admin SDK для его проверки. Этот метод не только проверяет подпись и срок действия токена, но и обращается к серверам Google, чтобы убедиться, что токен не был отозван.32  
     TypeScript  
     import { Request, Response, NextFunction } from 'express';  
     import \* as admin from 'firebase-admin';

     export async function isAuthenticated(req: Request, res: Response, next: NextFunction) {  
       const { authorization } \= req.headers;

       if (\!authorization ||\!authorization.startsWith('Bearer ')) {  
         return res.status(401).send({ message: 'Unauthorized' });  
       }

       const split \= authorization.split('Bearer ');  
       if (split.length\!== 2) {  
         return res.status(401).send({ message: 'Unauthorized' });  
       }

       const token \= split;

       try {  
         const decodedToken: admin.auth.DecodedIdToken \= await admin.auth().verifyIdToken(token);  
         res.locals \= {...res.locals, uid: decodedToken.uid, role: decodedToken.role, email: decodedToken.email };  
         return next();  
       } catch (err) {  
         console.error(\`${err.code} \-  ${err.message}\`);  
         return res.status(401).send({ message: 'Unauthorized' });  
       }  
     }

#### **3.3.2. Реализация контроля доступа на основе кастомных прав (Custom Claims)**

Простой аутентификации недостаточно. Любой зарегистрированный пользователь приложения сможет получить ID-токен и, теоретически, вызвать API. Необходимо внедрить механизм авторизации — ролевую модель, которая позволит выполнять действие только определенным пользователям (администраторам). Firebase Custom Claims — это нативный и безопасный способ реализации такой модели.

* Концепция:  
  Пользователям, которые должны иметь доступ к отправке рассылок, назначается специальное право (роль), например, admin: true. Это право встраивается непосредственно в их ID-токен. Сервер при проверке токена может извлечь это право и принять решение о доступе.  
* **Реализация:**  
  1. **Назначение прав:** Необходимо создать отдельный, высокозащищенный механизм для назначения прав. Это может быть Cloud Function, доступная только другим администраторам, или ручной процесс через скрипт.  
     TypeScript  
     // Пример Cloud Function для назначения роли администратора  
     // Должна быть защищена, например, проверкой на то, что вызывающий уже является админом  
     async function grantAdminRole(email: string): Promise\<void\> {  
       const user \= await admin.auth().getUserByEmail(email);  
       await admin.auth().setCustomUserClaims(user.uid, { admin: true });  
     }

     После вызова этой функции, при следующей аутентификации пользователя (или обновлении токена), его новый ID-токен будет содержать поле { "admin": true }.33  
  2. **Проверка прав:** Middleware-функция isAuthenticated расширяется для проверки наличия необходимого права в decodedToken.  
     TypeScript  
     //... (часть из предыдущего примера)  
     try {  
       const decodedToken: admin.auth.DecodedIdToken \= await admin.auth().verifyIdToken(token);

       // Проверка авторизации  
       if (decodedToken.admin\!== true) {  
         return res.status(403).send({ message: 'Forbidden: insufficient permissions' });  
       }

       res.locals \= {...res.locals, uid: decodedToken.uid, email: decodedToken.email };  
       return next();  
     }   
     //... (обработка ошибок)

     Теперь только пользователи с флагом admin: true смогут успешно пройти проверку и получить доступ к логике отправки уведомлений.31

Предложение такой комплексной архитектуры безопасности демонстрирует уровень экспертизы, выходящий за рамки простого выполнения технического задания. Это является проактивным управлением рисками и показывает, что подрядчик думает не только о том, *как* реализовать функцию, но и о том, *как сделать это безопасно, надежно и масштабируемо*, что полностью соответствует запросу клиента на опытного исполнителя.

## **Раздел 4: Итоговая рекомендация и план действий**

### **4.1. Синтез анализа: Оценка стратегий в контексте профиля клиента**

Принятие окончательного решения требует сопоставления технических характеристик предложенных стратегий с профилем и неявными потребностями клиента (C). Анализ его профиля на Upwork и описания проекта (PD) выявляет несколько ключевых факторов:

* **Срочность:** Фраза "right now" указывает на высокую срочность задачи \[10.2\]. Решение должно быть реализовано быстро.  
* **Требования к опыту:** Явное требование "agency or beginners please do not apply" говорит о том, что клиент ценит экспертизу и, вероятно, ожидает не простого исполнителя, а технического консультанта, способного предложить надежное и продуманное решение \[10.2\].  
* **Технологический стек:** Клиент четко определил стек: node.js, typescript, docker \[10.2\]. Решение должно органично вписываться в эту экосистему.  
* **Бюджетная неопределенность:** Низкие показатели Total spent ($110) и Hire rate (58%) могут свидетельствовать о нескольких вещах: это может быть новый клиент на платформе, он может быть чувствителен к затратам, или же он ищет долгосрочного партнера и использует этот проект как тестовый \[11.3\]. Эта неопределенность делает рискованным предложение решений с высокими и/или непредсказуемыми ежемесячными платежами.

### **4.2. Таблица 2: Сводное сравнение стратегий широковещательной рассылки**

Для наглядного представления компромиссов, ниже приведена сводная таблица, оценивающая три предложенных метода по ключевым для клиента метрикам.

| Стратегия | Сложность реализации | Надежность и предсказуемость | Масштабируемость | Затраты на поддержку | Прямые денежные затраты |
| :---- | :---- | :---- | :---- | :---- | :---- |
| **1A: FCM Topic Messaging** | Низкая | Низкая / Средняя | Высокая (по подписчикам), но с ограничениями по QPS | Низкие (в коде), Высокие (в отладке) | Минимальные (практически отсутствуют) |
| **1B: FCM Server-Managed Tokens** | Средняя | Высокая | Высокая, но ограничена производительностью сервера | Средние (управление токенами) | Низкие (затраты на Firestore/Functions) |
| **2: Миграция на OneSignal** | Низкая / Средняя | Очень высокая | Очень высокая | Минимальные | Средние / Высокие (зависят от числа подписчиков) |

### **4.3. Двухэтапная рекомендация**

Исходя из комплексного анализа, наиболее сбалансированным и стратегически верным подходом является двухэтапная рекомендация, которая учитывает как немедленные потребности клиента, так и его потенциальный рост в будущем.

#### **Краткосрочное решение (Рекомендация №1): Реализация Стратегии 1Б (Серверное управление токенами и Multicast-рассылка)**

На текущем этапе рекомендуется реализовать систему широковещательных уведомлений с использованием серверного управления токенами в рамках существующей экосистемы Firebase.

* **Обоснование:**  
  1. **Решение основной проблемы:** Этот подход напрямую решает главную невысказанную проблему клиента — потребность в **надежной и контролируемой** массовой рассылке, устраняя непредсказуемость FCM Topic Messaging.  
  2. **Скорость и соответствие стеку:** Решение может быть реализовано относительно быстро, так как не требует изучения и интеграции API сторонних сервисов. Оно полностью соответствует заявленному технологическому стеку (node.js, typescript, Firebase) \[10.2\].  
  3. **Контроль затрат:** Данный метод позволяет избежать введения новых ежемесячных абонентских плат, что является важным фактором при бюджетной неопределенности. Затраты на использование Firestore и Cloud Functions на начальном и среднем масштабе будут незначительными и предсказуемыми.  
  4. **Демонстрация экспертизы:** Реализация этой архитектуры, включая систему очистки невалидных токенов и безопасный API, демонстрирует высокий уровень технической компетенции, которого ожидает клиент.

#### **Долгосрочная стратегия (Рекомендация №2): Рассмотрение миграции на OneSignal (Стратегия 2\)**

Необходимо проинформировать клиента, что по мере роста его бизнеса и усложнения маркетинговых задач, поддержка самостоятельно разработанного решения может стать менее эффективной. В долгосрочной перспективе следует рассмотреть плановую миграцию на OneSignal.

* **Обоснование:**  
  1. **Масштабируемость функционала:** Если в будущем клиенту потребуются сложные маркетинговые кампании, продвинутая сегментация, A/B-тестирование, омниканальные цепочки (Email, SMS), OneSignal предоставит этот функционал "из коробки", и его использование станет экономически более оправданным, чем разработка аналогичных инструментов с нуля.5  
  2. **Снижение нагрузки на разработку:** OneSignal берет на себя всю сложность, связанную с инфраструктурой уведомлений, ее надежностью, масштабированием и соответствием изменениям в политиках платформ (Google, Apple). Это высвобождает ресурсы команды разработки для решения основных бизнес-задач.  
  3. **Готовая аналитика для бизнеса:** Платформа предоставляет готовые аналитические дашборды, доступные нетехническим специалистам (маркетологам, менеджерам), что способствует принятию решений на основе данных без привлечения разработчиков.5

### **4.4. Заключительные соображения для предложения клиенту**

Финальное предложение клиенту должно быть структурировано как четкий план действий, подчеркивающий стратегический подход.

* **Предлагаемый план действий:**  
  1. **Этап 1 (Решение текущей задачи):** Разработка и внедрение системы широковещательных уведомлений на основе Стратегии 1Б (серверное управление токенами) с полностью защищенным API на базе Firebase Authentication и Custom Claims. Этот этап быстро и надежно решает поставленную задачу T.  
  2. **Этап 2 (Стратегическое развитие, опционально):** По мере роста пользовательской базы и усложнения требований к взаимодействию с аудиторией, провести повторную оценку экономической целесообразности и, при необходимости, выполнить плановую и бесшовную миграцию на платформу OneSignal.

Такой двухэтапный план демонстрирует не только способность решить сиюминутную техническую проблему, но и стратегическое видение развития продукта. Это отличает эксперта-консультанта от простого исполнителя и полностью соответствует запросу клиента на специалиста высокого уровня, способного обеспечить надежный и долгосрочный результат.

#### **Works cited**

1. Build app server send requests | Firebase Cloud Messaging \- Google, accessed July 26, 2025, [https://firebase.google.com/docs/cloud-messaging/send-message](https://firebase.google.com/docs/cloud-messaging/send-message)  
2. Send FCM Push Notification from Node.js using Firebase Cloud Messaging (FCM) HTTP V1–2025 | by Rhythm Khandelwal | Medium, accessed July 26, 2025, [https://medium.com/@rhythm6194/send-fcm-push-notification-in-node-js-using-firebase-cloud-messaging-fcm-http-v1-2024-448c0d921fff](https://medium.com/@rhythm6194/send-fcm-push-notification-in-node-js-using-firebase-cloud-messaging-fcm-http-v1-2024-448c0d921fff)  
3. Topic messaging on Android | Firebase Cloud Messaging \- Google, accessed July 26, 2025, [https://firebase.google.com/docs/cloud-messaging/android/topic-messaging](https://firebase.google.com/docs/cloud-messaging/android/topic-messaging)  
4. Send messages to topics on Web/JavaScript | Firebase Cloud Messaging \- Google, accessed July 26, 2025, [https://firebase.google.com/docs/cloud-messaging/js/topic-messaging](https://firebase.google.com/docs/cloud-messaging/js/topic-messaging)  
5. The Best Alternative to Firebase Cloud Messaging (FCM) \- OneSignal, accessed July 26, 2025, [https://onesignal.com/onesignal-vs-firebase-cloud-messaging](https://onesignal.com/onesignal-vs-firebase-cloud-messaging)  
6. OneSignal vs Firebase \- Back4App Blog, accessed July 26, 2025, [https://blog.back4app.com/onesignal-vs-firebase/](https://blog.back4app.com/onesignal-vs-firebase/)  
7. Firebase Cloud Messaging (FCM) vs. OneSignal, accessed July 26, 2025, [https://onesignal.com/blog/firebase-vs-onesignal/](https://onesignal.com/blog/firebase-vs-onesignal/)  
8. \[FIREBASE CLOUD MESSAGING\] \[FCM\] Topic sends and performance concerns, accessed July 26, 2025, [https://groups.google.com/g/firebase-talk/c/2RrbAVUBm5k](https://groups.google.com/g/firebase-talk/c/2RrbAVUBm5k)  
9. Firebase Cloud Messaging (FCM) and its Push Notification Service | by Champika Mendis, accessed July 26, 2025, [https://champikamendis-cm.medium.com/firebase-cloud-messaging-fcm-and-its-push-notification-service-a710275da43](https://champikamendis-cm.medium.com/firebase-cloud-messaging-fcm-and-its-push-notification-service-a710275da43)  
10. Understanding message delivery | Firebase Cloud Messaging \- Google, accessed July 26, 2025, [https://firebase.google.com/docs/cloud-messaging/understand-delivery](https://firebase.google.com/docs/cloud-messaging/understand-delivery)  
11. Understanding FCM Message Delivery on Android \- The Firebase Blog, accessed July 26, 2025, [https://firebase.blog/posts/2024/07/understand-fcm-delivery-rates/](https://firebase.blog/posts/2024/07/understand-fcm-delivery-rates/)  
12. Send messages to multiple devices | Firebase Cloud Messaging \- Google, accessed July 26, 2025, [https://firebase.google.com/docs/cloud-messaging/android/send-multiple](https://firebase.google.com/docs/cloud-messaging/android/send-multiple)  
13. Send messages to multiple devices | Firebase Cloud Messaging \- Google, accessed July 26, 2025, [https://firebase.google.com/docs/cloud-messaging/js/send-multiple](https://firebase.google.com/docs/cloud-messaging/js/send-multiple)  
14. Sending topic notifications using firebase-admin \- Stack Overflow, accessed July 26, 2025, [https://stackoverflow.com/questions/65732931/sending-topic-notifications-using-firebase-admin](https://stackoverflow.com/questions/65732931/sending-topic-notifications-using-firebase-admin)  
15. Firebase Cloud Messaging comes to the Admin Node.js SDK, accessed July 26, 2025, [https://firebase.blog/posts/2017/02/firebase-cloud-messaging-integrated/](https://firebase.blog/posts/2017/02/firebase-cloud-messaging-integrated/)  
16. Limitations for Firebase Notification Topics \- Stack Overflow, accessed July 26, 2025, [https://stackoverflow.com/questions/38829466/limitations-for-firebase-notification-topics](https://stackoverflow.com/questions/38829466/limitations-for-firebase-notification-topics)  
17. How to debug Firebase Cloud Messaging? \- Stack Overflow, accessed July 26, 2025, [https://stackoverflow.com/questions/49121215/how-to-debug-firebase-cloud-messaging](https://stackoverflow.com/questions/49121215/how-to-debug-firebase-cloud-messaging)  
18. FCM or OneSignal? : r/androiddev \- Reddit, accessed July 26, 2025, [https://www.reddit.com/r/androiddev/comments/c7iwtx/fcm\_or\_onesignal/](https://www.reddit.com/r/androiddev/comments/c7iwtx/fcm_or_onesignal/)  
19. Product Demo \- OneSignal, accessed July 26, 2025, [https://onesignal.com/videos/product-demo](https://onesignal.com/videos/product-demo)  
20. Create segment \- OneSignal Documentation, accessed July 26, 2025, [https://documentation.onesignal.com/reference/create-segments](https://documentation.onesignal.com/reference/create-segments)  
21. Segments \- OneSignal Documentation, accessed July 26, 2025, [https://documentation.onesignal.com/docs/segmentation](https://documentation.onesignal.com/docs/segmentation)  
22. Firebase Cloud Messaging VS OneSignal \- Stack Overflow, accessed July 26, 2025, [https://stackoverflow.com/beta/discussions/77193222/firebase-cloud-messaging-vs-onesignal](https://stackoverflow.com/beta/discussions/77193222/firebase-cloud-messaging-vs-onesignal)  
23. Top Push Notification Statistics of 2022 \- OneSignal, accessed July 26, 2025, [https://onesignal.com/blog/insights-from-118-billion-push-notifications-sent-through-onesignal/](https://onesignal.com/blog/insights-from-118-billion-push-notifications-sent-through-onesignal/)  
24. OneSignal Documentation \- OneSignal, accessed July 26, 2025, [https://documentation.onesignal.com/](https://documentation.onesignal.com/)  
25. Push Notifications in Android Using OneSignal \- GeeksforGeeks, accessed July 26, 2025, [https://www.geeksforgeeks.org/android/push-notifications-in-android-using-onesignal/](https://www.geeksforgeeks.org/android/push-notifications-in-android-using-onesignal/)  
26. REST API Overview \- OneSignal Documentation, accessed July 26, 2025, [https://documentation.onesignal.com/reference/rest-api-overview](https://documentation.onesignal.com/reference/rest-api-overview)  
27. Push Notifications \- OneSignal \- Natively Docs, accessed July 26, 2025, [https://docs.buildnatively.com/guides/integration/push-notifications-onesignal](https://docs.buildnatively.com/guides/integration/push-notifications-onesignal)  
28. Best Push Notification Service 2025 : Firebase | Engagelab | Onesignal, accessed July 26, 2025, [https://www.engagelab.com/blog/best-push-notification-service](https://www.engagelab.com/blog/best-push-notification-service)  
29. Pricing \- OneSignal, accessed July 26, 2025, [https://onesignal.com/pricing](https://onesignal.com/pricing)  
30. OneSignal Pricing 2025, accessed July 26, 2025, [https://www.g2.com/products/onesignal/pricing](https://www.g2.com/products/onesignal/pricing)  
31. RodrigoBertotti/api-example-firebase-admin-nodejs \- GitHub, accessed July 26, 2025, [https://github.com/RodrigoBertotti/api-example-firebase-admin-nodejs](https://github.com/RodrigoBertotti/api-example-firebase-admin-nodejs)  
32. How to set up Firebase Authentication in Node.js Application \- Aegis Softtech, accessed July 26, 2025, [https://www.aegissofttech.com/insights/setup-firebase-authentication-in-nodejs/](https://www.aegissofttech.com/insights/setup-firebase-authentication-in-nodejs/)  
33. Introduction to the Admin Auth API | Firebase Authentication \- Google, accessed July 26, 2025, [https://firebase.google.com/docs/auth/admin](https://firebase.google.com/docs/auth/admin)  
34. Firebase Auth Tutorial \#19 \- Adding Admins \- YouTube, accessed July 26, 2025, [https://www.youtube.com/watch?v=VvcBqPua2DI](https://www.youtube.com/watch?v=VvcBqPua2DI)