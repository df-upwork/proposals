https://gemini.google.com/share/216662dd8d3f

# 1. `R`

## 1.1. `C4↯⬆⠿` (Доводы за `S⌖A2ᚖ-T` — Google Cloud Dataflow)

### 1.1.1. `C4↯₁-S⌖A2ᚖ-T`: Полный контроль над параметрами соединения
#### Суть
Данный подход подразумевает использование официального шаблона Dataflow «MongoDB to BigQuery (CDC)», который принимает конфигурацию в виде стандартной строки подключения URI.
#### Оценка
100
#### Доводы за
Шаблон Dataflow передает параметр `mongoDbUri` непосредственно драйверу MongoDB без промежуточной валидации API, что позволяет инженеру явно добавить критический флаг `directConnection=true`.
Наличие этого флага гарантированно отключает встроенный механизм обнаружения топологии (SDAM), заставляя драйвер игнорировать список узлов кластера и работать исключительно через указанную точку входа.
Это техническое свойство делает возможным работу через Private Service Connect или SSH-туннели, где прямая маршрутизация к членам репликационного набора невозможна.
#### Доводы против
Ручное формирование строки подключения (URI) требует повышенного внимания к синтаксису и кодированию специальных символов в пароле, что может вызвать ошибки на этапе запуска.

### 1.1.2. `C4↯₂-S⌖A2ᚖ-T`: Нативное разрешение DNS в приватной сети
#### Суть
Вычислительные ресурсы сервиса Dataflow (воркеры) разворачиваются непосредственно внутри пользовательской виртуальной сети (`datastream-net`), становясь её полноправными участниками.
#### Оценка
95
#### Доводы за
Нахождение воркеров внутри периметра VPC обеспечивает им автоматический доступ к настроенным зонам Cloud DNS и приватным DNS-записям.
Это свойство позволяет корректно разрешать внутренние доменные имена MongoDB Atlas (`*.mongodb.net`) в IP-адреса Private Service Connect без использования дополнительных прокси-серверов.
Трафик репликации при такой архитектуре маршрутизируется исключительно внутри магистральной сети Google, полностью удовлетворяя требованию задачи `T⁎` об исключении выхода в публичный интернет.
#### Доводы против
Для функционирования воркеров Dataflow без публичных IP-адресов требуется предварительная настройка Private Google Access или Cloud NAT для доступа к API Google Cloud.

### 1.1.3. `C4↯₃-S⌖A2ᚖ-T`: Операционная сложность и экономика
#### Суть
Dataflow является платформой для исполнения произвольных конвейеров обработки данных Apache Beam, что влечет за собой иную модель управления и тарификации по сравнению с Datastream.
#### Оценка
70
#### Доводы за
Использование Dataflow открывает возможности для сложной трансформации данных (ETL), маскирования чувствительной информации и обогащения записей непосредственно в потоке репликации.
Сервис обеспечивает автоматическое горизонтальное масштабирование вычислительных мощностей, что позволяет эффективно справляться с пиковыми нагрузками при начальной синхронизации больших коллекций.
#### Доводы против
Стоимость постоянно запущенного потокового конвейера (Streaming Job) складывается из времени работы vCPU и памяти, что для задач с малым объемом изменений может быть кратно дороже тарификации Datastream за гигабайт.
Управление жизненным циклом конвейеров Dataflow (обновление, мониторинг лага, обработка ошибок) требует от команды эксплуатации более высоких инженерных компетенций по сравнению с настройкой Datastream.

## 1.2. `C4↯⬇⠿` (Доводы за `S⌖A2ᚖ-R5` — Datastream + Прокси)

### 1.2.1. `C4↯₄-S⌖A2ᚖ-R5`: Гипотеза о скрытых возможностях API
#### Суть
Данная стратегия строится на предположении, что в CLI-инструментарии `gcloud` или API Datastream существует недокументированный способ принудительно активировать режим `directConnection` для профиля MongoDB.
#### Оценка
0
#### Доводы за
Отсутствуют, так как глубокий анализ публичной документации, клиентских библиотек и Terraform-провайдеров не подтвердил существование флагов вида `--mongodb-direct-connection` в текущей версии API v1.
#### Доводы против
Объектная модель конфигурации `MongodbProfile` в Datastream API является строго типизированной и ограничивает ввод параметров полями `hostname`, `username` и `password`.
Попытка передать произвольные параметры через существующие поля блокируется валидацией на стороне сервиса, что делает невозможной инъекцию настроек драйвера.
Опора на несуществующую функциональность при проектировании архитектуры гарантированно приведет к провалу на этапе реализации.

### 1.2.2. `C4↯₅-S⌖A2ᚖ-R5`: Архитектура с промежуточным проксированием
#### Суть
Предлагается сохранить сервис Datastream, но маршрутизировать трафик через промежуточный TCP-прокси (NGINX) в сети клиента, который возьмет на себя задачи DNS-резолвинга и терминации SSL.
#### Оценка
10
#### Доводы за
Внедрение прокси-сервера действительно технически решает проблемы отсутствия DNS в Datastream и позволяет подменить SNI для прохождения валидации сертификатов Atlas.
Это решение позволило бы использовать удобный интерфейс Datastream и его экономичную модель тарификации, если бы проблема с поведением драйвера была устранима.
#### Доводы против
Без возможности активировать `directConnection` на стороне Datastream драйвер MongoDB неизбежно запросит карту топологии у Atlas через прокси.
Получив в ответе список реальных адресов узлов кластера, драйвер попытается установить прямые соединения с ними в обход прокси, что приведет к разрыву связи.
Введение в схему неуправляемых виртуальных машин с NGINX создает единую точку отказа и противоречит принципам Serverless, требуя дополнительных усилий по администрированию.

## 1.3. Итоговый вердикт

### 1.3.1. Анализ противоречия `C4⊥`
Проведенный анализ показал, что конфликт между рекомендациями разрешается в пользу Dataflow по причине технической несостоятельности альтернативы с прокси.
Рекомендация `S⌖A2ᚖ-R5` (Datastream + Proxy) опирается на ошибочное предположение о гибкости настройки драйвера внутри закрытого сервиса Datastream.
В текущих условиях API Datastream не позволяет отключить механизм обнаружения топологии MongoDB, что делает невозможным использование любых промежуточных узлов для подключения к кластерам Replica Set через Private Service Connect.
Стратегия `S⌖A2ᚖ-T` (Dataflow), напротив, базируется на открытых стандартах драйвера MongoDB и возможностях шаблонов Apache Beam, предоставляя гарантированный способ управления параметрами соединения.

### 1.3.2. Решение
Единственным валидным архитектурным решением задачи `T⁎`, обеспечивающим приватность и работоспособность репликации, является **переход на использование Google Cloud Dataflow (`S⌖A2ᚖ-T`)**.
Вам необходимо отказаться от попыток настроить Datastream в текущей топологии, так как это технический тупик.
Разверните официальный шаблон Dataflow «MongoDB to BigQuery (CDC)» в вашей VPC.
В конфигурации шаблона используйте строку подключения с обязательным параметром `directConnection=true`, указывающую на IP-адрес Private Service Connect.