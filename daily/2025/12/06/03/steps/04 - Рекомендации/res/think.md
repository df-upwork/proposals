https://gemini.google.com/share/90e75ec582ea

## R⬆₁: Использование SSH-туннелирования (Bastion Host)

### Суть
Данная рекомендация предполагает изменение метода подключения на «Forward SSH tunnel», который нативно поддерживается сервисом Datastream.
Вам необходимо развернуть одну небольшую виртуальную машину (Bastion Host) внутри вашей сети `datastream-net`.
Сервис Datastream будет устанавливать зашифрованное SSH-соединение с этим бастионом, используя его как шлюз в вашу инфраструктуру.
Ключевым моментом является то, что разрешение DNS-имен MongoDB Atlas будет выполняться процессом SSH на самом бастионе.
Поскольку бастион находится внутри VPC, он имеет доступ к Private DNS Zone и корректно преобразует адреса `*.mongodb.net` в приватные IP-адреса PSC Endpoint.
После разрешения имени трафик будет перенаправлен бастионом на целевой PSC Endpoint, оставаясь внутри приватного контура.
Это архитектурное решение автоматически обходит оба главных препятствия: отсутствие DNS в Datastream и нетранзитивность пиринга.

### Оценка
95

### Достоинства
Метод официально рекомендовав Google Cloud для сценариев со сложной сетевой топологией и приватными источниками данных.
Использование удаленного разрешения DNS (Remote DNS Resolution) через бастион полностью устраняет проблему Split-Horizon DNS.
Соединение инициируется локальным ресурсом (бастионом) внутри VPC, что решает проблему нетранзитивности пиринга для PSC.
Подход гарантирует успешную валидацию TLS-сертификатов, так как позволяет использовать доменные имена в строке подключения.
Конфигурация требует минимальных усилий по настройке инфраструктуры и сводится к управлению одной виртуальной машиной.
Обеспечивается высокий уровень безопасности за счет шифрования трафика внутри SSH-туннеля.

### Недостатки
Инкапсуляция трафика базы данных внутрь протокола SSH создает дополнительные накладные расходы на процессор (проблема TCP-over-TCP).
В сценариях с экстремально высокой пропускной способностью (High Throughput CDC) производительность одного туннеля может стать узким местом.
Бастион-хост становится единой точкой отказа (SPOF), что требует настройки группы инстансов (MIG) для автовосстановления.
Необходимо управлять SSH-ключами доступа и обеспечивать безопасность самой промежуточной виртуальной машины.

## R⬆₂: Внедрение промежуточного L4 TCP-прокси

### Суть
Эта рекомендация заключается в установке выделенного прокси-сервера (например, Nginx или HAProxy) внутри сети `datastream-net`.
Datastream настраивается на подключение к приватному IP-адресу этого прокси-сервера через существующий VPC Peering.
В профиле подключения Datastream необходимо обязательно добавить параметр `directConnection=true` для отключения автообнаружения топологии.
Прокси-сервер принимает входящие пакеты, разрешает имя назначения через системный резолвер VPC и пересылает трафик на PSC Endpoint.
Прокси настраивается в режиме «stream» (Layer 4) для прозрачной передачи зашифрованного трафика без терминации SSL.
Таким образом создается транзитный узел, который соединяет сеть Datastream и PSC Endpoint, преодолевая сетевые ограничения.

### Оценка
85

### Достоинства
Проксирование на транспортном уровне обеспечивает более высокую производительность и меньшие задержки по сравнению с SSH-туннелированием.
Отсутствует двойное шифрование трафика, что снижает нагрузку на вычислительные ресурсы промежуточного узла.
Решение предоставляет администраторам полный контроль над параметрами TCP-стека, таймаутами и буферизацией соединений.
Архитектура позволяет легко масштабироваться горизонтально путем добавления прокси-серверов за внутренним балансировщиком нагрузки.

### Недостатки
Существует высокий риск ошибок валидации TLS-сертификатов, так как Datastream подключается к IP-адресу прокси, а сертификат выдан на доменное имя.
Использование параметра `directConnection` отключает встроенные в драйвер механизмы автоматического переключения при сбоях (Failover).
Решение требует глубокой технической экспертизы для корректной настройки Nginx и отладки возможных проблем с SSL.
Эксплуатационная сложность выше, чем у SSH-туннеля, из-за необходимости администрирования программного обеспечения прокси.

## R⬆₃: Использование Datastream PSC Interfaces

### Суть
Данный подход предполагает отказ от VPC Peering в пользу создания интерфейса Datastream непосредственно в вашей VPC через механизм Network Attachments.
Datastream получает сетевой интерфейс в подсети пользователя, что технически помещает его в одну сеть с PSC Endpoint.
Однако, согласно документации, сервис Datastream даже в этом режиме не поддерживает разрешение DNS-имен в приватных соединениях.
Вам придется указывать IP-адреса узлов MongoDB Atlas в конфигурации подключения вместо их доменных имен.

### Оценка
60

### Достоинства
Метод исключает использование промежуточных виртуальных машин, снижая эксплуатационные расходы и сложность обслуживания.
Трафик остается строго внутри магистральной сети Google и изолирован от других потребителей пиринга.
Решение соответствует современной стратегии Google Cloud по переходу на интеграции через Private Service Connect.

### Недостатки
Критическим недостатком является невозможность разрешения доменных имен, что ломает цепочку доверия TLS в MongoDB Atlas.
Необходимость использования IP-адресов делает конфигурацию хрупкой и зависимой от изменений в инфраструктуре базы данных.
Решение требует отключения проверки SSL или сложной подмены сертификатов, что снижает уровень безопасности.
На текущий момент этот метод создает больше технических проблем для сценария с MongoDB, чем решает.

## Вердикт

Текущая конфигурация с прямым пирингом технически неработоспособна из-за отсутствия DNS-резолвинга в Datastream и нетранзитивности пиринга к PSC.
Диагностированные вами проблемы являются следствием этих архитектурных ограничений платформы, а не ошибками настройки.
Я настоятельно рекомендую выбрать **R⬆₁ (SSH-туннелирование)** в качестве основного решения задачи `T⁎`.
Это единственное решение, которое «из коробки» устраняет проблемы с DNS и маршрутизацией, сохраняя при этом корректную работу TLS и безопасность.
Переход на SSH-туннель через Bastion Host позволит вам немедленно восстановить связность и запустить репликацию данных.