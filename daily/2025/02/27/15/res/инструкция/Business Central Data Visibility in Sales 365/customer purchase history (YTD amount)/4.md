## Пошаговая инструкция: Как сделать «customer purchase history (YTD amount)» из Business Central доступной в Dynamics 365 Sales

На основе требований клиента необходимо обеспечить регулярную передачу данных о покупательной истории клиентов, в частности общей суммы покупок с начала года (YTD amount), из Business Central в Dynamics 365 Sales. Для этого используется Power Automate, что позволяет настроить автоматическое обновление данных на регулярной основе. Ниже приведена инструкция по настройке этого процесса.

---

### Шаг 1: Подготовка пользовательского поля в Dynamics 365 Sales

1. Войти в Dynamics 365 Sales и перейти в раздел «Settings» → «Customizations» → «Customize the System».
2. В открывшемся окне выбрать сущность «Account» в разделе «Entities».
3. Перейти в подраздел «Fields» и нажать «New» для создания нового поля.
4. Указать следующие параметры:
   - «Display Name»: `YTD Amount`.
   - «Name»: `ytd_amount` (автоматически формируется системой).
   - «Data Type»: `Currency` или `Decimal Number` (в зависимости от требований клиента к формату суммы).
5. Сохранить и опубликовать изменения, нажав «Save and Close», затем «Publish All Customizations».
6. Добавить поле `YTD Amount` в форму «Account», открыв «Forms», выбрав основную форму (например, «Account»), перетащив поле из списка доступных полей в нужный раздел формы и сохранив изменения с последующей публикацией.

Этот шаг создаёт место в Dynamics 365 Sales, где будут отображаться данные о YTD amount для каждого клиента.

---

### Шаг 2: Создание подключений в Power Automate

1. Перейти на сайт [Power Automate](https://flow.microsoft.com/) и войти под учетной записью, имеющей доступ к Business Central и Dynamics 365 Sales.
2. В разделе «Data» → «Connections» нажать «New connection».
3. Выбрать коннектор «Business Central» из списка доступных коннекторов.
   - Указать учетные данные для подключения к Business Central (URL среды и данные авторизации).
   - Сохранить подключение.
4. Создать ещё одно подключение, выбрав коннектор «Dynamics 365».
   - Указать учетные данные для подключения к Dynamics 365 Sales.
   - Сохранить подключение.

Эти действия устанавливают необходимые соединения между системами через Power Automate.

---

### Шаг 3: Создание потока в Power Automate для передачи данных

1. В разделе «My flows» нажать «New flow» → «Automated cloud flow».
2. Задать имя потока, например, `Передача YTD Amount из Business Central в Dynamics 365 Sales`.
3. В качестве триггера выбрать «Schedule» из списка триггеров.
   - Настроить параметры запуска, например, «Recurrence» с интервалом в 1 день для ежедневного обновления данных.
4. Добавить действие «Business Central - Get records».
   - Выбрать созданное подключение к Business Central.
   - Указать сущность «Customers» для получения данных о клиентах.
   - Настроить фильтр для получения записей только за текущий год, например, используя параметр `Filter Query` с условием `postingDate ge '2023-01-01'` (заменить год на текущий).
5. Добавить действие «Apply to each» для обработки каждой записи клиента.
   - В поле «Select an output from previous steps» указать выходные данные действия «Get records» (например, `value`).
6. Внутри «Apply to each» добавить действие «Business Central - Get record» для получения детализированных данных о продажах клиента.
   - Указать сущность «Sales Invoice Header» или «Sales Invoice Line».
   - Связать запись с клиентом через поле `Customer No.` из предыдущего шага.
7. Добавить действие «Variables - Initialize variable» для создания переменной `YTDTotal`.
   - Установить «Name»: `YTDTotal`.
   - «Type»: `Float`.
   - «Value»: `0`.
8. Добавить действие «Variables - Increment variable» внутри цикла для суммирования покупок.
   - Указать переменную `YTDTotal`.
   - В поле «Value» вставить сумму из поля `Amount` или `Line Amount` из «Sales Invoice Line», используя динамическое содержимое.
9. После завершения цикла «Apply to each» добавить действие «Dynamics 365 - Update a record».
   - Выбрать подключение к Dynamics 365 Sales.
   - Указать сущность «Accounts».
   - В поле «Record identifier» указать уникальный идентификатор клиента из Business Central (например, `Customer No.`), сопоставленный с полем в Dynamics 365 Sales (например, `Account Number`).
   - В поле `YTD Amount` указать значение переменной `YTDTotal` из предыдущего шага.
10. Сохранить поток, нажав «Save».

Этот поток извлекает данные о покупках из Business Central, вычисляет сумму YTD amount для каждого клиента и обновляет соответствующее поле в Dynamics 365 Sales.

---

### Шаг 4: Настройка расписания для регулярного выполнения

1. Вернуться к триггеру «Schedule» в начале потока.
2. Установить частоту выполнения, например, ежедневно в 2:00 по времени клиента (Chanhassen, США, UTC-6).
3. Сохранить изменения в потоке.

Регулярное выполнение обеспечивает актуальность данных в Dynamics 365 Sales.

---

### Шаг 5: Тестирование и проверка

1. Запустить поток вручную, выбрав «Test» → «Manually» в интерфейсе Power Automate.
2. Проверить в Business Central несколько записей клиентов и убедиться, что сумма покупок с начала года корректно рассчитывается.
3. Открыть соответствующие записи в Dynamics 365 Sales и проверить, что поле `YTD Amount` заполнено правильными значениями.
4. Убедиться, что данные обновляются только для записей с корректным сопоставлением между `Customer No.` (Business Central) и `Account Number` (Dynamics 365 Sales).

Тестирование подтверждает правильность работы потока перед его регулярным использованием.

---

### Дополнительные рекомендации

- Использовать тестовую среду Business Central и Dynamics 365 Sales для первоначальной настройки и тестирования потока.
- Убедиться, что все клиенты из Business Central имеют соответствующие записи в Dynamics 365 Sales с уникальными идентификаторами для корректного сопоставления.
- Периодически проверять выполнение потока в разделе «Run history» в Power Automate для выявления возможных ошибок.
- Документировать настройки потока, включая название, триггер и действия, для упрощения поддержки и изменений в будущем.

---

Эта инструкция позволяет настроить регулярную передачу данных о покупательной истории клиентов (YTD amount) из Business Central в Dynamics 365 Sales с использованием Power Automate, обеспечивая их доступность для отдела продаж в актуальном виде.