# 1. `R.md`
## 1. Анализ доводов в пользу Mᚖ-S (pip-system-certs) `C↯⬆-Mᚖ-S`

### 1.1. Автоматическая инъекция в среду исполнения `C↯⬆-Mᚖ-T`

#### Суть
Пакет `pip-system-certs` использует механизм файлов `.pth` (path configuration files) или `sitecustomize.py`, который позволяет исполнять произвольный код при инициализации интерпретатора Python, еще до запуска основного приложения.
Благодаря этому архитектурному решению, пакет автоматически «патчит» (monkey-patches) стандартную библиотеку `ssl` и популярные HTTP-клиенты (`requests`, `urllib3`), заставляя их использовать системное хранилище сертификатов Windows вместо встроенного `certifi` или OpenSSL.
Для пользователя Azure CLI это означает, что после установки пакета через `pip` не требуется вносить никаких изменений в исходный код самого CLI или его стартовые скрипты.

#### Оценка
95

#### Доводы за
Главным преимуществом является возможность применения исправления к «черному ящику» (скомпилированному или упакованному приложению), каковым является Azure CLI.
Метод работает глобально для всего окружения Python внутри CLI, автоматически исправляя не только ядро CLI, но и все установленные расширения, которые могут использовать свои экземпляры `requests`.

#### Доводы против
Использование файлов `.pth` для исполнения кода при запуске считается небезопасной практикой и может быть заблокировано антивирусным ПО или политиками безопасности в строгих корпоративных средах.
Если Microsoft изменит механизм инициализации Python в будущих версиях CLI (например, перейдет на самодостаточные бинарные сборки через PyOxidizer), этот метод перестанет работать.

### 1.2. Обход строгой валидации OpenSSL через Windows CAPI `C↯⬆-Mᚖ-T`

#### Суть
Современные версии `pip-system-certs` (v24.2+) внутри себя используют библиотеку `truststore`, которая делегирует проверку сертификатов нативным API операционной системы (Windows CryptoAPI / Schannel).
Реализация TLS в Windows (Schannel) исторически более толерантна к нарушениям стандарта RFC 5280 в части расширений `Basic Constraints` и `Key Usage` для сертификатов, которые явно добавлены в доверенные корневые центры.
Таким образом, переключение валидации с OpenSSL (который в Python 3.13 включает флаг `VERIFY_X509_STRICT`) на Windows CAPI позволяет обойти ошибку без необходимости перевыпуска сертификатов на прокси-сервере.

#### Оценка
90

#### Доводы за
Это решение устраняет саму причину сбоя (несовместимость строгости проверки), а не просто подменяет хранилище сертификатов.
Доверие к корпоративному прокси восстанавливается естественным образом, так как используются те же механизмы проверки, что и в браузерах Edge/Chrome, которые у пользователя работают корректно.

#### Доводы против
Существует риск, что будущие обновления безопасности Windows также ужесточат проверку RFC 5280, что приведет к возвращению проблемы.

---

## 2. Анализ доводов в пользу Mᚖ-T (truststore) `C↯⬇-Mᚖ-T`

### 2.1. Официальный статус и надежность архитектуры `C↯⬇-Mᚖ-T`

#### Суть
Библиотека `truststore` является официальным проектом Python Packaging Authority (PyPA) и позиционируется как стандартный способ использования системных хранилищ сертификатов в Python.
В отличие от `pip-system-certs`, она не занимается «хаками» (monkey-patching) глобального пространства имен, а предоставляет адаптер, который разработчик должен явно подключить к своей сессии `requests` или `urllib3`.
Это обеспечивает предсказуемость работы и отсутствие побочных эффектов для других библиотек, работающих в том же интерпретаторе.

#### Оценка
10

#### Доводы за
Использование `truststore` является архитектурно чистым и безопасным решением, рекомендованным сообществом Python для разработки новых приложений.
Библиотека активно поддерживается и тестируется на совместимость с новыми версиями Python и OS.

#### Доводы против
Для использования `truststore` необходимо изменить исходный код приложения, добавив вызов `truststore.inject_into_ssl()` или смонтировав адаптер к сессии.
Пользователь `ꆜ` не является разработчиком Azure CLI и не может (и не должен) править исходные файлы `az` на своей рабочей машине, так как это нарушает целостность подписанного пакета и сбрасывается при обновлении.
В контексте готового продукта (Azure CLI) «чистота архитектуры» становится недостатком, так как делает решение неприменимым без пересборки приложения.

### 2.2. Соответствие стандартам безопасности `C↯⬇-Mᚖ-T`

#### Суть
Поскольку `truststore` также использует системные API, он теоретически решает проблему строгости OpenSSL так же успешно, как и `pip-system-certs`.
Однако, без механизма автоматической инъекции, это преимущество остается недоступным для конечного пользователя утилиты командной строки.

#### Оценка
5

#### Доводы за
Технически библиотека способна решить проблему `CERTIFICATE_VERIFY_FAILED`.

#### Доводы против
Необходимость ручного вмешательства в код `site-packages` Azure CLI для активации `truststore` делает это решение более рискованным и трудоемким, чем `pip-system-certs`.

---

## 3. Итоговый вердикт `R`

### 3.1. Оценка конфликта `C⊥`
В условиях задачи `P†`, где пользователь `ꆜ` должен восстановить работоспособность готового инструмента (Azure CLI) без доступа к его исходному коду и процессу сборки, преимущество безоговорочно принадлежит `Mᚖ-S` (`pip-system-certs`).
Хотя `Mᚖ-T` (`truststore`) является более качественным программным продуктом, он предназначен для **разработчиков ПО**, а не для **конечных пользователей**.
`pip-system-certs` фактически является оберткой над `truststore`, добавляющей критически важную для данного случая функцию автоматической инъекции.

### 3.2. Рекомендация
Я рекомендую использовать решение **`Mᚖ-S`** (установка `pip-system-certs`).
Это единственный способ заставить Azure CLI использовать системное хранилище Windows без модификации файлов самого CLI.

### 3.3. Юридическое обоснование (RFC 5280)
Проблема, решаемая данными методами, вызвана нарушением корпоративным прокси-сервером стандарта **IETF RFC 5280**.
Раздел 4.2.1.9 стандарта гласит:
> «Conforming CAs **MUST** include this extension in all CA certificates that contain public keys used to validate digital signatures on certificates and **MUST** mark the extension as critical in such certificates.»
>
> *Перевод:* «Соответствующие стандарту Удостоверяющие Центры **ОБЯЗАНЫ** включать это расширение во все сертификаты CA, содержащие открытые ключи, используемые для проверки цифровых подписей сертификатов, и **ОБЯЗАНЫ** помечать это расширение как критическое в таких сертификатах.»

Использование `Mᚖ-S` перекладывает ответственность за валидацию этих некорректных сертификатов на Windows, которая (в отличие от Python 3.13) пока допускает данное нарушение для доверенных корней.