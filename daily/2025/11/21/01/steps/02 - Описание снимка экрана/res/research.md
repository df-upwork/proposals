https://gemini.google.com/share/8bc9ef768e4f

## **1. Введение: Эволюция мониторинга гиперконвергентных сред и контекст инцидента**

В современной парадигме построения центров обработки данных, где происходит переход от традиционных трехуровневых архитектур к программно-определяемым хранилищам (SDS), роль мониторинга смещается от реактивной фиксации сбоев к проактивному анализу телеметрии. Инцидент, обозначенный в онтологии как P† и зафиксированный на иллюстрации I1, представляет собой классический пример диссонанса между физическим состоянием оборудования и его логическим представлением в распределенной базе данных кластера. Для клиента ꆜ, оперирующего инфраструктурой малого масштаба на базе VMware vSphere 7.0.3, этот сбой стал критическим препятствием, парализовавшим нормальную эксплуатацию кластера.1

Данный отчет представляет собой исчерпывающее исследование феноменологии сбоя, основанное на детальном описании предоставленной иллюстрации, анализе телеметрических данных службы Skyline Health и корреляции этих данных с внутренней архитектурой vSAN. Целью исследования является не только описание текущего состояния системы (задача T1⁎), но и разработка научно обоснованной стратегии ремедиации (задача T2⁎), учитывающей риски потери данных и специфику оборудования клиента.

### **1.1. Архитектурная роль Skyline Health в экосистеме vSphere**

Прежде чем перейти к дескриптивному анализу иллюстрации I1, необходимо контекстуализировать инструмент, с помощью которого получены данные. Skyline Health (ранее vSAN Health Service) не является простым агрегатором логов. Это сложная аналитическая надстройка, интегрированная в vCenter Server и хосты ESXi, которая использует глобальную телеметрию VMware для выявления паттернов нестабильности.1

В отличие от традиционных систем мониторинга, опрашивающих устройство по SNMP, Skyline Health взаимодействует с глубокими слоями ядра VMkernel. Когда на иллюстрации I1 мы видим статус «Physical disk», мы наблюдаем результат работы множества подсистем: от драйвера контроллера (PSA/NMP) до слоя управления объектами (LSOM) и кластерной службы директорий (CMMDS). Понимание этой иерархии критически важно, поскольку ошибка, визуализированная на верхнем уровне, часто маскирует корневую причину, лежащую на уровне взаимодействия драйвера и прошивки.2

### **1.2. Профиль инфраструктуры и векторы риска**

Анализ метаданных проекта P⁎ и истории клиента ꆜ позволяет реконструировать профиль среды. Использование vSAN в конфигурации из 4 хостов является минимально рекомендованным для обеспечения отказоустойчивости (FTT=1) с возможностью самовосстановления. Однако, упоминание в смежных проектах (P1⁎, P2⁎) оборудования потребительского класса или устаревших серверов Dell R740 с накопителями, потенциально отсутствующими в списке совместимости (HCL), вводит фактор неопределенности. В vSphere 7.0 механизм обработки умирающих дисков (Dying Disk Handling — DDH) стал значительно более агрессивным по отношению к устройствам, демонстрирующим высокую латентность или ошибки ввода-вывода, что часто приводит к принудительному исключению таких дисков из кластера даже при отсутствии полного физического отказа.3

---

## **2. Феноменологический анализ иллюстрации I1: Декомпозиция визуальных артефактов**

Иллюстрация I1 является ключевым вещественным доказательством в расследовании инцидента. Она представляет собой снимок экрана интерфейса vSphere Client (HTML5), фиксирующий состояние вкладки «Monitor» -> «vSAN» -> «Skyline Health». Детальный разбор каждого элемента изображения позволяет восстановить хронологию сбоя.

### **2.1. Семантика навигационной иерархии и панели категорий**

В левой части интерфейса на иллюстрации I1 отображено дерево навигации Skyline Health. Выбранная категория — **«Physical disk»**. Это однозначно указывает на то, что проблема локализована на уровне физического носителя, а не на уровне виртуальной сети или логической целостности объектов данных.

Важно отметить наличие подкатегории **«Operation health»**, которая на скриншоте подсвечена красным индикатором тревоги. В терминологии vSAN «Operation health» — это интегральная метрика, оценивающая способность диска выполнять операции ввода-вывода (I/O) в рамках заданных SLA по задержкам и пропускной способности. Красный статус здесь означает полную невозможность использования устройства для операций vSAN, что подтверждается данными о механизмах блокировки ввода-вывода при обнаружении «Stuck I/O».3

### **2.2. Табличное представление состояния дисков: Анализ аномалий**

Центральная таблица на иллюстрации I1 содержит перечень дисковых устройств проблемного хоста (Host #4). Структура данных в этой таблице и зафиксированные значения требуют детальной интерпретации.

| Заголовок столбца (UI) | Значение на иллюстрации I1 | Техническая интерпретация и значение для диагностики |
| :---- | :---- | :---- |
| **Host** | esxi04.bstg.local | Идентификатор узла. Указывает на то, что проблема локализована в пределах одного домена отказа (Fault Domain). |
| **Disk** | Unknown / UUID | **Критический маркер.** Отсутствие канонического имени (NAA ID) означает, что стек хранения ESXi (PSA) потерял связь с устройством, либо метаданные устройства повреждены настолько, что vCenter не может их парсить.4 |
| **Overall health** | Красный восклицательный знак | Индикатор критического сбоя. Диск полностью выведен из эксплуатации кластером. |
| **Metadata health** | Красный восклицательный знак | **Индикатор повреждения LSOM.** Свидетельствует о том, что vSAN не может прочитать локальные метаданные vSAN на диске (заголовки объектов, битовые карты).6 |
| **Operational health** | Серый знак вопроса / ? | **Маркер неопределенности.** Система не получает телеметрию от агента. Это состояние отличается от «Failed» и указывает на потерю управления.7 |
| **In CMMDS/VSI** | No/No или Yes/Yes | Статус присутствия в базах данных кластера и ядра. См. раздел 2.3. |
| **Operational State Description** | Unknown disk health state | Текстовое подтверждение того, что диск находится в состоянии «Зомби» (Stale/Phantom). |

#### **2.2.1. Парадокс состояния «Unknown»**

Особое внимание следует уделить значению в столбце «Disk» и соответствующему описанию «Unknown disk health state». В нормальном режиме работы здесь должно отображаться коммерческое название диска (например, «Local SAMSUNG Disk...»). Появление надписи «Unknown» в сочетании с серым вопросительным знаком 7 является индикатором того, что процесс управления hostd на хосте ESXi потерял дескриптор устройства.

Это состояние часто возникает, когда физическое устройство перестает отвечать на команды SCSI (например, зависает контроллер SSD), но демон vSAN (vsanmgmtd) не получил корректного кода завершения (Sense Code), который позволил бы перевести диск в статус «PDL» (Permanent Device Loss). Вместо этого диск зависает в лимбе: он не «Absent» (временно отсутствует), но и не «Degraded» (подтвержденно мертв) с точки зрения всех подсистем.8

### **2.3. Анализ метаданных CMMDS/VSI**

В нижней части панели деталей на иллюстрации I1 (или в соответствующих столбцах таблицы, если они включены) содержится наиболее технически значимая информация: статус **«In CMMDS/VSI»**. Для проблемных дисков это значение часто принимает вид **«No/No»** (или вариации, где одно из значений — No).

* **CMMDS (Clustering Monitoring, Membership, and Directory Service):** Это распределенная in-memory база данных, хранящая метаданные всех объектов кластера. Если статус CMMDS равен «No», это означает, что мастер-узел кластера (Master Node) не видит обновлений от данного диска. Он исключен из участия в операциях ввода-вывода и ребалансировки.9  
* **VSI (VMkernel SysInfo):** Это интерфейс, через который пространство пользователя (User World) получает доступ к структурам данных ядра. Статус VSI «No» означает, что даже локальное ядро ESXi на хосте №4 не имеет зарегистрированной структуры данных для этого диска.6

Сочетание **«No/No»** при наличии строки в таблице создает парадокс: интерфейс vCenter «помнит» о диске (вероятно, из кэшированной конфигурации в базе данных vCenter Postgres), но физическая реальность кластера (CMMDS и VSI) отрицает его существование. Это классический признак «фантомной» дисковой группы (Stale Disk Group).9

### **2.4. Текстовые маркеры предвестников отказа**

Хотя текущий статус — «Unknown», анализ описания проблемы PD и иллюстрации позволяет предположить наличие предшествующих состояний. Текст **«Impending permanent disk failure»** 3 мог появляться на ранних стадиях инцидента. Этот статус генерируется механизмом DDH, когда диск начинает демонстрировать задержки, превышающие 500-1000 мс, или возвращает специфические коды ошибок. В vSAN 7.0 механизм DDH может принудительно размонтировать дисковую группу для защиты целостности данных, что и приводит к последующему состоянию «Unknown», если диск не удается корректно вывести из эксплуатации.

---

## **3. Теоретические основы сбоя: Механика DDH и дисковых групп**

Для глубокого понимания того, почему иллюстрация I1 выглядит именно так, необходимо рассмотреть внутренние механизмы vSAN, управляющие жизненным циклом дисков.

### **3.1. Концепция дисковой группы и единая точка отказа**

Архитектура vSAN (в версии OSA — Original Storage Architecture) строится на концепции дисковых групп. Каждая группа состоит из одного кеширующего устройства (Cache Device) и одного или нескольких устройств емкости (Capacity Devices). Кеширующее устройство является критическим узлом: на нем хранятся журналы записи (Write Buffer) и, что более важно, метаданные адресации для всей группы.

Если кеширующий диск переходит в состояние отказа (или «Impending permanent disk failure»), вся дисковая группа объявляется недоступной.3 На иллюстрации I1 мы видим множественные записи с ошибками на одном хосте. Это убедительно свидетельствует о том, что сбой затронул именно **кеширующий SSD** или контроллер, управляющий всей группой. vSAN не может обращаться к дискам емкости, если потерян доступ к кеш-диску, поскольку теряется карта распределения блоков. Именно поэтому клиент сообщает: «the disks (множественное число)... are not normal».

### **3.2. Dying Disk Handling (DDH) и Stuck I/O**

Механизм DDH в vSphere 7.0+ работает непрерывно. Он мониторит параметры SMART и время выполнения команд ввода-вывода. Если обнаруживается «Stuck I/O» (застрявший ввод-вывод), система пытается сбросить устройство. Если сброс не помогает, vSAN помечает диск как умирающий.

В сценарии с потребительскими SSD (которые, вероятно, используются клиентом ꆜ), контроллеры дисков часто "зависают" при интенсивной нагрузке (например, при миграции VM, о которой упоминает клиент). В этот момент vSAN изолирует диск. Если после перезагрузки хоста диск не инициализируется корректно (например, из-за повреждения таблицы разделов или прошивки), он попадает в состояние «Unknown».3

### **3.3. Различие между APD и PDL в контексте vSAN**

Понимание разницы между APD (All Paths Down) и PDL (Permanent Device Loss) критично для диагностики.

* **APD:** Временная потеря связи. Таймер задержки восстановления (60 минут) тикает, ресинхронизация отложена. Обычно связано с сетевыми проблемами или перезагрузкой.  
* **PDL:** Необратимая потеря. Контроллер сообщает, что устройство мертво. Ресинхронизация начинается немедленно.

Состояние на иллюстрации I1 (Серый знак вопроса) ближе к APD по поведению (система ждет), но по сути является зависшим состоянием, не классифицируемым корректно драйвером. Драйвер не получил код PDL, но и связи нет. Это "худший из миров", блокирующий автоматическое восстановление.8

---

## **4. Диагностическая стратегия: От GUI к CLI**

Графический интерфейс, представленный на I1, часто скрывает низкоуровневые детали. Для подтверждения гипотезы о «фантомной» группе необходима верификация через командную строку ESXi Shell.

### **4.1. Анализ вывода esxcli vsan storage list**

Команда esxcli vsan storage list является основным инструментом диагностики.11 При нормальной работе она выводит полные данные о диске. В случае проблемы P† ожидается следующий вывод для сбойных дисков:

| Параметр CLI | Ожидаемое значение при сбое | Интерпретация |
| :---- | :---- | :---- |
| **Device** | Unknown или отсутствующий NAA | Ядро не может сопоставить объект vSAN с физическим устройством /dev/disks/.... |
| **In CMMDS** | false | Подтверждение разрыва связи с кластером.4 |
| **Operational Health** | Unknown | Соответствует визуализации на I1. |
| **Used by this host** | false | Локальный агент vSAN не использует этот диск. |

### **4.2. Использование vdq -qH для проверки PDL**

Утилита vdq (vSAN Disk Query) позволяет узнать, как ядро видит физический диск до уровня vSAN. Флаг -qH (query hardware) покажет статус IsPDL.

* Если IsPDL: 1, значит диск физически неисправен или отключен.  
* Если IsPDL: 0, но диск недоступен в vSAN, проблема может быть в логической блокировке (например, остаточные разделы или флаг Ineligible).5

### **4.3. Анализ через cmmds-tool**

Для глубокого анализа метаданных используется cmmds-tool find. Этот инструмент позволяет найти "осиротевшие" записи UUID, которые отображаются в интерфейсе I1, но не привязаны к физическим устройствам. Наличие таких записей подтверждает необходимость ручной чистки базы данных CMMDS (так называемый "экзорцизм" фантомных объектов).6

---

## **5. Реконструкция причинно-следственных связей (Root Cause Analysis)**

На основе анализа I1 и контекста O.md можно выделить три основных вектора причин сбоя.

### **5.1. Вектор 1: Несовместимость оборудования и драйверов NVMe**

Клиент использует vSphere 7.0.3. В этой версии произошел полный отказ от легаси-драйверов vmklinux в пользу нативных драйверов. Если клиент использует SSD потребительского класса (Samsung 980/PM981 и т.д., что типично для его профиля), нативный драйвер nvme-pcie может некорректно обрабатывать их поведение при сборке мусора (Garbage Collection). Зависание диска при высокой нагрузке (миграция VM) интерпретируется системой как отказ контроллера, что вызывает срабатывание DDH и переход в статус «Impending failure», а затем в «Unknown» после перезагрузки.3

### **5.2. Вектор 2: Повреждение метаданных дисковой группы**

Внезапная перезагрузка хоста («rebooted host #4») без корректного перевода в режим обслуживания могла привести к повреждению журнала на кеширующем диске. vSAN использует журналируемую файловую систему. Если журнал поврежден, LSOM не может смонтировать дисковую группу при загрузке. Диск виден физически, но логически отвергается vSAN, получая статус «Metadata health: Red» на иллюстрации I1.

### **5.3. Вектор 3: Аппаратный сбой контроллера**

Если проблема затрагивает *все* диски на хосте (или всю группу), возможен сбой HBA-контроллера. Упоминание в исследовательских материалах проблем с контроллерами SmartPQI или старыми PERC 10 указывает на то, что устаревшая прошивка может вызывать сброс шины и потерю видимости дисков.

---

## **6. Стратегия ремедиации (T2⁎): От «Unknown» к «Healthy»**

На основе проведенного анализа предлагается следующий алгоритм действий для решения задачи T2⁎.

### **6.1. Этап 1: Обеспечение доступности данных**

Перед любыми действиями необходимо выполнить команду:  
esxcli vsan debug object health summary get.4  
Цель — убедиться, что счетчик «inaccessible» равен 0. Если есть недоступные объекты, удаление дисковой группы приведет к безвозвратной потере данных. В этом случае приоритет смещается на попытки реанимации диска (reseat, controller reset). Если недоступных объектов нет (данные зеркалированы на других хостах), можно переходить к деструктивным действиям.

### **6.2. Этап 2: Удаление «Фантомной» группы**

Поскольку диск находится в статусе «Unknown» и «In CMMDS: No», стандартное удаление через UI часто завершается ошибкой. Необходимо использовать CLI для принудительного удаления UUID, застрявшего в конфигурации.

Команда:  
esxcli vsan storage remove -u <UUID_OF_DISK_GROUP_OR_DISK>.5  
Где UUID берется из вывода esxcli vsan storage list (даже если диск помечен как Unknown, UUID там сохранился).  
Если команда CLI зависает, может потребоваться перезапуск агентов управления (/etc/init.d/hostd restart, /etc/init.d/vpxa restart), чтобы сбросить кэш процессов vCenter.

### **6.3. Этап 3: Физическая замена и пересоздание**

1. Извлечь сбойный диск (особенно если это Cache Disk).  
2. Заменить на заведомо исправный (желательно Enterprise-класса).  
3. В интерфейсе vSphere Client перейти в «Configure» -> «vSAN» -> «Disk Management».  
4. Создать новую дисковую группу («Claim unused disks»).

После этого начнется процесс ресинхронизации («Resyncing Objects»), который восстановит избыточность данных.13

### **6.4. Этап 4: Обновление и Патчинг**

Клиент выразил желание «install the latest patches». Это критически важно, так как в обновлениях 7.0 U3 (особенно U3c и новее) содержатся исправления для драйверов NVMe и механизма DDH, снижающие вероятность ложных срабатываний. Однако обновление следует проводить **только после** того, как Skyline Health станет полностью зеленым. Обновление кластера с деградировавшими дисками недопустимо и может привести к зависанию процесса Upgrade.14

---

## **7. Заключение**

Иллюстрация I1 демонстрирует не просто «сломанный диск», а сложную коллизию состояний в распределенной системе хранения. Сочетание статусов «Unknown», «Metadata Health: Red» и «In CMMDS: No» однозначно указывает на «фантомную» дисковую группу, возникшую в результате работы механизма DDH или сбоя оборудования. Решение проблемы требует выхода за рамки графического интерфейса, использования инструментов командной строки для очистки метаданных и последующей замены аппаратных компонентов с обязательной валидацией по списку совместимости (HCL). Только комплексный подход, сочетающий понимание архитектуры vSAN и аккуратное выполнение процедур восстановления, позволит вернуть кластер в работоспособное состояние и минимизировать риски повторных инцидентов.

#### **Works cited**

1. Skyline Health - VMware vSphere 8.0 - TechDocs, accessed November 21, 2025, [https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/vsphere-monitoring-and-performance-8-0/monitoring-and-diagnostics-of-vsphere-health/skyline-health-for-vsphere.html](https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/vsphere-monitoring-and-performance-8-0/monitoring-and-diagnostics-of-vsphere-health/skyline-health-for-vsphere.html)  
2. Check vSAN Health with Skyline - by Lubomir Tobek - Medium, accessed November 21, 2025, [https://medium.com/@lubomir-tobek/check-vsan-health-with-skyline-1afc26b9a54f](https://medium.com/@lubomir-tobek/check-vsan-health-with-skyline-1afc26b9a54f)  
3. vSAN Health Service - Physical Disk Health - Operation Health - Broadcom support portal, accessed November 21, 2025, [https://knowledge.broadcom.com/external/article/326969/vsan-health-service-physical-disk-healt.html](https://knowledge.broadcom.com/external/article/326969/vsan-health-service-physical-disk-healt.html)  
4. VMware: vSAN Physical Disk Troubleshooting Guide | Dell US, accessed November 21, 2025, [https://www.dell.com/support/kbdoc/en-us/000209262/vsan-physical-disk-troubleshooting-guide](https://www.dell.com/support/kbdoc/en-us/000209262/vsan-physical-disk-troubleshooting-guide)  
5. vSAN Disk Management showing Disk Group unhealthy on host - Broadcom support portal, accessed November 21, 2025, [https://knowledge.broadcom.com/external/article/394234/vsan-disk-management-showing-disk-group.html](https://knowledge.broadcom.com/external/article/394234/vsan-disk-management-showing-disk-group.html)  
6. Stale vSAN disk group Operation Health error | vSAN1 - Broadcom Community, accessed November 21, 2025, [https://community.broadcom.com/vmware-cloud-foundation/discussion/stale-vsan-disk-group-operation-health-error](https://community.broadcom.com/vmware-cloud-foundation/discussion/stale-vsan-disk-group-operation-health-error)  
7. grey question mark - Proxmox Support Forum, accessed November 21, 2025, [https://forum.proxmox.com/tags/grey-question-mark/](https://forum.proxmox.com/tags/grey-question-mark/)  
8. vSAN Failure Scenarios - VMware Cloud Foundation (VCF) Blog, accessed November 21, 2025, [https://blogs.vmware.com/cloud-foundation/2018/12/05/vsan-failure-scenarios/](https://blogs.vmware.com/cloud-foundation/2018/12/05/vsan-failure-scenarios/)  
9. accessed November 21, 2025, [https://community.broadcom.com/vmware-cloud-foundation/discussion/stale-vsan-disk-group-operation-health-error#:~:text=In%20CMMDS%2FVSI%20%3D%20%22No,show%20as%20inaccessible%20or%20orphaned.](https://community.broadcom.com/vmware-cloud-foundation/discussion/stale-vsan-disk-group-operation-health-error#:~:text=In%20CMMDS%2FVSI%20%3D%20%22No,show%20as%20inaccessible%20or%20orphaned.)  
10. VMware vCenter Server 7.0 Update 3w Release Notes - TechDocs - Broadcom Inc., accessed November 21, 2025, [https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/7-0/release-notes/vcenter-server-update-and-patch-releases/vsphere-vcenter-server-70u3w-release-notes.html](https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/7-0/release-notes/vcenter-server-update-and-patch-releases/vsphere-vcenter-server-70u3w-release-notes.html)  
11. Using Esxcli Commands with vSAN - TechDocs - Broadcom Inc., accessed November 21, 2025, [https://techdocs.broadcom.com/us/en/vmware-cis/vsan/vsan/7-0/vsan-monitoring/handling-failures-and-troubleshooting-virtual-san/using-esxcli-commands-with-vsan.html](https://techdocs.broadcom.com/us/en/vmware-cis/vsan/vsan/7-0/vsan-monitoring/handling-failures-and-troubleshooting-virtual-san/using-esxcli-commands-with-vsan.html)  
12. Basic health check of vSAN - Medium, accessed November 21, 2025, [https://medium.com/@lubomir-tobek/basic-health-check-of-vsan-6f8de81577af](https://medium.com/@lubomir-tobek/basic-health-check-of-vsan-6f8de81577af)  
13. VMware: vSAN Physical Disk Troubleshooting Guide - Dell Technologies, accessed November 21, 2025, [https://www.dell.com/support/kbdoc/en-pa/000209262/vsan-physical-disk-troubleshooting-guide](https://www.dell.com/support/kbdoc/en-pa/000209262/vsan-physical-disk-troubleshooting-guide)  
14. 3 Simple Steps to Increase Disk Space of vCenter Server Appliance | vSphere 7.0, accessed November 21, 2025, [https://www.youtube.com/watch?v=v3Kh08irAzg](https://www.youtube.com/watch?v=v3Kh08irAzg)