1) Проблема №1, описанная как «нелинейная» логика сворачивания (roll-up) отчета о прибылях и убытках (P&L) в Sage Intacct, не является результатом работы непрозрачного или непредсказуемого механизма. Напротив, ее источник — в мощной и гибкой, полностью конфигурируемой пользователем системе финансовой отчетности. 
Расчет итогового показателя, такого как «Чистая прибыль» (Net Income), является конечным узлом в направленном ациклическом графе (DAG) вычислений. 
Например, «Чистая прибыль» зависит от «Валовой прибыли» и «Операционных расходов»; в свою очередь, «Операционные расходы» зависят от суммы «Административных расходов» и «Расходов на продажи». 
Эта древовидная структура зависимостей требует специальных подходов к обработке, таких как рекурсия, что и создает иллюзию «нелинейности».
2) Сложные структуры отчетов в Sage Intacct сначала проектируются в Excel и лишь затем реализуются в системе. 
Это означает, что логика системы является прямым отражением бизнес-правил, установленных людьми. Следовательно, главным препятствием является не техническая неизвестность, а необходимость формализовать и задокументировать эти бизнес-процессы.
3) Правильное решение проблемы №1 должно быть основано на динамическом подходе, управляемом метаданными, а не на жестком кодировании одного конкретного отчета. 
Это обеспечит устойчивость решения к изменениям, которые финансовые пользователи могут вносить в структуру отчетов Sage Intacct.
4) Метрика «technician sales» является неоднозначной, поскольку не представляет собой единое поле в базе данных. 
Это расчетный показатель (KPI), который формируется в результате сложного взаимодействия множества базовых сущностей (сметы, счета-фактуры), бизнес-правил (процентное распределение между техниками, пороги продаж для типов работ) и контекста (принципиальное различие между понятиями «Продажи» и «Выручка»). 
Коренная причина проблемы №2 заключается в отсутствии предопределенной формулы; для репликации требуется не просто извлечь значение, а воссоздать саму логику расчета.
5) Правильный способ решения проблемы №1:
5.1) С помощью метода `query` для объекта `GLACCOUNTGROUP` через API Sage Intacct необходимо извлечь полную информацию о всех Account Groups.
Результат должен содержать `id`, `title`, `groupType`, ее состав (список счетов или других групп) и параметры вычислений.
5.2) Необходимо получить все детализированные проводки (`GLDETAIL`) за требуемый отчетный период.
Наиболее надежный способ — использовать экспорт данных из специально созданного кастомного отчета в Sage Intacct, который будет содержать все необходимые поля.
Альтернативно, можно использовать API для прямого запроса данных, но это может быть менее эффективно для больших объемов.
5.3) Необходимо получить список всех используемых измерений и их значений, чтобы в дальнейшем можно было применять фильтры.
5.4) В целевой базе данных создается модель, описывающая структуру отчета:
5.4.1) Создание таблицы метаданных `dim_account_groups`. 
Эта таблица будет хранить всю информацию о группах счетов: их ID, название, тип, формулу вычисления (если применимо), нормальный баланс и т.д.
5.4.2) Создание связующей таблицы `bridge_account_group_hierarchy`. 
Это ключевой элемент для работы с иерархиями. 
Таблица будет иметь простую структуру, например, (`parent_group_id`, `child_group_id`, `order`), и описывать древовидные связи между группами счетов. 
Такая структура идеально подходит для обработки с помощью рекурсивных запросов.
5.5) Сборка отчета:
5.5.1) С помощью рекурсивного SQL-запроса (например, с использованием Recursive Common Table Expression или CTE) необходимо «пройти» по иерархии, определенной в `bridge_account_group_hierarchy`.
На самом нижнем уровне (где дочерними элементами являются счета GL) происходит суммирование транзакций из таблицы `GLDETAIL`. 
Затем результаты поднимаются вверх по иерархии, агрегируясь на каждом уровне.
5.5.2) Внутри агрегирующей функции (например, `SUM()`) необходимо применять условие, которое умножает сумму на 1 или -1 в зависимости от нормального баланса счета/группы, чтобы корректно учитывать доходы и расходы.
5.5.3) Логику для групп типа `Computation` следует применять как отдельный шаг после базовой агрегации. 
На этом шаге к уже рассчитанным итогам по группам применяются математические формулы, хранящиеся в таблице метаданных `dim_account_groups`.
6) Правильный способ решения проблемы №2:
6.1) Первым и самым важным шагом является понимание фундаментального различия между «Продажами» и «Выручкой» в терминологии ServiceTitan. 
Эти понятия часто путают, но они отражают разные этапы бизнес-процесса и рассчитываются на основе разных исходных данных.
Критическое различие заключается во времени признания: смета может быть продана в январе (попадая в отчет по продажам за январь), а работа по ней может быть выполнена и закрыта счетом только в феврале (попадая в отчет по выручке за февраль). 
Таким образом, для точной репликации необходимо извлекать и обрабатывать данные как из смет, так и из счетов, и никогда не использовать эти показатели взаимозаменяемо.
6.2) Проблема №2 — это, по своей сути, задача моделирования данных и ETL/ELT-логики. 
Исходные данные существуют, но «инсайт» (конечный KPI) создается на этапе преобразования.
ServiceTitan предлагает множество встроенных KPI, например:
- «Total Sales»
- «Completed Revenue»
- «Actual Revenue (per technician)»
- «Sales $ (per technician)»
Их значения могут кардинально меняться в зависимости от ряда контекстуальных настроек в ServiceTitan.
Для точной репликации необходимо извлекать и учитывать следующие модификаторы:
- «Technician Splits»
- «Sold Threshold»
- «Business Units»
- «Job Types & Tags»
6.3) Решение Проблемы №2 требует систематического подхода к извлечению всех необходимых компонентов и их последующей сборке в соответствии с бизнес-логикой:
6.3.1) Извлечение всех необходимых данных (например, посредством Transactional API)
6.3.2) Все данные, извлеченные из API, должны быть сначала загружены в «сыром» виде в промежуточные таблицы (staging area) в целевой платформе данных. 
6.3.3) Реализация бизнес-логики и расчетных представлений (Views)
