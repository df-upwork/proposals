https://gemini.google.com/share/1238ab0d795a

## `Aᚖ₁`: SSH-туннелирование (Bastion Host)

### Суть
Данный архитектурный паттерн предполагает использование встроенного в Datastream механизма «Forward SSH tunnel» для инкапсуляции трафика репликации внутрь защищенного соединения.
В качестве точки входа в сеть клиента (`datastream-net`) используется простая виртуальная машина (Bastion Host), доступная по приватному IP-адресу через Private Service Access (PSA).
Сервис Datastream устанавливает SSH-сессию с этим бастионом и запрашивает перенаправление TCP-трафика на доменное имя кластера MongoDB Atlas.
SSH-демон, запущенный на бастионе, выполняет разрешение DNS-имени Atlas, используя локальный резолвер VPC, который имеет доступ к Private DNS Zone и возвращает корректные IP-адреса Private Service Connect (PSC).
После разрешения адреса бастион устанавливает соединение с конечной точкой PSC и транслирует зашифрованный поток данных между Datastream и базой данных.
Такая схема позволяет Datastream обращаться к целевому хосту по имени, что критически важно для корректной валидации TLS-сертификатов MongoDB.

### Оценка
95

### Достоинства
Это решение является нативным для Google Cloud Datastream и официально рекомендуется для сценариев со сложной сетевой топологией.
Архитектура автоматически устраняет проблему `P2†` (DNS Split-Horizon), так как резолвинг имен выполняется внутри периметра VPC, где настроена приватная зона.
Полностью решается проблема `P1†` (Public IP), поскольку бастион направляет трафик строго на приватные IP-адреса PSC Endpoint.
Метод обходит ограничение нетранзитивности VPC Peering, так как соединение терминируется на бастионе и пересоздается внутри целевой сети.
Использование доменных имен при подключении гарантирует успешное прохождение TLS Handshake без ошибок «Hostname Mismatch».
Конфигурация на стороне пользователя минимальна и сводится к развертыванию одной VM с публичным ключом Datastream.

### Недостатки
Инкапсуляция протокола базы данных внутрь SSH (TCP-over-TCP) создает дополнительные накладные расходы на процессор и снижает эффективную пропускную способность (MTU).
В сценариях с экстремально высокой нагрузкой (High Throughput CDC) производительность одного SSH-туннеля может стать узким местом («bottle neck»).
Бастион-хост становится единой точкой отказа (SPOF), что требует настройки механизмов автовосстановления (Managed Instance Group) для обеспечения надежности.

## `Aᚖ₂`: Промежуточный L4 TCP-прокси (Proxy VM)

### Суть
Этот подход подразумевает развертывание в сети клиента (`datastream-net`) выделенной виртуальной машины с программным обеспечением для балансировки нагрузки (Nginx или HAProxy).
Datastream подключается к приватному IP-адресу этой прокси-машины через VPC Peering, используя строку подключения MongoDB с параметром `directConnection=true`.
Прокси-сервер принимает входящие TCP-пакеты на порт 27017, разрешает имя назначения MongoDB Atlas через системный DNS и пересылает трафик на PSC Endpoint.
Для обеспечения работоспособности прокси настраивается в режиме `stream` (Layer 4), прозрачно передавая зашифрованный трафик без терминации SSL.
Драйвер Datastream настраивается принудительно на работу с одним узлом, чтобы избежать попыток автоматического обнаружения топологии кластера и ухода с прокси.

### Оценка
80

### Достоинства
Проксирование на транспортном уровне (L4) обеспечивает высокую производительность и минимальные задержки, превосходя SSH-туннелирование.
Решение предоставляет администраторам полный контроль над параметрами сетевого стека, включая настройки `keepalive`, таймауты и буферы.
Отсутствует двойное шифрование данных, что снижает нагрузку на CPU прокси-сервера по сравнению с SSH-шлюзом.
Архитектура позволяет легко масштабироваться горизонтально, размещая прокси-серверы за внутренним балансировщиком нагрузки (Internal Load Balancer).

### Недостатки
Фундаментальной проблемой является несоответствие имени хоста в TLS-сертификате: Datastream подключается к IP прокси, а получает сертификат для домена `*.mongodb.net`.
Для устранения ошибки валидации сертификата требуется либо отключение проверки подлинности (что небезопасно), либо сложная настройка перешифрования (SSL Re-encryption) с управлением собственным CA.
Внедрение требует глубокой экспертизы в администрировании Nginx/HAProxy и усложняет эксплуатацию инфраструктуры.
Необходимость использования флага `directConnection` ограничивает возможности драйвера по автоматическому переключению (Failover) при сбоях узлов базы данных.

## `Aᚖ₃`: Подключение через публичный интернет (Public Access List)

### Суть
Данный альтернативный сценарий предполагает отказ от использования приватных каналов связи (Private Service Connect и Peering) в пользу публичной маршрутизации.
В настройках сетевого доступа MongoDB Atlas (Network Access) создается правило, разрешающее входящие соединения с публичных статических IP-адресов сервиса Datastream.
Трафик данных передается через публичный интернет, но защищается обязательным шифрованием TLS на уровне протокола MongoDB.
В профиле подключения Datastream используется стандартный метод «Public connectivity» и публичное доменное имя кластера.

### Оценка
30

### Достоинства
Это технически простейшее решение, не требующее настройки DNS, виртуальных машин, пиринга или прокси-серверов.
Полностью исключаются все проблемы, связанные с транзитивной маршрутизацией, Split-Horizon DNS и приватными зонами.
Отсутствуют дополнительные расходы на инфраструктуру Google Cloud (Compute Engine, Network Traffic).

### Недостатки
Решение грубо нарушает исходное требование задачи `T༄` об исключении прохождения трафика через публичный интернет («avoid public internet traversal»).
Использование публичных сетей увеличивает поверхность атаки и может противоречить корпоративным политикам безопасности (Compliance).
Публичные IP-адреса Datastream могут изменяться, что создает необходимость постоянного обслуживания списков доступа (Maintenance Overhead).
Сетевые задержки и стабильность канала через публичный интернет менее предсказуемы по сравнению с выделенным интерконнектом.

## Итоговый вердикт

Исходный план `T༄` технически нереализуем в текущей конфигурации из-за документированных ограничений Google Cloud Platform.
Главные препятствия — это отсутствие DNS-резолвинга в приватных соединениях Datastream и нетранзитивность пиринга для Private Service Connect.
Я рекомендую использовать решение **`Aᚖ₁` (SSH-туннелирование)** в качестве основного и наиболее надежного способа выполнения задачи `T⁎`.
Этот метод получил наивысшую оценку (95), так как он «из коробки» решает проблемы маршрутизации и DNS, корректно обрабатывает TLS-сертификаты и официально поддерживается вендором.
Решение `Aᚖ₂` (Proxy VM) следует рассматривать только в том случае, если производительность SSH-туннеля окажется недостаточной и у команды есть экспертиза для решения проблем с подменой SSL-сертификатов.
Вам необходимо развернуть Bastion Host в сети `datastream-net` и перенастроить профиль соединения Datastream на использование метода «Forward SSH tunnel».