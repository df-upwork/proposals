Ниже описана пошаговая инструкция на русском языке (с сохранением официальных названий продуктов на английском языке) по организации регулярной передачи истории покупок (YTD amount) из Business Central в Dynamics 365 Sales при помощи Power Automate. Данный подход обеспечивает доступ к актуальным данным о годовом объеме покупок клиента (Customer Purchase History) непосредственно в Dynamics 365 Sales.

1) Подготовка данных в Business Central

1.1) Определить, откуда брать YTD amount в Business Central.  
Чаще всего эта информация находится в таблицах, где хранятся продажи по клиенту (например, «Customer Ledger Entries»), или в отчетах, суммирующих продажи за текущий год.  
1.2) Убедиться, что существует единый способ расчета YTD amount, отражающий фактический объем покупок клиента с начала года. В случае необходимости настроить константы (например, начало отчетного года), чтобы данные были точными и согласованными.  

2) Создание поля в Dynamics 365 Sales

2.1) В Dynamics 365 Sales открыть «Settings» → «Advanced Settings» → «Customizations» → «Customize the System».  
2.2) В списке сущностей найти «Account» или «Contact» или иную сущность, связанную с клиентами.  
2.3) Создать новое поле для хранения YTD amount, например «YTD Purchase Amount». Выбрать соответствующий тип, как правило «Currency» или «Decimal Number».  
2.4) Сохранить изменения и при необходимости добавить это поле в форму (Form) сущности, чтобы видеть и редактировать значение в интерфейсе Dynamics 365 Sales.  

3) Настройка связи Power Automate с Business Central

3.1) В Microsoft Power Automate (через портал make.powerautomate.com) создать новый поток, выбрав вариант «Scheduled cloud flow», если предполагается регулярное обновление (например, раз в день или раз в час).  
3.2) Настроить запуск (Trigger) с требуемым расписанием, чтобы поток автоматически запускался согласно выбранному интервалу.  
3.3) Добавить действие «List records» или «List rows» (в зависимости от названия коннектора и методов) для Business Central.  
В разделе «Connection» указать учетные данные, обеспечивающие доступ к нужному окружению Business Central, и выбрать таблицу или объект, где хранится итоговый YTD amount (либо откуда можно вычислить сумму продаж).  

4) Вычисление или получение YTD amount в Power Automate

4.1) В случае, если YTD amount не хранится в одном поле таблицы, создать в Power Automate дополнительное действие (например, «Filter array» или «Select») для суммирования исторических записей.  
4.2) Отфильтровать записи по клиенту и периоду (с начала отчетного года до текущей даты), после чего рассчитать сумму по полю, отражающему сумму продаж.  
4.3) Сохранить результат вычисления YTD amount в переменную внутри Power Automate, чтобы затем использовать ее при обновлении данных в Dynamics 365 Sales.  

5) Обновление записей в Dynamics 365 Sales

5.1) Добавить действие «List rows» (или «List records») для сущности «Account» или «Contact» (или иной) в Dynamics 365 Sales, чтобы найти записи, которым необходимо присвоить полученное YTD amount.  
5.2) Сопоставить записи Business Central и записи Dynamics 365 Sales по ключу (например, «Customer No.» из Business Central должен соответствовать полю «Account Number» в Dynamics 365 Sales).  
5.3) Для каждой найденной пары записей добавить действие «Update a row» («Update a record») в Power Automate, где в поле «YTD Purchase Amount» указать рассчитанное в шаге 4.2 значение.  

6) Тестирование и запуск потока

6.1) Перед полноценным запуском выполнить тестовый прогон потока с ограниченным набором клиентов.  
6.2) Проверить, что поле «YTD Purchase Amount» в Dynamics 365 Sales заполнилось корректно и совпадает с данными Business Central.  
6.3) Если результат соответствует ожиданиям, активировать поток (кнопка «Turn on flow»), чтобы он запускался по заданному расписанию (например, ежедневно в 3:00).  

7) Поддержка и мониторинг

7.1) Проверять логи выполнения потока (раздел «My flows» → «Run History») на предмет ошибок. При наличии ошибок – анализировать данные подключения, формат и сопоставление полей.  
7.2) При изменении структуры данных или нового определения YTD amount в Business Central (например, переход на другой календарный год) корректировать логику потока в Power Automate.  
7.3) При необходимости добавлять условия для выбора только активных клиентов, исключать тестовые учетные записи и так далее.  

8) Дополнительные рекомендации

8.1) При большом объеме данных (тысячи или десятки тысяч клиентов) использовать фильтрацию и постраничную обработку (pagination), чтобы не превысить лимиты Power Automate.  
8.2) Рассмотреть возможность двусторонней интеграции, если требуется передавать обратно в Business Central какую-либо информацию о клиентах из Dynamics 365 Sales.  
8.3) Документировать все поля, фильтры, действия и расписание, чтобы в будущем легко обновлять поток при смене бизнес-требований.  

Таким образом достигается автоматизированная регулярная передача информации о годовых покупках (YTD amount) из Business Central в Dynamics 365 Sales. Менеджеры по продажам получают актуальный объем покупок клиента в реальном времени (с учетом расписания обновлений), что обеспечивает лучшее понимание истории взаимоотношений с клиентами и позволяет оперативно реагировать на их потребности.