## Mᚖ₁: Откат к предыдущему файлу состояния индекса

### Суть
Elasticsearch сохраняет несколько версий файлов состояния индекса (например, `state-21.st`, `state-22.st`).
Ошибка "file truncated" указывает, что запись файла `state-22.st` была прервана.
Существует вероятность, что предыдущая версия (`state-21.st`) не повреждена.
Метод заключается в остановке службы, ручном перемещении поврежденного файла `state-22.st` из каталога `...\_state\` и перезапуске службы.
Предполагается, что Elasticsearch автоматически попытается загрузить предыдущий доступный файл состояния.

### Оценка (§2.3)
60/100

### Достоинства (§2.2.2)
В случае успеха это самый быстрый способ восстановления работоспособности индекса.
Потеря данных будет минимальной (только изменения метаданных, которые записывались в `state-22.st`).
Вмешательство менее инвазивно, чем полное удаление индекса.

### Недостатки (§2.2.1)
Это рискованная и официально не поддерживаемая процедура.
Нет гарантии, что Elasticsearch 6.3.0 корректно обработает отсутствие последнего файла состояния и успешно выполнит откат.
Предыдущий файл состояния также может быть поврежден или отсутствовать.

## Mᚖ₂: Карантин всего каталога поврежденного индекса

### Суть
Этот метод заключается в ручном перемещении всего каталога, соответствующего поврежденному индексу, за пределы пути данных Elasticsearch.
Необходимо остановить службу, идентифицировать каталог по UUID `y4rIWp3MQG2cdeKZNvxBRA` в `D:\Elastic\Elasticsearch\data\nodes\0\indices\` и переместить его в безопасное место.
Удаление источника повреждения позволит узлу Elasticsearch успешно инициализироваться, игнорируя этот индекс.

### Оценка (§2.3)
95/100

### Достоинства (§2.2.2)
Это самый надежный способ гарантировать запуск службы Elasticsearch при фатальном повреждении метаданных индекса.
Метод позволяет быстро восстановить доступ к другим неповрежденным индексам.
Он напрямую соответствует главному требованию клиента: обеспечить запуск и стабильную работу Elasticsearch (`O.md`::§2.3, Scope 1).
Данные индекса не удаляются, а перемещаются, что сохраняет их для возможного анализа в будущем.

### Недостатки (§2.2.1)
Индекс `pubmedindexupdatedtemp` станет полностью недоступным.
Ручные манипуляции в каталоге данных не рекомендуются и требуют обязательного предварительного резервного копирования (Источник 3.1).
Этот метод не восстанавливает данные, а лишь обеспечивает запуск службы.
Потребуется создание индекса-заглушки для стабилизации работы приложения.

## Mᚖ₃: Карантин только каталога состояния (`_state`)

### Суть
Этот метод предполагает перемещение только подкаталога `_state` из каталога поврежденного индекса, оставляя данные шардов на месте.
Цель состоит в том, чтобы попытаться заставить Elasticsearch распознать оставшиеся данные как "dangling index" (висячий индекс) и импортировать их.

### Оценка (§2.3)
15/100

### Достоинства (§2.2.2)
В маловероятном случае успеха это могло бы ускорить восстановление данных по сравнению с полным переиндексированием.

### Недостатки (§2.2.1)
Этот подход создает несогласованное состояние на диске.
Удаление папки `_state` является крайне рискованной операцией, которая может привести к потере данных (Источник 4.4).
Импорт "dangling index" требует наличия корректных локальных метаданных для определения настроек и маппинга; если каталог `_state` удален, эта информация теряется.
Высока вероятность сбоя запуска или дальнейших осложнений.

## Mᚖ₄: Использование инструментов восстановления Lucene (CheckIndex)

### Суть
Этот метод предполагает использование низкоуровневой утилиты Apache Lucene `CheckIndex` для сканирования и попытки исправления поврежденных файлов индекса на диске (Источник 5.1).

### Оценка (§2.3)
0/100

### Достоинства (§2.2.2)
Инструмент может восстановить поврежденные сегменты Lucene (данные шарда) (Источник 3.3).

### Недостатки (§2.2.1)
Текущая проблема связана с файлом `state-22.st`, который является файлом метаданных Elasticsearch, а не индексом Lucene.
Ошибка `CorruptStateException` указывает на проблему уровня шлюза Elasticsearch (Источник 5.2).
Инструмент `CheckIndex` не предназначен для проверки или восстановления файлов `state-*.st`.

## Mᚖ₅: Корректировка сетевой конфигурации

### Суть
Этот метод заключается в обновлении файла конфигурации `elasticsearch.yml` (параметр `network.host`) и правил брандмауэра для учета изменения публичного IP-адреса сервера.

### Оценка (§2.3)
0/100

### Достоинства (§2.2.2)
Эта процедура необходима для восстановления сетевого подключения приложения к Elasticsearch (`O.md`::§2.3, Scope 2).

### Недостатки (§2.2.1)
Этот метод не устраняет причину сбоя запуска службы (`P†`).
Логи ясно указывают на повреждение данных, а не на проблемы с сетевой привязкой.
Служба не запустится из-за повреждения данных, даже если сетевая конфигурация будет исправлена.

## Mᚖ₆: Восстановление из снапшота (Snapshot Restore)

### Суть
Этот метод заключается в использовании механизма резервного копирования Elasticsearch для воссоздания поврежденного индекса из снапшота.

### Оценка (§2.3)
0/100

### Достоинства (§2.2.2)
Это стандартный, безопасный и рекомендуемый способ восстановления данных (Источник 4.2).

### Недостатки (§2.2.1)
Этот метод не решает проблему `P†`, так как он требует работающего кластера Elasticsearch для выполнения команд API.
Служба в настоящее время не запускается.
Успех зависит от существования и актуальности снапшотов.

## Вердикт

Основная причина проблемы `P†` — повреждение файла состояния индекса (`state-22.st`), что препятствует запуску службы Elasticsearch.
Mᚖ₄, Mᚖ₅ и Mᚖ₆ не решают эту проблему.
Mᚖ₃ слишком рискован и технически ненадежен.

Для решения `P†` существуют два жизнеспособных варианта: Mᚖ₁ (быстрый, но рискованный) и Mᚖ₂ (надежный, но требующий последующего восстановления данных).

Учитывая необходимость быстрого восстановления работы (`O.md`::§2.3), рекомендуется прагматичный поэтапный подход, балансирующий скорость и безопасность.

**Рекомендуемый порядок действий:**

1.  **Подготовка (Критически важно):** Создать полную резервную копию всего каталога `D:\Elastic\Elasticsearch\data\` на уровне файловой системы перед внесением любых изменений. Убедиться, что служба Elasticsearch полностью остановлена.
2.  **Попытка быстрого восстановления (▶ Mᚖ₁):**
    *   Переместить только поврежденный файл `state-22.st` из каталога `D:\Elastic\Elasticsearch\data\nodes\0\indices\y4rIWp3MQG2cdeKZNvxBRA\_state\`.
    *   Попытаться запустить службу Elasticsearch.
    *   Если служба запускается и индекс `pubmedindexupdatedtemp` доступен, проблема `P†` решена.
3.  **Гарантированная стабилизация (▶ Mᚖ₂):**
    *   Если Mᚖ₁ не удался, остановить службу.
    *   Переместить весь каталог индекса `D:\Elastic\Elasticsearch\data\nodes\0\indices\y4rIWp3MQG2cdeKZNvxBRA` в безопасное место (карантин).
    *   Запустить службу Elasticsearch. Ожидается успешный запуск.
4.  **Восстановление подключения (Mᚖ₅):** После успешного запуска службы скорректировать `elasticsearch.yml` и правила брандмауэра с учетом нового IP-адреса.
5.  **Восстановление работы приложения:** Если применялся Mᚖ₂, создать пустой индекс-заглушку `pubmedindexupdatedtemp` или псевдоним, чтобы приложение могло подключиться без ошибок.
6.  **Восстановление данных:** Проверить наличие снапшотов и выполнить восстановление (Mᚖ₆), либо спланировать переиндексацию данных.