https://gemini.google.com/share/187c5a087597


## Cᛘ₁: Некорректная сериализация JSON (Аномалия пробелов)

### Суть
Сервер Polymarket требует, чтобы тело JSON-запроса было сериализовано в компактном формате (без пробелов между ключами и значениями) для верификации HMAC-подписи (L2).
Стандартная библиотека `json` в Python по умолчанию добавляет пробелы при сериализации (например, `{"key": "value"}` вместо `{"key":"value"}`).
Если байтовое представление тела запроса, отправленного по сети, отличается от того, которое было использовано для генерации подписи, сервер отвергает запрос с кодом 401.

### Оценка
95

### Доводы за
Клиент использует Python (`O.md` §2.3), язык, в котором стандартное поведение `json.dumps()` приводит к этой аномалии (`O.md` §11.3.1).
Эта проблема официально задокументирована в репозитории `Polymarket/py-clob-client` (Issue #164) как причина ошибки `{"error":"Unauthorized/Invalid api key"}` (`O.md` §11.3.2, §12.2.1).
Симптомы `P†` точно соответствуют этой известной проблеме взаимодействия Python и Polymarket API.
Анализ в `O.md` §11.3 определяет это как «коварный» и «технически сложный» источник ошибок 401.

### Доводы против
Возможно, клиент уже использует пропатченную версию библиотеки или корректно обрабатывает сериализацию вручную, используя `json.dumps(data, separators=(',', ':'))`.

## Cᛘ₂: Ошибки в управлении или деривации учетных данных

### Суть
Бот некорректно использует или получает (деривирует) ключи L2 (API Key, Secret, Passphrase) при работе в боевой среде.
Это может включать использование ключей от тестовой среды (Testnet/paper mode) в боевой (Mainnet), ошибки в логике получения L2-ключей из L1-подписи, или использование неверного API Secret.
Использование неверных учетных данных приводит к генерации невалидной HMAC-подписи или попытке доступа с недействительным API Key.

### Оценка
75

### Доводы за
Проблема `P†` возникла именно при переключении с paper mode на live execution (`O.md` §2.3), что часто связано со сменой учетных данных.
Клиент явно выразил обеспокоенность по поводу корректности этой части кода: «Verify nothing is being overwritten by the credential derivation logic» (`O.md` §2.3, §12.1.2).
Если используется неверный API Secret для генерации HMAC, ошибка 401 «Invalid api key» является ожидаемым результатом.

### Доводы против
Клиент утверждает, что у него уже есть все необходимые ключи (`O.md` §2.3), предполагая, что он уверен в их корректности.

## Cᛘ₃: Некорректная реализация генерации HMAC-подписи (Исключая Cᛘ₁)

### Суть
Алгоритм генерации заголовка `POLY_SIGNATURE` (HMAC-SHA256) в коде бота реализован с ошибками, не связанными с сериализацией JSON.
Это включает неправильный порядок конкатенации элементов, используемых для подписи: временной метки (Timestamp), метода запроса (Method), пути запроса (Request Path) и тела запроса (Body).
Также это может включать некорректное кодирование данных или API Secret перед хэшированием.

### Оценка
50

### Доводы за
Генерация HMAC требует точного следования спецификации API (`O.md` §11.2.2).
Любая ошибка в порядке параметров или кодировке приведет к невалидной подписи (`O.md` §12.2.2).
Если `ꆜ` реализует логику подписания вручную, а не использует стандартный SDK, вероятность такой ошибки возрастает.

### Доводы против
Если используется официальный SDK (`py-clob-client`), базовая логика HMAC, как правило, реализована корректно (за исключением специфического бага Cᛘ₁).

## Cᛘ₄: Рассинхронизация системного времени (Clock Skew)

### Суть
Системное время на сервере (VPS), где запущен бот, значительно отличается (отстает или спешит) от времени сервера Polymarket.
Заголовок `POLY_TIMESTAMP` используется в L2-аутентификации для защиты от атак повторного воспроизведения.
Если временная метка выходит за допустимое окно (обычно несколько секунд), сервер отклоняет запрос как просроченный (`O.md` §11.7.3).

### Оценка
30

### Доводы за
Это распространенная проблема при интеграции с финансовыми и криптовалютными API (`O.md` §12.2.4).
Конфигурация синхронизации времени (NTP) на сервере клиента может быть некорректной.

### Доводы против
Современные серверные среды обычно имеют адекватную синхронизацию времени по умолчанию.
Часто API возвращают более специфическое сообщение об ошибке (например, «Timestamp Expired»), а не общее «Invalid api key».

## Cᛘ₅: Несоответствие конфигурации среды (Endpoint/Chain ID Mismatch)

### Суть
Бот использует несовместимые параметры конфигурации для боевой среды.
Это может включать отправку запросов на неверный URL (например, использование Testnet эндпоинта вместо Mainnet) или использование неверного идентификатора сети (Chain ID) при подписании.
Использование URL одной среды с ключами или параметрами другой среды приведет к сбоям аутентификации (`O.md` §11.5.2).

### Оценка
25

### Доводы за
Ошибки конфигурации часто возникают при переходе между тестовой и боевой средами.
Недавняя миграция тестовой сети Polygon с Mumbai на Amoy увеличивает вероятность использования устаревших параметров (`O.md` §11.5.1).
Использование неверного эндпоинта (URL) приведет к ошибке 401, если ключи не существуют в этой среде.

### Доводы против
Бот успешно подключается к WebSocket-каналам (`O.md` §2.3), что предполагает, что базовый URL, вероятно, верен.
Неверный Chain ID влияет на L1 (EIP-712), и хотя он может вызвать отказ в авторизации, он реже проявляется как ошибка «Invalid api key» (L2).

## Cᛘ₆: Ошибки в подписании ордера EIP-712 (L1)

### Суть
Бот некорректно формирует или подписывает структурированные данные ордера в соответствии со стандартом EIP-712 (L1-аутентификация).
Это может включать ошибки в типах данных, неправильную обработку больших чисел (uint256) в Python, неверное вычисление `tokenId`, или использование некорректных `salt` или `nonce` (`O.md` §11.6).

### Оценка
10

### Доводы за
Стандарт EIP-712 сложен в реализации и требует байтовой точности (`O.md` §11.2.1).
В Python могут возникать проблемы с точностью при работе с большими числами, используемыми в криптографии (`O.md` §11.6.1).
`O.md` §11.1 указывает, что код 401 может служить "зонтичным" индикатором для широкого спектра криптографических аномалий.

### Доводы против
Сообщение об ошибке `Unauthorized/Invalid api key` строго указывает на сбой L2-аутентификации (доступ к API), а не L1 (валидация ордера) (`O.md` §12.2.1.3).
Сбой L1 обычно происходит после успешной аутентификации L2 и возвращает ошибки типа "Invalid Signature".

## Cᛘ₇: Проблемы со статусом кошелька (EOA vs Proxy Wallet)

### Суть
Клиент неправильно настроил взаимодействие с кошельком для боевой торговли.
Это может включать неверное указание параметра `signatureType` (Type 0 EOA vs Type 1 Proxy) (`O.md` §11.4.1).
Также возможно, что Proxy Wallet не был активирован в блокчейне (не выполнен "Enable Trading"), что делает невозможным торговлю через него (`O.md` §11.4.2).

### Оценка
5

### Доводы за
Архитектура Proxy Wallets на Polymarket нетривиальна и часто вызывает путаницу (`O.md` §11.4).
Это обязательный шаг при переходе к реальной торговле, который может быть пропущен.

### Доводы против
Эти ошибки относятся к логике исполнения ордера и валидации L1/баланса.
Они маловероятно проявятся как ошибка L2 «Invalid api key», которая возникает до проверки статуса кошелька.

## Вердикт

Анализ показывает, что проблема `P†` (ошибка 401 Unauthorized) почти наверняка вызвана сбоем на уровне L2-аутентификации (HMAC-подпись HTTP-запроса).
Сообщение «Invalid api key» указывает на то, что сервер не смог верифицировать запрос, используя предоставленные API-ключи и подпись.

Наиболее вероятной причиной является **Cᛘ₁: Некорректная сериализация JSON (P=95)**.
Существует подтвержденная проблема в экосистеме Python/Polymarket, когда стандартная сериализация JSON с пробелами приводит к несовпадению HMAC-подписей.
Это точно соответствует описанным симптомам и используемому стеку технологий.

Второй по вероятности причиной является **Cᛘ₂: Ошибки в управлении или деривации учетных данных (P=75)**.
Поскольку проблема возникает при переходе в боевой режим, существует высокая вероятность, что бот использует неверный набор ключей (например, неправильный API Secret) или некорректно их обрабатывает.

Гипотезы, связанные с L1-аутентификацией (Cᛘ₆, Cᛘ₇), крайне маловероятны, так как ошибка возникает до этапа валидации ордера.