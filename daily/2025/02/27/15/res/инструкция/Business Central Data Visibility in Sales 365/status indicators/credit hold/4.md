### Пошаговая инструкция для передачи статуса «credit hold» из Business Central в Dynamics 365 Sales

Для обеспечения доступности статуса «credit hold» из Microsoft Dynamics 365 Business Central (далее — Business Central) в Microsoft Dynamics 365 Sales (далее — Sales 365) с использованием Power Automate для регулярной передачи данных необходимо выполнить следующие действия. Инструкция основана на требованиях клиента и принятых решениях о применении Power Automate для регулярной синхронизации.

---

#### 1. Подготовка данных в Business Central

1.1. Определить источник данных для статуса «credit hold».  
- В Business Central статус «credit hold» обычно хранится в таблице «Customer» в поле, таком как `Credit Limit (LCY)` или пользовательском поле, указывающем ограничение кредита. Для примера предположим, что используется поле `Blocked` с возможным значением "Credit" или отдельное логическое поле `Credit Hold` (тип Boolean).  
- Проверить, доступно ли это поле через Business Central API или OData-сервисы. Для этого перейти в Business Central в раздел «Web Services», найти запись для объекта «Customer» (например, страница 21) и убедиться, что поле `Credit Hold` опубликовано. Если поле отсутствует, добавить его в список доступных через настройку «Web Services».

1.2. Подготовить уникальный идентификатор клиента.  
- Убедиться, что поле `No.` (номер клиента) в таблице «Customer» используется как уникальный ключ для сопоставления записей между Business Central и Sales 365. Это поле будет связующим звеном для передачи данных.

---

#### 2. Создание потока в Power Automate

2.1. Перейти в Power Automate и создать новый поток.  
- Открыть портал Power Automate по адресу `make.powerautomate.com`.  
- Нажать «Create» → выбрать тип потока «Scheduled cloud flow» для регулярного выполнения.

2.2. Настроить триггер для регулярного запуска.  
- В триггере «Recurrence» установить интервал обновления данных, например, ежедневно в 8:00 утра (в зависимости от требований бизнеса).  
- Указать временную зону, соответствующую местоположению клиента (например, CST для Chanhassen, США).

2.3. Добавить действие для получения данных из Business Central.  
- Добавить шаг «Get rows» из коннектора «Dynamics 365 Business Central».  
- В настройках действия указать:  
  - «Environment Name»: выбрать среду Business Central (например, Production).  
  - «Company»: выбрать компанию из списка доступных в Business Central.  
  - «Table Name»: выбрать таблицу «Customer».  
- При необходимости добавить фильтр в поле «Filter Query», например, `Credit_Hold eq true`, чтобы извлекать только клиентов с установленным статусом «credit hold».

---

#### 3. Обработка данных для передачи

3.1. Извлечь необходимые поля из Business Central.  
- В действии «Get rows» убедиться, что возвращаются поля `No.` (номер клиента) и `Credit Hold` (или эквивалентное поле, например, `Blocked`).  
- Использовать действие «Select» для формирования структуры данных, включающей только эти поля. Пример настройки:  
  - «From»: результат действия «Get rows».  
  - «Map»:  
    - `CustomerNumber`: `No.`  
    - `CreditHoldStatus`: `Credit Hold` (или `Blocked`, если используется это поле).

3.2. Преобразовать данные в совместимый формат.  
- Убедиться, что значение `Credit Hold` (true/false) или `Blocked` ("Credit"/пусто) преобразуется в формат, понятный Sales 365. Например, преобразовать логическое значение `true` в текстовое «On Hold» и `false` в «Active» с помощью действия «Compose» и выражения:  
  ```
  if(equals(outputs('CreditHoldStatus'), true), 'On Hold', 'Active')
  ```

---

#### 4. Передача данных в Dynamics 365 Sales

4.1. Подготовить поле в Sales 365 для хранения статуса «credit hold».  
- В Sales 365 перейти в «Settings» → «Advanced Settings» → «Customizations» → «Customize the System».  
- Открыть сущность «Account», создать новое поле с типом «Option Set» или «Text».  
  - Название поля: `Credit Hold Status`.  
  - Для «Option Set»: задать значения, например, «On Hold» и «Active».  
- Сохранить и опубликовать изменения.

4.2. Добавить действие для обновления записей в Sales 365.  
- В Power Automate добавить шаг «Update a record» из коннектора «Dynamics 365».  
- Настроить действие:  
  - «Organization Name»: выбрать среду Sales 365.  
  - «Entity Name»: выбрать «Accounts».  
  - «Record identifier»: использовать динамическое значение `CustomerNumber` из Business Central для поиска соответствующей записи в Sales 365 (предполагается, что `CustomerNumber` сопоставлен с полем, например, `Account Number` в Sales 365).  
- В поле «Credit Hold Status» передать преобразованное значение из шага 3.2 (например, «On Hold» или «Active»).

4.3. Обработать каждую запись.  
- Добавить действие «Apply to each» перед шагом «Update a record», чтобы обработать все строки, полученные из Business Central.  
- Внутри «Apply to each» указать массив данных из шага «Select» и выполнить обновление для каждой записи.

---

#### 5. Тестирование и проверка

5.1. Провести тестовый запуск потока.  
- В Power Automate запустить поток вручную через кнопку «Test».  
- Проверить, что данные о клиентах с установленным статусом «credit hold» в Business Central корректно обновляют поле «Credit Hold Status» в Sales 365.  
- Убедиться, что клиенты без статуса «credit hold» также получают соответствующее значение («Active»).

5.2. Проверить доступность статуса в интерфейсе Sales 365.  
- Открыть несколько записей «Account» в Sales 365, убедиться, что поле «Credit Hold Status» отображается и содержит ожидаемые значения.  
- При необходимости добавить поле в формы или представления через «Customize the System».

---

#### 6. Настройка мониторинга и документации

6.1. Настроить уведомления об ошибках.  
- В Power Automate включить опцию уведомлений в разделе «Flow Settings», чтобы получать сообщения о сбоях (например, по электронной почте).  
- Регулярно проверять журнал выполнения потока в разделе «Run History».

6.2. Задокументировать процесс.  
- Создать документ, описывающий:  
  - Название потока в Power Automate.  
  - Используемые поля (`No.`, `Credit Hold` в Business Central; `Credit Hold Status` в Sales 365).  
  - Логику преобразования данных (например, true → «On Hold»).  
  - Интервал запуска (ежедневно в 8:00).  
- Указать контакты для поддержки в случае сбоев.

6.3. Провести обучение пользователей.  
- Объяснить сотрудникам Sales 365, где найти статус «credit hold» (например, в карточке клиента в поле «Credit Hold Status»).  
- Описать, как интерпретировать значения («On Hold» означает ограничение по кредиту).

---

### Итог

Данная инструкция позволяет регулярно передавать статус «credit hold» из Business Central в Sales 365 с использованием Power Automate. После настройки данные будут доступны в Sales 365 в поле «Credit Hold Status» для всех соответствующих записей «Account», обеспечивая актуальность информации для отдела продаж.