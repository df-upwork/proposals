## Cᛘ₁: Несоответствие метода входа конфигурации синхронизации групп

### Суть
Пользователи пытаются войти в систему, используя своё имя участника-пользователя (UPN, например, `user@company.com`), в то время как конфигурация сервера по умолчанию требует использования имени группы Entra ID в качестве имени пользователя для групповой аутентификации.

### Оценка (§2.3)
90

### Доводы за (§2.2.1)
Поведение аутентификации групп в Azure PostgreSQL Flexible Server регулируется параметром `pgaadauth.enable_group_sync`.
По умолчанию этот параметр часто бывает выключен (OFF).
Когда синхронизация выключена, пользователи, подключающиеся через членство в группе, должны указывать имя группы Entra ID в качестве имени пользователя (в psql или DBeaver), а свой личный токен доступа — в качестве пароля.
Документация Microsoft подтверждает, что если синхронизация включена (ON), пользователи могут входить в систему, используя роль с тем же именем, что и их адрес электронной почты (UPN) (Source 1.1).
Если пользователи пытаются использовать свой UPN при выключенной синхронизации, PostgreSQL не сопоставит их с ролью группы.
Этот сценарий точно объясняет, почему прямые сопоставления пользователей (где вход осуществляется по UPN и существует соответствующая роль UPN) работают, а групповые — нет.
Это поведение часто является неочевидным для администраторов.
Документация DBeaver (и CloudBeaver, его веб-версии) также указывает на необходимость указания "Azure Group Name" для группового доступа (Source 6.2, 6.3).

### Доводы против (§2.2.2)
Если клиент уже включил `pgaadauth.enable_group_sync = ON`, то вход с использованием UPN должен работать, и эта гипотеза не объясняет проблему.
Если клиент, зная особенности системы, уже пробовал входить в систему, используя имя группы в качестве имени пользователя (или настроив соответствующее поле в DBeaver), и это также не удалось, то причина кроется в другом.

## Cᛘ₂: Недостаточные разрешения Microsoft Graph API

### Суть
Удостоверение (Identity), используемое сервером Azure PostgreSQL Flexible Server для интеграции с Entra ID, не имеет необходимых разрешений API для чтения информации о членстве пользователей в группах из Microsoft Graph.

### Оценка (§2.3)
80

### Доводы за (§2.2.1)
Для авторизации пользователя на основе его членства в группе серверу PostgreSQL может потребоваться проверить это членство в Entra ID.
Эта проверка часто выполняется путем запроса к Microsoft Graph API, особенно если включен параметр `pgaadauth.enable_group_sync` или если информация о группах отсутствует в токене доступа (например, из-за "overage").
Для выполнения таких запросов удостоверение сервера должно иметь соответствующие разрешения в Entra ID, такие как `GroupMember.Read.All` или `Directory.Read.All` (Source 3.1).
Предоставление этих разрешений требует согласия администратора тенанта и часто упускается при настройке (Source 3.1).
Прямая аутентификация пользователя работает, поскольку она основана на идентификаторе объекта пользователя (OID), который всегда присутствует в токене, и не требует запросов к Graph API для проверки групп.

### Доводы против (§2.2.2)
Если `pgaadauth.enable_group_sync` выключен и пользователь входит в систему, используя имя группы (как описано в Cᛘ₁), возможно, система требует меньше разрешений Graph API, полагаясь в первую очередь на валидацию токена и сопоставление имени входа с ролью.
Если пользователи являются членами небольшого количества групп, идентификаторы групп могут присутствовать непосредственно в токене, что снижает необходимость запроса к Graph API.

## Cᛘ₃: Некорректная конфигурация роли группы в PostgreSQL

### Суть
Роль в базе данных PostgreSQL, представляющая группу Entra ID, была создана с ошибками, такими как неверный регистр, неточное имя или отсутствие привилегии LOGIN.

### Оценка (§2.3)
60

### Доводы за (§2.2.1)
Создание ролей Entra ID в PostgreSQL требует точного синтаксиса.
Имена пользователей и групп Microsoft Entra чувствительны к регистру в Azure PostgreSQL (Source 6.1).
Имя роли должно точно совпадать с отображаемым именем (Display Name) группы в Entra ID.
Если роль создается вручную, например, с помощью функции `pgaadauth_create_principal` или через SQL, ошибка в имени или идентификаторе объекта (Object ID) приведет к сбою аутентификации.
Неправильное экранирование специальных символов или пробелов в имени группы при создании роли или подключении также может вызвать проблемы.

### Доводы против (§2.2.2)
Клиент успешно настроил прямые сопоставления пользователей («direct user mappings work»), что предполагает понимание процесса создания ролей Entra ID в PostgreSQL и чувствительности к регистру.
Если для добавления роли использовался портал Azure или инструменты, которые позволяют выбирать объекты непосредственно из каталога, вероятность ошибок в имени или ObjectID снижается.

## Cᛘ₄: Проблема "Group Overage" (Превышение лимита групп в токене)

### Суть
Пользователи являются членами слишком большого количества групп Entra ID, что приводит к тому, что Entra ID не включает полный список групп в токен доступа.

### Оценка (§2.3)
30

### Доводы за (§2.2.1)
Entra ID ограничивает количество групп, включаемых в токен JWT, до 200 (Source 4.1, 4.2, 4.3).
Если пользователь превышает этот лимит, Entra ID вместо списка групп включает "утверждение о переполнении" (overage claim) (Source 4.1).
В этом случае приложение (сервер PostgreSQL) должно запросить полный список групп через Microsoft Graph API (Source 4.1).
Если у сервера нет необходимых разрешений Graph API (см. Cᛘ₂) для обработки этого утверждения, аутентификация на основе групп завершится неудачей.

### Доводы против (§2.2.2)
Компания клиента небольшая (2-9 сотрудников, согласно O.md::§5.2.2).
Крайне маловероятно, что пользователи в такой маленькой организации являются членами более чем 200 групп, если только они не работают во внешнем, очень большом тенанте Entra ID.

# Вердикт (§2.4)

Наиболее вероятной причиной проблемы (`P†`) является **Cᛘ₁: Несоответствие метода входа конфигурации синхронизации групп**.

Поведение Azure PostgreSQL Flexible Server по умолчанию является контринтуитивным.
Если параметр `pgaadauth.enable_group_sync` не включен (значение по умолчанию), пользователи **обязаны** использовать имя группы Entra ID в качестве имени пользователя при подключении (или заполнить соответствующее поле "Azure Group Name" в DBeaver), а не свой UPN.
Вероятнее всего, пользователи пытаются использовать UPN, что приводит к сбою групповой аутентификации, хотя прямая аутентификация по UPN работает для индивидуально сопоставленных ролей.

Для решения проблемы у клиента есть два основных варианта:
1. Оставить `pgaadauth.enable_group_sync` выключенным и убедиться, что пользователи указывают имя группы (с учетом регистра) в качестве имени пользователя в psql/DBeaver.
2. Включить `pgaadauth.enable_group_sync = ON`, чтобы разрешить вход по UPN с автоматическим наследованием групповых ролей.

Если выбран вариант 2, критически важно также устранить потенциальную проблему **Cᛘ₂: Недостаточные разрешения Microsoft Graph API**.
Для синхронизации групп и проверки членства серверу потребуются разрешения в Entra ID, такие как `GroupMember.Read.All`, для которых необходимо получить согласие администратора тенанта.