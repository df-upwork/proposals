Ниже приведена обновлённая инструкция по ограничению выгрузки лидов в Dynamics 365 Sales (далее: Sales 365) на основе формата номера аккаунта, с обеспечением правильного назначения подразделения или группы клиентов, учитывая решения о создании поля на базе механизма Formula Field в Salesforce, использовании CSV для экспорта и импорта данных в Sales 365.

1) Подготовка механизма определения типа аккаунта в Salesforce

1.1) Создать Formula Field в Salesforce для классификации лида.  
В разделе «Setup» → «Object Manager» → «Lead» → «Fields & Relationships» создать новое поле с типом «Formula».  
В пункте «Formula Return Type» установить значение Text (или Picklist, если предпочтительнее работать со списком).  
Указать формулу, определяющую тип по формату номера аккаунта. Например:  
```
IF(
  BEGINS(AccountNumber, "DLR-"),
  "Dealer",
  "Customer"
)
```
Этот фрагмент проверяет, начинается ли значение AccountNumber с DLR- и возвращает «Dealer» в этом случае, иначе «Customer».  

1.2) Сохранить новое поле и при необходимости отразить его в макете страницы (Page Layout).  
Таким образом, формула автоматически вычисляет нужное значение (например, «Dealer» или «Customer») для каждого лида и хранится в поле, доступном для экспорта.

2) Экспорт нужных лидов из Salesforce в формате CSV

2.1) Сформировать выборку лидов в Salesforce.  
Например, применить «Report» (при необходимости) или использовать «Data Loader» для выгрузки объектов Lead.  
Главное, чтобы в итоговом наборе данных присутствовало поле AccountNumber и созданное поле Formula Field (например, Account_Type__c).

2.2) Экспортировать данные в CSV.  
При использовании «Data Loader» установить операцию Export и указать нужные поля (Id, AccountNumber, Formula Field и т. д.).  
Сохранить итоговый файл, например `export_leads.csv`.

3) Фильтрация записей по новому полю

3.1) При наличии большого массива данных возможно удобнее отфильтровать лиды непосредственно перед импортом в Sales 365.  
Например, в программе для работы с CSV (Microsoft Excel или аналогичной) отсеять строки, где Formula Field имеет значение «Customer», и сохранить только строки, где Formula Field равен «Dealer» (или другой условный тип).

3.2) Сохранить итоговый CSV-файл после фильтрации.  
Например, `filtered_leads.csv`.  
Этот файл готов к импорту в Sales 365.

4) Импорт CSV в Dynamics 365 Sales

4.1) В интерфейсе Sales 365 открыть «Settings» → «Advanced Settings» → «Data Management» → «Imports» (или использовать другое актуальное расположение в зависимости от версии).  
4.2) Выбрать «Import Data», указать `filtered_leads.csv` и выполнить настройку сопоставления (Mapping) полей:  
• Поле Id в Salesforce к полю Lead ID (или аналогичному) в Sales 365, если необходимо.  
• Остальные поля (First Name, Last Name, Email и т. д.) к соответствующим полям в Sales 365.  

4.3) Запустить импорт. После завершения импортированные лиды будут доступны в Sales 365.  
Проверить, что попали только записи с нужным форматом номера аккаунта и нужным значением Formula Field.

5) Обеспечение назначения правильного подразделения или группы клиентов (при необходимости)

5.1) Если в Sales 365 требуется дополнительное распределение лидов (например, по полю «Dealer»), настроить «Business Rules» или «Workflows» внутри Sales 365, чтобы при создании лида с определённым значением Formula Field выполнять нужное действие:  
• Заполнять поле «Division» или «Customer Group»,  
• Устанавливать статус или назначать ответственного менеджера.  

5.2) При простой задаче указать подразделение можно сразу в процессе импорта (через настроенное сопоставление), если в CSV есть соответствующее поле, либо сделать последующую массовую корректировку.

6) Проверка результата и документирование

6.1) На тестовых записях удостовериться, что:  
• Formula Field в Salesforce корректно вычисляет «Dealer» или «Customer» по формату номера аккаунта.  
• В CSV-файле оказываются только нужные строки (если делалась промежуточная фильтрация).  
• В Sales 365 загружаются только те лиды, у которых Formula Field соответствует условию.

6.2) Задокументировать логику настройки (место, где хранится формула, какой формат номера аккаунта считается дилерским и т. д.) и ознакомить команду, чтобы при изменении бизнес-правил было ясно, в каком месте корректировать формулу или фильтр.

В результате лиды, не соответствующие нужному формату номера аккаунта, не попадут в Sales 365, а требуемые записи получат правильное назначение и при необходимости будут распределены по подразделению или группе клиентов.