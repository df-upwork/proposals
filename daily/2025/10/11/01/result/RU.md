I. Наиболее вероятные причины вашей проблемы:
1) CPU Burst Capacity
1.1) Суть
Инстансы AWS Lightsail функционируют на основе модели Burstable Performance.
Эта модель предоставляет низкий базовый уровень производительности ЦП с возможностью временного его превышения за счет накопленных кредитов (CPU Burst Capacity).
Если нагрузка на ЦП превышает базовый уровень, кредиты расходуются.
Когда кредиты исчерпаны, производительность ЦП принудительно ограничивается базовым уровнем (например, 10-30% от полной мощности vCPU).
Это ограничение (throttling) приводит к резкому замедлению обработки запросов или полной недоступности сайта.
1.2) Обоснование
Характер проблемы, описанный как «intermittent», идеально соответствует циклу исчерпания кредитов под нагрузкой и их медленного восстановления в простое.
Это самая распространенная причина внезапного падения производительности на инстансах Lightsail и EC2 T-серии.
Базового уровня производительности часто недостаточно для обслуживания производственного сайта WordPress под нагрузкой, особенно при выполнении фоновых задач или обработке пикового трафика.
2) Нехватка оперативной памяти и активация OOM Killer
2.1) Суть
Стек приложений (Apache, MySQL, PHP) потребляет оперативную память (RAM) для своей работы и обработки запросов.
Если совокупное потребление памяти превышает доступный объем физической RAM, операционная система начинает использовать дисковое пространство подкачки (Swap).
Интенсивное использование Swap (thrashing) резко снижает производительность из-за медленных операций дискового ввода-вывода.
Если физическая память и Swap исчерпаны, ядро Linux активирует механизм OOM (Out-Of-Memory) Killer.
OOM Killer принудительно завершает критические процессы (часто MySQL или Apache) для освобождения памяти, вызывая полный простой сайта.
2.2) Обоснование
Инстансы Lightsail, особенно на младших тарифах, имеют ограниченный объем RAM (например, 1GB или 2GB), которого часто недостаточно для стека LAMP под нагрузкой .
WordPress, особенно с большим количеством плагинов, может потреблять значительный объем памяти.
Нехватка памяти является типичной причиной сбоев, таких как ошибка подключения к базе данных, когда процесс MySQL завершается.
3) Неоптимальная конфигурация веб-сервера (Apache/PHP)
3.1) Суть
Настройки веб-сервера Apache, управляющие количеством одновременных процессов, не соответствуют доступным ресурсам сервера.
Если параметр `MaxRequestWorkers` (или `MaxClients`) установлен слишком высоко, сервер может создать слишком много дочерних процессов под нагрузкой.
Избыточное количество процессов приводит к чрезмерному потреблению оперативной памяти, усугубляя проблему пункта 2.
Если параметр установлен слишком низко, сервер не сможет обработать входящий трафик, что приведет к отказу в обслуживании.
3.2) Обоснование
Стандартные конфигурации Apache (особенно с `mod_php`) часто потребляют слишком много памяти для небольших серверов и могут быстро привести к OOM ошибкам.
Настройка баланса между параллелизмом и потреблением памяти критически важна на серверах с ограниченными ресурсами.
Если сервер начинает использовать Swap из-за слишком высокого `MaxRequestWorkers`, это убивает производительность.
4) Вредоносный трафик и боты (Brute-Force, XML-RPC, DDoS)
4.1) Суть
Автоматизированные атаки и агрессивные боты создают чрезмерную нагрузку на сервер, потребляя ресурсы CPU и памяти и вызывая отказ в обслуживании.
Основные векторы атак на WordPress включают попытки подбора паролей к `wp-login.php` и атаки через интерфейс `xmlrpc.php`.
4.2) Обоснование
WordPress является частой целью для автоматизированных атак.
Атаки на `xmlrpc.php` позволяют использовать функцию `system.multicall` для проверки сотен паролей в одном HTTP-запросе, что значительно увеличивает нагрузку и эффективность атаки.
Атаки могут использовать функцию Pingback для проведения DDoS-атак, перегружая сервер запросами.
Периодический характер проблемы хорошо соответствует паттернам атак или активности ботов.
Даже не очень интенсивные атаки могут перегрузить небольшой инстанс Lightsail.

II. What monitoring and alerting stack do you typically recommend for small production environments?
1) Нативный стек AWS (Метрики Lightsail + Агент CloudWatch)
1.1) Суть
Этот подход использует исключительно сервисы Amazon Web Services.
Встроенные метрики Lightsail автоматически собирают данные уровня гипервизора (использование ЦП, сеть, CPU Burst Capacity).
Для сбора метрик уровня операционной системы (память, диск) и журналов приложений (Apache, MySQL) требуется установка агента CloudWatch Agent на инстанс.
Данные централизуются в Amazon CloudWatch для визуализации, оповещения (CloudWatch Alarms) и анализа журналов (Logs Insights).
1.2) Достоинства
Это единственное решение, способное отслеживать CPU Burst Capacity (I.1) — наиболее вероятную причину вашей проблемы.
2) Высокодетализированный диагностический мониторинг (Netdata)
2.1) Суть
Netdata — это инструмент с открытым исходным кодом для мониторинга производительности систем в реальном времени.
Он устанавливается как легковесный агент на инстанс Lightsail.
Агент автоматически обнаруживает службы (Apache, MySQL) и собирает тысячи метрик с посекундной гранулярностью.
Данные доступны через локальный веб-интерфейс или бесплатный сервис Netdata Cloud.
2.2) Достоинства
Решение обеспечивает посекундную гранулярность, что бесценно для диагностики периодических всплесков производительности, характерных для I.2 и I.3.
Агент чрезвычайно легковесен, потребляя минимум ресурсов ЦП и памяти, что критически важно для сервера с ограниченными ресурсами.
Установка очень проста и не требует настройки для стандартных стеков LAMP благодаря автообнаружению.
Решение предлагает отличную, предварительно настроенную визуализацию всех компонентов системы и производительности приложений.
2.3) Недостатки
Решение не может отслеживать метрики уровня гипервизора, такие как AWS CPU Burst Capacity.
Оно в первую очередь ориентировано на устранение неполадок в реальном времени, а не на долгосрочный анализ исторических тенденций или централизованное управление журналами.
Возможности оповещения менее гибки по сравнению с CloudWatch или SaaS-платформами.
Дашборд может быть перегружен из-за огромного количества представленных метрик.

III. «What’s your approach to finding the root cause of recurring Apache/MySQL downtime?» 
1) Advanced Resource Monitoring
1.1) Суть
Этот метод направлен на получение детальных метрик, недоступных в стандартном мониторинге Lightsail, в первую очередь использования оперативной памяти (RAM) и файла подкачки (Swap).
Для этого требуется установка агента мониторинга, например AWS CloudWatch Agent, или использование внешних систем.
1.2) Достоинства
Мониторинг использования RAM и Swap абсолютно необходим для диагностики условий, приводящих к активации OOM Killer (I.2).
Метод также позволяет выявить падение производительности из-за интенсивного использования Swap (thrashing).
Метод заполняет критические пробелы в базовых метриках Lightsail, предоставляя полную картину состояния ресурсов сервера.
Исторические данные позволяют анализировать использование ресурсов, предшествующее простою, и выявлять тренды, такие как утечки памяти.
1.3) Недостатки
Метод требует установки и настройки дополнительного программного обеспечения (агентов) на сервере.
Использование расширенных метрик CloudWatch или внешних сервисов может повлечь дополнительные расходы.
Агенты мониторинга потребляют некоторое количество ресурсов сервера.

2) System Log Analysis
2.1) Суть
Этот метод включает изучение журналов ядра Linux (`dmesg`, `/var/log/kern.log`) и системных журналов (`/var/log/syslog`, `journalctl`) для выявления критических событий на уровне операционной системы.
Основное внимание уделяется поиску сообщений от механизма OOM (Out-Of-Memory) Killer и ошибок запуска служб.
2.2) Достоинства
Метод предоставляет прямые доказательства активации OOM Killer (пункт I.2).
Анализ позволяет точно определить, какой процесс был завершен и когда это произошло.
Сбор системных журналов оказывает минимальное влияние на производительность сервера.
Временные метки в журналах помогают установить точную хронологию событий.
2.3) Недостатки
Системные журналы фиксируют механизм отказа (например, OOM), но не первопричину исчерпания памяти (например, всплеск трафика).
Критические сообщения могут быть потеряны из-за неправильной настройки ротации логов или переполнения буфера ядра.
Для анализа требуются доступ по SSH и навыки работы с командной строкой Linux.

3) Basic Infrastructure Metrics Monitoring
3.1) Суть
Этот метод использует встроенные инструменты мониторинга AWS Lightsail для анализа ключевых показателей производительности инстанса.
Основное внимание уделяется метрикам использования ЦП (CPU Utilization) и оставшейся квоте взрывной производительности ЦП (CPU Burst Capacity).
3.2) Достоинства
Этот метод критически важен для диагностики I.1, так как исчерпание CPU Burst Capacity приводит к дросселированию ЦП на инстансах Lightsail (Source 10.1).
Метрики предоставляют объективные данные для подтверждения гипотезы о снижении производительности из-за ограничений инфраструктуры AWS.
Инструменты встроены в платформу AWS и не требуют настройки на самом сервере.
Анализ исторических данных позволяет выявить паттерны использования ЦП и частоту исчерпания квоты.
3.3) Недостатки
Стандартные метрики Lightsail не включают мониторинг использования оперативной памяти (RAM) и дискового пространства, что критично для диагностики I.2.
Метрики показывают факт исчерпания ресурсов ЦП, но не указывают, какие именно процессы вызвали это исчерпание.
Низкая гранулярность стандартных метрик может скрывать короткие пики нагрузки.

4) Application Log Analysis
4.1) Суть
Этот метод заключается в детальном изучении журналов веб-сервера (Apache `access.log` и `error.log`), базы данных (MySQL `error.log` и `slow_query_log`) и PHP.
Цель состоит в том, чтобы понять характер трафика, выявить ошибки приложений и определить неэффективные операции базы данных.
4.2) Достоинства
Анализ `access.log` критически важен для выявления всплесков трафика, активности ботов или DDoS-атак (I.4).
Он позволяет идентифицировать атаки на уязвимые точки WordPress (`xmlrpc.php`, `wp-login.php`), создающие чрезмерную нагрузку.
Журналы медленных запросов MySQL напрямую указывают на неэффективные SQL-запросы, потребляющие избыточные ресурсы (I.6).
Журналы ошибок Apache и PHP фиксируют сбои выполнения скриптов, такие как достижение лимита памяти PHP или таймауты.
4.3) Недостатки
Объем журналов доступа может быть очень большим, что затрудняет ручной анализ без специализированных инструментов агрегации.
Журналы приложений не предоставляют прямой информации об использовании системных ресурсов (CPU, RAM) на уровне инфраструктуры.
По умолчанию журналирование медленных запросов MySQL может быть отключено и требует настройки.

5) Stack Configuration Audit
5.1) Суть
Этот метод включает аудит настроек Apache, MySQL и PHP на предмет их соответствия доступным ресурсам сервера (RAM и CPU).
В Apache анализируются параметры модуля MPM, такие как `MaxRequestWorkers` или `MaxClients` (I.3).
В MySQL проверяются параметры, влияющие на потребление памяти, в первую очередь размер буферного пула (`innodb_buffer_pool_size`).

5.2) Достоинства
Неоптимальная конфигурация часто является ключевым фактором нестабильности на серверах с ограниченными ресурсами.
Правильная настройка Apache MPM может предотвратить создание избыточного количества процессов, ведущее к исчерпанию памяти (I.2).
Оптимизация конфигурации MySQL позволяет достичь баланса между производительностью базы данных и общим потреблением памяти системой.
Корректировка конфигурации может повысить стабильность без необходимости масштабирования оборудования.

5.3) Недостатки
Оптимальные настройки сильно зависят от характера нагрузки, который часто неизвестен на начальном этапе диагностики.
Метод требует экспертных знаний в области администрирования Apache и тюнинга производительности MySQL.
Внесение изменений в конфигурацию без понимания первопричины проблемы может усугубить ситуацию.

6) Application and Database Profiling
6.1) Суть
Этот метод заключается в использовании специализированных инструментов для анализа производительности WordPress на уровне кода и запросов к базе данных.
Используются плагины (например, Query Monitor) или внешние сервисы APM (Application Performance Monitoring) для выявления медленного PHP-кода и тяжелых SQL-запросов.
6.2) Достоинства
Профилирование позволяет точно определить конкретный плагин, тему или фрагмент кода, ответственный за высокое потребление ресурсов.
Метод позволяет выявить фундаментальные причины неэффективности приложения.
Оптимизация кода и запросов обеспечивает долгосрочное решение проблемы производительности.
6.3) Недостатки
Инструменты профилирования добавляют значительную нагрузку на сервер, что может усугубить проблемы со стабильностью во время анализа.
Внешние APM-решения могут быть сложными в настройке и дорогостоящими.
Профилирование не выявляет проблем на уровне инфраструктуры (I.1) или внешних атак (I.4).
Результаты профилирования требуют опыта разработки на WordPress для интерпретации и исправления.