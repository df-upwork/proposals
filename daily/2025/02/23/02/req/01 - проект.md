## 1.
Клиент хочет выполнить следующий проект:
### 1.1. Title
Cloudflare SSL Expert Needed for Immediate Issue Resolution

### 1.2. Description
We are seeking a Cloudflare SSL expert to address an urgent issue with our production subdomains 
The specific problem is the ERR_ECH_FALLBACK_CERTIFICATE_INVALID error that needs immediate attention. 
If you have strong experience with Cloudflare SSL configurations and can troubleshoot and resolve this issue efficiently, we would love to hear from you. 
Please provide your availability for an immediate start and any relevant experience with similar issues.

### 1.3. Местоположение клиента
Israel
Ramat Gan

### 1.4. Tags
Cloudflare
Network Administration
Linux System Administration
Network Security

## 2. Что означает `ERR_ECH_FALLBACK_CERTIFICATE_INVALID`?
### 2.1.
Я тебя спросил:
~~~
Что означает `ERR_ECH_FALLBACK_CERTIFICATE_INVALID`?
~~~

### 2.2.
Ты ответил:
~~~
**ERR_ECH_FALLBACK_CERTIFICATE_INVALID** — это ошибка, связанная с механикой Encrypted Client Hello (ECH) в протоколе TLS. 

1. **Что такое ECH**  
   - *Encrypted Client Hello* (ранее известный как ESNI) — это новая технология шифрования расширенных данных при установлении TLS-соединения. Цель ECH — скрыть от внешнего наблюдателя (например, провайдера или атакующего) детали запроса, такие как используемый домен и другие параметры, которые обычно видны в открытом виде в процессе TLS Handshake.

2. **Роль «Fallback Certificate»**  
   - При включённом ECH ваш сервер (или прокси/Cloudflare) использует «ECH-конфигурацию», чтобы принимать зашифрованные запросы от клиента. Однако, если клиент или сеть не поддерживает ECH, сервер должен «откатиться» (fallback) на обычное TLS-соединение.
   - Для такого «откатного» сценария может использоваться специальный сертификат по умолчанию (fallback certificate). Если этот сертификат некорректно настроен или недействителен, возникает ошибка **ERR_ECH_FALLBACK_CERTIFICATE_INVALID**.

3. **Причины появления ошибки**  
   - **Неправильная конфигурация сертификата**: Имя домена или SAN (Subject Alternative Name) в fallback-сертификате не совпадает с реальным запрашиваемым доменом.  
   - **Истёкший сертификат**: Сертификат просрочен либо аннулирован.  
   - **Отсутствие доверия к сертификату**: Если fallback-сертификат не подписан доверенным центром сертификации или у него неверная цепочка доверия.  
   - **Сбой в настройках Cloudflare**: Неправильный DNS-запись или конфликт между ECH-конфигурацией и «обычным» SSL/TLS-сертификатом на уровне Cloudflare.

4. **Как устранить**  
   - **Проверить сертификаты**: Убедиться, что сертификат для fallback-домена корректен, не просрочен и соответствует запрашиваемому домену.  
   - **Синхронизировать записи DNS**: На DNS-уровне должны быть корректные записи (A/AAAA и CNAME) для доменов и субдоменов.  
   - **Обновить/переиздать сертификат**: Если сертификат недействителен, переиздайте его у доверенного CA (или через Cloudflare, если вы используете их Universal SSL).  
   - **Проверить настройки Cloudflare**: Убедитесь, что в панели управления Cloudflare указаны правильные сертификаты, включена нужная версия TLS, а ECH (если включён) настроен корректно или временно выключен, если вызывает проблемы.

Таким образом, ошибка **ERR_ECH_FALLBACK_CERTIFICATE_INVALID** означает, что при попытке «откатиться» к обычному TLS-соединению (в случае, когда ECH недоступен или не поддерживается клиентом) используемый резервный (fallback) сертификат оказался недействительным. Для исправления необходимо проверить правильность его настройки, соответствие DNS-записей и целостность цепочки доверия.
~~~

## 3. Наиболее вероятные причины `ERR_ECH_FALLBACK_CERTIFICATE_INVALID`
### 3.1.
Я тебя спросил:
~~~
Перечисли наиболее вероятные причины `ERR_ECH_FALLBACK_CERTIFICATE_INVALID`.
~~~

### 3.2.
Ты ответил:
~~~
Ниже перечислены наиболее вероятные причины возникновения ошибки **ERR_ECH_FALLBACK_CERTIFICATE_INVALID** при использовании Cloudflare (или другой прокси, поддерживающей ECH):

1. **Несоответствие домена**  
   - Имя домена (CN или SAN) в «fallback»-сертификате не совпадает с реальным запрашиваемым доменом.  

2. **Истёкший или отозванный сертификат**  
   - Fallback-сертификат просрочен, отозван либо не обновлён вовремя у центров сертификации.

3. **Недоверенный сертификат**  
   - Цепочка сертификата не верна или не подписана доверенным CA, поэтому браузер/клиент не признаёт сертификат валидным.

4. **Сбой в конфигурации Cloudflare**  
   - Неправильные DNS-записи (A/AAAA/CNAME), конфликт ECH-конфигурации с «обычным» SSL/TLS-сертификатом или некорректные настройки Universal SSL.

5. **Отсутствие корректного fallback-сертификата**  
   - При включённом ECH сервер должен предоставлять специальный сертификат для клиентов, которые ECH не поддерживают. Если такого сертификата нет или он настроен неверно, это приводит к ошибке.

6. **Ошибки при выпуске или установке нового сертификата**  
   - Возможно, сертификат был переиздан, но не установлен корректно (не обновлена цепочка, не перезапущен сервис, не добавлены необходимые промежуточные сертификаты и т. д.).
~~~

## 4. Таблица вероятностей
### 4.1.
Я тебя спросил:
~~~
Итак, в пункте 4 ты перечислил 6 вероятных причины проблемы клиента.
Построй таблицу с 3 колонками:
- номер причины (из пункта 3)
- вероятность, что именно эта причина является источником проблемы клиента  (в процентах)
- твоё пояснение: почему ты думаешь, что вероятность именно такая
Строки таблицы упорядочи по убыванию вероятностей.
~~~

### 4.2.
Ты ответил:
~~~
Ниже приведена примерная оценка вероятностей для каждой из перечисленных причин, а также пояснения, почему вероятность именно такова. Таблица упорядочена по убыванию вероятности.

| № причины | Вероятность (в %) | Пояснение                                                                                                                                                                                                  |
|:---------:|:-----------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|     1     |        30%        | **Несоответствие домена (Domain mismatch).** Чаще всего в сценариях с поддоменами и ECH-прокси (Cloudflare) основной проблемой оказывается именно несоответствие доменного имени (CN/SAN) в fallback-сертификате. |
|     4     |        25%        | **Сбой в конфигурации Cloudflare.** Неправильные DNS-записи, неверная привязка SSL/TLS-сертификатов или конфликт ECH-настроек нередко приводят к ошибке fallback-сертификата, особенно при работе с несколькими субдоменами. |
|     2     |        15%        | **Истёкший или отозванный сертификат.** Это довольно распространённая ситуация, когда сертификат просто просрочился или был отозван, а владелец вовремя не обновил его в настройках.                                                                |
|     3     |        10%        | **Недоверенный сертификат (Untrusted Certificate).** Если fallback-сертификат выпущен неизвестным CA или нарушена цепочка доверия, браузер/клиент отвергнет такой сертификат.                                                                    |
|     6     |        10%        | **Ошибки при выпуске или установке нового сертификата.** Если сертификат недавно переиздавался, возможны проблемы с установкой, цепочкой, промежуточными сертификатами либо конфигурацией сервера.                                                 |
|     5     |        10%        | **Отсутствие корректного fallback-сертификата вообще.** В случае, когда ECH включён, но не настроен fallback-сертификат или он не активен, браузер при «откате» не найдёт валидный SSL и отобразит ошибку.                                           |
~~~

## 5. «Несоответствие домена»
### 5.1.
Я тебя спросил:
~~~
В пункте 3.2 ты писал:
```
1. **Несоответствие домена**  
   - Имя домена (CN или SAN) в «fallback»-сертификате не совпадает с реальным запрашиваемым доменом.
```
Каким образом могло произойти такое несоответствие?
~~~

### 5.2.
Ты ответил:
~~~
Ниже перечислены наиболее частые ситуации, приводящие к тому, что домен в fallback-сертификате не совпадает с реальным запрашиваемым доменом (domain mismatch):

1. **Сертификат не покрывает нужные субдомены**  
   - При выпуске сертификата (даже wildcard) могут не быть учтены все субдомены, которые позже стали использоваться. Например, сертификат покрывает `*.example.com`, но фактически нужно подключиться к `sub.subdomain.example.com`.  
   - Или в SAN (Subject Alternative Name) списка необходимых субдоменов недостаточно.

2. **Опечатка или неверный TLD**  
   - При выпуске сертификата был указан домен с ошибкой в написании (например, `exmple.com` вместо `example.com`), или выбрали не тот TLD (например, `.net` вместо `.com`).  
   - В результате запрашиваемый домен и домен в сертификате не совпадают побайтово.

3. **Старый/«левый» сертификат остался в конфигурации**  
   - Если когда-то выпускался сертификат (или несколько) под другие доменные имена, он мог «застрять» в конфигурации сервера/Cloudflare и использоваться как fallback-сертификат.  
   - При этом в пользовательском интерфейсе Cloudflare может отображаться один сертификат, а на деле сервер отдает другой.

4. **Сертификат не был обновлён вместе с основным**  
   - Иногда администратор выпускает новый SSL-сертификат для основного домена, но забывает обновить тот, что выставлен в качестве fallback’а. В итоге **fallback** продолжает использовать старый (или не включён в SAN) сертификат, что приводит к конфликту.

5. **Неверная конфигурация DNS или Cloudflare**  
   - Некорректные записи (A/AAAA/CNAME) могут указывать на неправильный хост, где используется сертификат от другого домена.  
   - В случае, когда сайт за Cloudflare, но часть трафика уходит напрямую (например, через subdomain) или смешаны разные зоны, может возникнуть конфликт сертификатов.

6. **Ограничения при использовании бесплатных (Universal) сертификатов Cloudflare**  
   - Universal SSL-сертификаты Cloudflare по умолчанию имеют вид `*.example.com` + `example.com`. При сложных цепочках субдоменов (`sub.subdomain.example.com`) эти сертификаты могут перестать подходить.  
   - Если не был добавлен дополнительный custom certificate для более глубоких уровней домена, fallback-сертификат Cloudflare может оказаться несоответствующим.

Все эти сценарии можно свести к одной сути: при настройке fallback-сертификата не были учтены все нужные домены и поддомены, либо в системе остался старый/неправильный сертификат, который теперь отдаётся пользователю при «откате» (fallback) ECH.
~~~

## 6. Что такое «Fallback-сертификат»?
### 6.1.
Я тебя спросил:
~~~
В пункте 2.2 ты писал:
```
   - Fallback-сертификат просрочен, отозван либо не обновлён вовремя у центров сертификации.
```
Что такое «Fallback-сертификат»?
~~~

### 6.2.
Ты ответил:
~~~
**Fallback-сертификат** в контексте ECH (Encrypted Client Hello) — это резервный SSL/TLS-сертификат, который сервер (или прокси, например Cloudflare) предъявляет клиенту в том случае, если у клиента нет поддержки ECH, либо по каким-то причинам (например, несовместимость версий) не удаётся установить шифрованное соединение с использованием ECH.  

Когда ECH включён, сервер (или прокси) сначала пытается установить TLS-соединение так, чтобы информация о домене и параметры соединения были зашифрованы (это и есть суть ECH). Однако если клиент ECH «не понимает», или настройка ECH далека от рабочего состояния, соединение «откатывается» (fallback) на обычный TLS—Handshake без ECH. И именно в этот момент сервер обязан выдать обычный, «классический» сертификат, покрывающий запрашиваемый домен (или поддомены).  

Таким образом, **fallback-сертификат** — это тот самый сертификат, который нужен «на всякий случай», когда ECH использоваться не может. Он должен быть:

1. **Валидным** (не просроченным, не отозванным).
2. **Доверенным** (подписанным известным CA и с корректной цепочкой).
3. **Соответствующим домену** (иметь в полях CN или SAN нужный домен/поддомен).

Если же этот fallback-сертификат некорректно настроен (не покрывает нужный домен, истёк и т. д.), то возникает ошибка вроде **ERR_ECH_FALLBACK_CERTIFICATE_INVALID**, указывающая на то, что при «откате» к обычному TLS браузер видит неправильный или недействительный сертификат.
~~~

## 7. В чём смысл ECH, если клиент всё равно может потребовать «fallback-сертификат»?
### 7.1.
Я тебя спросил:
~~~
В пункте 6.2 ты писал:
```
**Fallback-сертификат** в контексте ECH (Encrypted Client Hello) — это резервный SSL/TLS-сертификат, который сервер (или прокси, например Cloudflare) предъявляет клиенту в том случае, если у клиента нет поддержки ECH, либо по каким-то причинам (например, несовместимость версий) не удаётся установить шифрованное соединение с использованием ECH.  

Когда ECH включён, сервер (или прокси) сначала пытается установить TLS-соединение так, чтобы информация о домене и параметры соединения были зашифрованы (это и есть суть ECH). Однако если клиент ECH «не понимает», или настройка ECH далека от рабочего состояния, соединение «откатывается» (fallback) на обычный TLS—Handshake без ECH. И именно в этот момент сервер обязан выдать обычный, «классический» сертификат, покрывающий запрашиваемый домен (или поддомены).  
```
В чём смысл ECH, если клиент всё равно может потребовать «fallback-сертификат»?
Что конкретно в этом сценарии является «encrypted» в дополнение к обычному сертификату? 
~~~

### 7.2.
Ты ответил:
~~~
Ниже — подробное пояснение, почему **ECH (Encrypted Client Hello)** имеет смысл, даже если для некоторых клиентов всё ещё нужен «откат» на обычный TLS-сертификат, и что конкретно шифруется сверх обычного TLS.

---

## 1. Задача ECH: скрыть информацию о запрашиваемом домене (SNI)

По умолчанию при установлении TLS-соединения клиент отправляет в **Client Hello** имя домена (через расширение SNI), чтобы сервер понял, какой сертификат использовать. Эта часть — SNI (Server Name Indication) — в обычном TLS **не зашифрована** и видна любому, кто может «подглядывать» за трафиком (провайдер, злоумышленник на линии и т. д.).  

**Encrypted Client Hello** (ранее называлось ESNI) решает эту проблему так, что клиент шифрует свой SNI (и другие поля Handshake), используя «ECH-конфигурацию» сервера (набор публичных ключей), и отправляет зашифрованный Client Hello. В итоге:

- Посторонний наблюдатель **не может** увидеть, к какому именно домену на сервере обращается клиент, — он видит только IP-адрес и зашифрованные данные.  
- Сервер (или прокси, как Cloudflare), имея приватные ключи, может расшифровать SNI внутри себя, подобрать нужный сертификат и продолжить **скрытую** от посторонних глаз TLS-сессию.

---

## 2. Зачем нужен fallback-сертификат?

### 2.1. Сохранение совместимости со старыми клиентами

Не все клиенты (браузеры, библиотеки TLS) умеют работать с ECH. Многие «старые» устройства или ПО вообще не знают о таком механизме — для них ECH-поля в handshake будут выглядеть «непонятным» расширением.  

Чтобы соединение всё же состоялось, сервер должен «откатиться» (fallback) на классическую схему TLS, при этом предъявляя **обычный** SSL-сертификат.  
- Если бы такого fallback не существовало, любой клиент без ECH просто не смог бы подключиться к сайту.  

### 2.2. Возможность временной деградации

Даже у современных клиентов иногда возникают сбои (нестабильные сети, баги, специфические ограничения) — в таких случаях TLS тоже может «договориться» вернуться к обычному режиму.  

---

## 3. Так зачем ECH, если всё равно есть fallback?

### 3.1. Большая часть трафика (с поддержкой ECH) работает «приватно»

Когда клиент **поддерживает** ECH (например, современный браузер), **SNI будет зашифрован**. Посторонний наблюдатель не увидит, какой домен вы запрашиваете. Для таких клиентов защита конфиденциальности домена **работает полноценно**.

> - **Итог**: Всякий раз, когда клиент поддерживает ECH, шифруется не только «тело» (HTTP), но и **информация о том, к какому поддомену вы обращаетесь**.  

### 3.2. Fallback нужен лишь для меньшинства

Да, те, кто не поддерживает ECH, продолжат «светить» свой SNI так же, как в обычном TLS. Но глобальный смысл ECH — постепенно перевести весь «современный» трафик на зашифрованный Client Hello.  

Со временем всё больше клиентов станет понимать ECH, и роль fallback-сертификатов будет минимальной (до полного исчезновения, когда ECH станет «новой нормой»).

---

## 4. Что конкретно «encrypt» ECH сверх обычного TLS?

В стандартном (допустим, TLS 1.2 или TLS 1.3 без ECH) шифрование включается **после** того, как клиент отправил незашифрованный Client Hello (где виден домен, версии протокола, шифры и т. д.).  

**В ECH** же клиент, ещё до отправки полного Client Hello, берёт публичный ключ (из «ECH-конфигурации», которую сервер распространяет заранее или получает через DNS/HTTPS) и **зашифровывает** часть своего Client Hello, включая SNI.  

- В результате, **домен** (и ряд других полей Client Hello) защищён от чтения третьими лицами.  
- Наблюдатель видит, что идёт TLS-трафик на какой-то IP, но не знает, к какому именно поддомену или сервису клиент подключается.

Сервер (или прокси, например Cloudflare) расшифровывает этот блок и может выбрать соответствующий сертификат внутри себя. Если же клиент ECH не поддерживает, тогда запускается fallback — «обычный» TLS Handshake.

---

## 5. Краткий вывод

- **ECH** даёт **реальную прибавку к приватности** для тех клиентов, которые его поддерживают, скрывая SNI и другие поля Client Hello.  
- **Fallback-сертификат** не «обесценивает» ECH, а просто обеспечивает совместимость со старыми клиентами или в случае временных ошибок/несовместимостей.  
- Главная идея: *«Кто может — общается через ECH и скрывает SNI, кто не может — получает старый TLS, как раньше»*. Со временем доля «кто не может» должна сильно упасть.  

Таким образом, наличие fallback-а не противоречит смыслу ECH. Для современных клиентов мы **дополнительно шифруем** сам факт, какой конкретно домен запрашивается. Для остальных (старых) клиентов есть аварийный вариант — обычный TLS, который не скрывает SNI.  
~~~

## 8. «где виден домен, версии протокола, шифры и т. д.»
В пункте 7.2 ты писал:

```
В стандартном (допустим, TLS 1.2 или TLS 1.3 без ECH) шифрование включается **после** того, как клиент отправил незашифрованный Client Hello (где виден домен, версии протокола, шифры и т. д.).
```
Кому конкретно видны «домен, версии протокола, шифры и т. д.»?