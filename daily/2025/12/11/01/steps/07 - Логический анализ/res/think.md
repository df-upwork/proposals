1. **Логическая ошибка (Цикличность в формуле, п. 10.1)**
В формуле расчёта безопасного лимита (`RAM minus ... minus memory for metadata`) предлагается вычесть объём памяти под метаданные. Однако этот объём не является константой: он линейно зависит от количества объектов, которое, в свою очередь, ограничивается размером хранилища (`malloc limit`). Невозможно вычислить безопасный `malloc limit`, вычитая из RAM значение, которое само является функцией от этого лимита, без введения переменной «средний размер объекта».
Степень уверенности: 100

2. **Фактическая ошибка (Неполнота формулы, п. 10.1)**
Формула игнорирует два критически важных потребителя памяти:
1) **Фрагментация памяти (Fragmentation Overhead):** Даже при использовании `jemalloc` (`R3`), накладные расходы на фрагментацию составляют 10–20%, а при `glibc` могут достигать 30–50%. Игнорирование этого фактора ведёт к опасной переоценке доступных ресурсов.
2) **Память потоков (Thread Memory):** Не учтены расходы на стеки тысяч потоков и их рабочие области (workspaces), которые в высоконагруженной системе могут занимать 1–2 ГБ.
Степень уверенности: 100

3. **Фактическая ошибка (Рискованная рекомендация, п. 10.1)**
Рекомендация установить лимит «18–20 GB» для сервера с 32 ГБ RAM является опасной в условиях нерешённой проблемы `Cache Bloat` (`⋇1`).
*Расчёт риска:* 20 ГБ (Данные) + 2 ГБ (Transient) + 2 ГБ (ОС) = 24 ГБ. Если добавить реалистичную фрагментацию (20% от 22 ГБ кучи ≈ 4.4 ГБ) и память потоков (1 ГБ), то занято уже 29.4 ГБ. На метаданные остаётся всего ~2.6 ГБ. Этого хватит лишь на ~2.6 млн объектов. При атаке «Cache Bloat» это число будет превышено, и произойдёт OOM. Безопаснее рекомендовать 14–16 ГБ.
Степень уверенности: 95

4. **Логическая ошибка (Ложное утверждение о предотвращении OOM, п. 10.2.1)**
Утверждение, что `R4` предотвращает (prevents) срабатывание OOM Killer благодаря «точному учёту всех потребителей», ложно.
Varnish (Community Edition) **не ведёт** внутри процесса учёт накладных расходов (метаданные, фрагментация) в рамках лимита `-s malloc`. Этот параметр ограничивает только «чистый» вес объектов. Если рекомендация `R1` (нормализация) не сработает, метаданные могут бесконтрольно расти сверх лимита, что неизбежно приведёт к краху процесса, несмотря на выполнение `R4`.
Степень уверенности: 98