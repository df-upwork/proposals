I. Ваша проблема связана с конфигурацией аутентификации групп Entra ID в Azure Database for PostgreSQL Flexible Server.
Успешная аутентификация через группы требует, чтобы сервер мог разрешить членство пользователя в группах Entra ID.
Это разрешение может происходить либо в момент входа (Just-In-Time, JIT), либо через фоновую синхронизацию.
Фоновая синхронизация всегда требует взаимодействия сервера с Microsoft Graph API, в то время как JIT требует его только в определенных сценариях (например, при Group Claim Overage).
Хотя используются внутренние механизмы, им необходима авторизация для чтения данных из тенанта клиента.
Service principal, представляющий службу Azure PostgreSQL в Entra ID клиента, должен обладать соответствующими permissions Microsoft Graph API.
Обычно требуются разрешения `GroupMember.Read.All` или `Directory.Read.All`.
Отсутствие этих разрешений или согласия администратора (Admin Consent) является частой корневой причиной сбоев при разрешении членства в группах.
Следовательно, наиболее вероятные корневые причины проблемы связаны с отсутствием необходимых разрешений Microsoft Graph API, сетевым доступом к Microsoft Graph API или конфигурацией режима аутентификации.
Режим работы определяется параметром сервера `pgaadauth.enable_group_sync`.
II.
1) Режим 1: Синхронизация групп отключена (режим по умолчанию)
Параметр `pgaadauth.enable_group_sync` выключен.
В этом режиме PostgreSQL не выполняет фоновую синхронизацию членства в группах.
Проверка членства в группе происходит в момент входа (JIT) и в первую очередь основана на анализе claims в Access Token пользователя.
1.1) Сценарий 1.1: Использование UPN вместо имени группы
1.1.1) Суть
Чтобы аутентифицироваться через группу в этом режиме, пользователи обязаны использовать имя группы Entra ID в качестве имени пользователя.
Ошибка возникает, если пользователи пытаются войти в систему, используя свой User Principal Name (UPN, например, `user@company.com`), ожидая при этом наследования разрешений группы.
1.1.2) Обоснование
Система ожидает имя группы в качестве имени пользователя при входе (в psql или DBeaver) и личный Access Token пользователя в качестве пароля.
Если пользователи используют свой UPN, система пытается аутентифицировать их по индивидуальной роли UPN (прямое сопоставление).
Если индивидуальная роль UPN существует на сервере (как в вашем случае с прямым сопоставлением), вход будет успешным, но пользователь не получит разрешения группы.
Если индивидуальная роль UPN не существует (а настроена только групповая роль), аутентификация завершится ошибкой (например, «role not found»).
1.2) Сценарий 1.2: Group Claim Overage
1.2.1) Суть
Пользователь является членом слишком большого количества групп Entra ID (обычно более 200 для JWT).
В этом случае Entra ID не включает полный список групп в Access Token пользователя, а вместо этого добавляет overage claim.
Даже если пользователь правильно указывает имя группы при входе (согласно Сценарию 1.1), аутентификация завершается неудачей.
1.2.2) Обоснование
При возникновении overage сервер должен выполнить JIT-запрос к Microsoft Graph API для получения полного списка групп пользователя.
Этот запрос выполняется внутренними механизмами службы.
Запрос завершается неудачей, если субъект-служба Azure PostgreSQL не имеет необходимых разрешений Microsoft Graph API (например, `GroupMember.Read.All`) в тенанте клиента.
Также запрос завершается неудачей, если сервер не может установить исходящее соединение с Microsoft Graph API (например, из-за блокировки трафика к Service Tag `AzureActiveDirectory` в Network Security Groups (NSG) или проблем с Custom DNS).
Если запрос не успешен, сервер не может подтвердить членство пользователя в целевой группе, что приводит к сбою аутентификации.
2) Режим 2: Синхронизация групп включена
Параметр `pgaadauth.enable_group_sync` включен.
Этот режим предназначен для обеспечения входа по UPN с наследованием групповых разрешений.
Сервер выполняет периодическую фоновую синхронизацию (обычно каждые 30 минут) членства в группах через Microsoft Graph API.
Аутентификация полагается на предварительно синхронизированные данные, поэтому Group Claim Overage в токене пользователя не приводит к ошибке аутентификации в этом режиме.
2.1) Сценарий 2.1: Проблемы с доступом к Microsoft Graph API (Разрешения и Сеть)
2.1.1) Суть
Для фоновой синхронизации серверу необходим доступ к Microsoft Graph API (например, `graph.microsoft.com`).
Сбой синхронизации происходит, если отсутствуют необходимые разрешения Microsoft Graph API или если исходящий сетевой доступ заблокирован.
Блокировка сетевого доступа часто встречается в конфигурациях с частным доступом (Private access / VNet integration), использованием NSG или Custom DNS.
2.1.2) Обоснование
Фоновый процесс синхронизации требует запросов к Microsoft Graph API.
Во-первых, субъект-служба Azure PostgreSQL должен иметь необходимые разрешения (например, `GroupMember.Read.All`) для чтения членства в группах.
Во-вторых, хотя сервер использует внутренние механизмы для этих запросов, они должны проходить через сетевую инфраструктуру клиента.
Фоновая синхронизация не работает, если отсутствуют разрешения, если исходящий трафик к Service Tag `AzureActiveDirectory` заблокирован (например, в NSG или User Defined Routes (UDR)), или если DNS не разрешает адреса Microsoft Graph API корректно.
Пользователи не могут войти по UPN, полагаясь на групповые роли, так как сервер не располагает актуальными данными об их членстве.
2.2) Сценарий 2.2: Задержка синхронизации (Latency)
2.2.1) Суть
Синхронизация членства в группах происходит с интервалом (по умолчанию 30 минут).
Если пользователь был добавлен в группу недавно, сервер может еще не располагать этой информацией.
2.2.2) Обоснование
Аутентификация в этом режиме полагается на предварительно синхронизированные данные.
Если данные устарели, аутентификация пользователя с новыми групповыми разрешениями завершится неудачей, даже если в Entra ID конфигурация верна.
Прямая аутентификация пользователя (если настроена индивидуальная роль) работает, так как она основана на Object ID (OID) пользователя в токене и не зависит от фоновой синхронизации групп.
