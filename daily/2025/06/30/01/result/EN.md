The correct way to diagnose 500 errors in Azure App Services:
1) It is necessary to clearly understand the meaning of code 500: «a generic error message, given when an unexpected condition was encountered and no more specific message is suitable»
https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#500
The correct approach to resolving such problems is to implement a failure diagnostic system that explicitly identifies the cause of the failure rather than hypothesizing about it.
2) First, it is necessary to connect Azure App Service with Application Insights correctly.
2.1) In the «App Service» → «Settings» → «Environment variables» section, it is necessary to configure `APPLICATIONINSIGHTS_CONNECTION_STRING` correctly.
2.2) The correct NuGet packages for the Application Insights SDK must be installed in the .NET application (primarily, `Microsoft.ApplicationInsights.AspNetCore`).
2.3) In the application startup code (usually in `Program.cs` ), the `services.AddApplicationInsightsTelemetry()` call must be included.
2.4) The easiest way to verify the correct integration between Azure App Service and Application Insights is via «Application Insights» → «Investigate» → «Live Metrics».
2.5) If Live Metrics does not show any data for the failing endpoint, this indicates a serious startup failure that prevents the initialization of the Application Insights SDK or even prevents the request from reaching the ASP.NET Core pipeline.
An example of such a failure is: «500.30 - ANCM In-Process Start Failure».
In such cases, it is necessary to perform diagnostics using the methods outlined in points 3-6 below.
3) In the «Monitoring» → «App Service logs» section, it is necessary to enable 4 options:
3.1) «Application Logging» and «Web server logging».
It is necessary to set the «Level» parameter to «Verbose».
3.2) «Detailed Error Messages».
This allows the exact HTML error page generated by IIS to be saved.
This page often contains more specific error codes and messages than the generic 500 response.
3.3) «Failed Request Tracing».
This is the most powerful tool for diagnosing IIS pipeline problems. 
It generates a detailed XML trace of each module's activity for a failed request.
4) In the «Monitoring» → «Log Stream» section, it is possible to see the logs from point 3 in real-time.
For example, it is possible to call the problematic endpoint `/api/user/roles` and immediately see what the system will log.
5) Diagnostics via `stdout`.
5.1) To capture the `stdout` and `stderr` output, it is necessary to modify the ANCM module configuration. The most direct way to do this in the Azure App Service environment is to use the Kudu console to edit the `web.config` file.
Access to the Kudu console: «Development Tools» → «Advanced Tools» → «Go».
Access to the command line from Kudu: «Debug console» → «CMD».
The entire configuration specific to the ANCM module is located within the `<aspNetCore>` element of the `web.config` file.
An example of the `<aspNetCore>` configuration:

```xml
<aspNetCore processPath="dotnet"
	arguments=".\YourApplication.dll"
	stdoutLogEnabled="true"
	stdoutLogFile="\\?\%home%\LogFiles\stdout"
	hostingModel="InProcess">
</aspNetCore>
```
5.2) After restarting the application and reproducing the error, the log file must be created in the specified directory.
The contents of the `stdout` log file is the key to diagnosing the problem.
It typically contains the full exception message and stack trace indicating the exact location in the code where the failure occurred.
6) The most powerful method of diagnostics (when the methods of points 2-5 do not help): «Development Tools» → «Advanced Tools» → «Go» → «Tools» → «Diagnostic dump».
---
I have completed 536 projects here on Upwork.
My GitHub profile: https://github.com/dmitrii-fediuk
My websites: https://df.tips?order=views, https://dmitry.ai?order=views, https://mage2.pro?order=views 
