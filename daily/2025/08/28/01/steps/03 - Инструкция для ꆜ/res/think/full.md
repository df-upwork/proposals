https://g.co/gemini/share/7b23a0e260d6

1. Провести анализ исторических запусков (Historical Pipeline Runs)

Цель: Диагностировать причины прошлых сбоев, изучив журналы выполнения, прежде чем пытаться запустить конвейер вручную.

1.1. Перейти в Azure Data Factory Studio.

1.2. Открыть вкладку «Monitor» на левой боковой панели.

1.3. В разделе «Pipeline runs» изучить список предыдущих выполнений целевого конвейера. Использовать фильтры по имени конвейера (Pipeline name) и статусу (Status, например, «Failed»), чтобы найти интересующие запуски. Убедиться, что анализируются запуски типа «Triggered» (производственные запуски), а не «Debug».

1.4. Проанализировать детали сбойного запуска.
1.4.1. Кликнуть на имя конвейера в списке, чтобы перейти к списку «Activity runs» (выполнения действий).
1.4.2. Идентифицировать действие (activity), которое завершилось сбоем.
1.4.3. Изучить детальное сообщение об ошибке. Для этого кликнуть на иконку в колонке «Error» для этого activity.
1.4.4. Изучить входные параметры, которые были использованы при этом запуске. Для этого найти колонку «Parameters» (на уровне Pipeline run или в верхней части экрана Activity runs) и посмотреть значения, которые были фактически переданы в конвейер.

Обоснование: Задача состоит в том, чтобы понять, почему конвейеры не работали в прошлом. Стандартным и наиболее эффективным первым шагом в ADF является просмотр исторических журналов выполнения на вкладке «Monitor», а не немедленный запуск конвейера. Это позволяет увидеть точные сообщения об ошибках и входные параметры, использованные во время сбоя, что помогает восстановить контекст выполнения.
Источник: Microsoft Learn: Visually monitor Azure Data Factory.

2. Проверить внешние зависимости и подключения (External Dependencies)

Цель: Исключить инфраструктурные проблемы (сеть, аутентификация), которые могут приводить к сбоям конвейера, до того как анализировать его логику.

2.1. Перейти на вкладку «Manage» на левой боковой панели.

2.2. Проверить связанные службы (Linked Services).
2.2.1. Перейти в раздел «Linked services».
2.2.2. Идентифицировать все Linked Services, используемые в целевом конвейере (их можно найти в настройках Datasets или Activities).
2.2.3. Для каждого Linked Service открыть его конфигурацию и использовать функцию «Test connection». Убедиться, что аутентификация (например, Managed Identity, Service Principal, ключи в Azure Key Vault) настроена корректно и нет сетевых ограничений (Firewall, VNet).

Обоснование: Конвейеры ADF сильно зависят от внешних систем. Значительная часть сбоев связана с инфраструктурой и безопасностью (аутентификация, сеть), а не с логикой конвейера или параметрами. Проверка «Test connection» позволяет валидировать доступность ресурсов до запуска конвейера.
Источник: Microsoft Learn: Linked services in Azure Data Factory; Troubleshoot connectors.

2.3. Проверить среды выполнения (Integration Runtimes).
2.3.1. Перейти в раздел «Integration runtimes».
2.3.2. Проверить статус Integration Runtimes, используемых в Linked Services. Убедиться, что они находятся в состоянии «Running», особенно если используются Self-Hosted Integration Runtimes.

Обоснование: Конвейеры зависят от Integration Runtimes для выполнения действий и перемещения данных. Если среда выполнения недоступна, выполнение конвейера невозможно.
Источник: Microsoft Learn: Integration runtime in Azure Data Factory.

3. Идентифицировать и проанализировать параметры конвейера (Pipeline Parameters)

Цель: Определить, какие входные данные ожидает конвейер, их типы и как они используются в логике обработки.

3.1. Перейти на вкладку «Author» на левой боковой панели.

3.2. Найти и открыть целевой конвейер.

3.3. Кликнуть на пустую область холста (canvas) конвейера, чтобы отобразить его общие настройки.

3.4. Перейти на вкладку «Parameters». Составить список всех параметров, зафиксировав их «Name», «Type» (например, String, Int, Array, Object, SecureString) и «Default value» (значение по умолчанию), если оно указано.

Обоснование: Параметры определяются на уровне конвейера и используются для передачи внешних значений. Идентификация параметров, их типов и значений по умолчанию является необходимым шагом для понимания входных требований. Знание типа данных критично, особенно для сложных типов (Array, Object).
Источник: Microsoft Learn: Parameters and variables in Azure Data Factory.

3.5. Изучить, как параметры используются внутри конвейера.
3.5.1. Выбрать каждое activity на холсте (например, Copy activity, Lookup, Data Flow).
3.5.2. Проверить вкладки настроек (например, «Settings», «Source», «Sink») на предмет использования динамического содержимого (dynamic content).
3.5.3. Идентифицировать выражения (expressions), которые ссылаются на параметры конвейера, используя синтаксис `@pipeline().parameters.<parameterName>`.

Обоснование: Необходимо понять назначение каждого параметра. Анализ того, как параметры используются в выражениях (например, для формирования путей к файлам, строк подключения или фильтров запросов), позволяет определить, какие значения являются корректными.
Источник: Microsoft Learn: How to use parameters, expressions and functions in Azure Data Factory.

4. Определить источники значений параметров (Parameter Sources)

Цель: Определить, как конвейер получает параметры в производственной среде (часто автоматически через триггеры), чтобы эмулировать эти значения при ручном тестировании.

4.1. Проанализировать связанные триггеры (Triggers).
4.1.1. Находясь в редакторе конвейера (вкладка «Author»), нажать кнопку «Trigger» на верхней панели и выбрать «New/Edit».
4.1.2. В открывшейся панели изучить конфигурацию существующих триггеров, связанных с этим конвейером.

4.2. Изучить параметры, передаваемые триггером.
4.2.1. Продвигаясь по конфигурации триггера, обратить внимание на шаг, где заполняются параметры конвейера.
4.2.2. Идентифицировать использование системных переменных (System Variables). Это выражения, начинающиеся с `@trigger()` или `@triggerBody()`. Примеры:
- `@trigger().outputs.windowStartTime` (для Tumbling Window Trigger).
- `@triggerBody().fileName` (для Storage Event Trigger).

Обоснование: Производственные конвейеры часто получают метаданные (например, временные метки или имена файлов) автоматически от триггеров через System Variables. При ручном тестировании (Debug) пользователь должен эмулировать эти значения самостоятельно. Незнание этой зависимости является частой причиной проблем с ручным запуском.
Источник: Microsoft Learn: Pass trigger information to pipeline; System variables supported by Azure Data Factory.

4.3. Определить значения для тестирования. Использовать комбинацию значений из исторических запусков (Шаг 1.4.4), значений по умолчанию (Шаг 3.4) и эмулированных значений триггеров (Шаг 4.2.2) для формирования набора тестовых входных данных.

5. Выполнить тестовый запуск (Test Run)

Цель: Запустить конвейер с корректными параметрами в контролируемом режиме и проверить его работоспособность.

5.1. Находясь на вкладке «Author» в редакторе целевого конвейера, начать выполнение в режиме отладки, нажав кнопку «Debug» на верхней панели инструментов.

Обоснование: Режим «Debug» используется для тестирования текущей версии конвейера на холсте (включая неопубликованные изменения) и позволяет наблюдать за выполнением в реальном времени без необходимости публикации (Publish). Он предпочтителен для итеративной разработки и тестирования.
Источник: Microsoft Learn: Iterative development and debugging using Azure Data Factory.

5.2. В открывшейся панели (обычно называется «Pipeline Debug» или «Pipeline run parameters») ввести значения для параметров, определённые на Шаге 4.3.

5.3. Соблюдать корректный формат ввода данных:
5.3.1. При эмуляции временных меток триггера использовать формат ISO 8601 (например, `2025-08-27T10:00:00Z`).
5.3.2. Для параметров типа Array ввести значение в формате JSON массива. Например: `["item1", "item2"]`.
5.3.3. Для параметров типа Object ввести значение в формате JSON объекта. Например: `{"key1": "value1", "key2": "value2"}`.

Обоснование: Корректный ввод параметров, особенно сложных типов (Array, Object), необходим для успешного запуска. Неправильный формат JSON приведет к ошибкам валидации еще до начала выполнения.
Источник: Microsoft Learn: Parameters and variables in Azure Data Factory.

5.4. Нажать «OK», чтобы начать выполнение.

5.5. Наблюдать за ходом выполнения на вкладке «Output» под холстом конвейера. Проверить входные (Input) и выходные (Output) данные для каждого Activity после его завершения, чтобы убедиться, что параметры были интерпретированы корректно.