# 1. C3↯⬆⠿

## 1.1. C3↯⬆₁ (Гибкость конфигурации драйвера MongoDB)

### Суть
Решение на базе Google Cloud Dataflow позволяет пользователю полностью контролировать строку подключения (URI) к MongoDB, передаваемую драйверу.
Это дает возможность явно указать параметр `directConnection=true`, который необходим для подавления механизма автоматического обнаружения топологии кластера при работе через приватные каналы без DNS.
В отличие от Datastream, API которого жестко ограничивает набор полей профиля, шаблон Dataflow принимает сырую строку URI, что позволяет использовать любые опции драйвера Java.
Таким образом, Dataflow технически устраняет блокирующий конфликт `C1⊥`, предоставляя инструмент для обхода ограничений маршрутизации Atlas.

### Оценка
95

### Доводы за
Шаблон Dataflow «MongoDB to BigQuery» официально поддерживает поле `mongoDbUri`, принимающее стандартный формат строки подключения.
Возможность использования `directConnection=true` гарантированно решает проблему попыток драйвера подключиться к недоступным внутренним адресам узлов Atlas.
Это решение не зависит от скрытых обновлений API Datastream или багов провайдера Terraform, так как базируется на открытом коде Apache Beam.
Инженер получает полный контроль над таймаутами (`connectTimeoutMS`) и параметрами пула соединений, что критично для стабильности CDC.

### Доводы против
Использование Dataflow требует значительно более высокой квалификации инженеров для развертывания и мониторинга конвейеров Apache Beam.
Стоимость эксплуатации Dataflow (оплата за vCPU/RAM в секунду) для постоянных стриминговых задач обычно выше, чем фиксированная цена Datastream за гигабайт.
Время холодного старта и применения изменений конфигурации в Dataflow исчисляется минутами, в то время как Datastream реагирует почти мгновенно.
Отсутствует встроенная интеграция с консолью управления Datastream, что фрагментирует управление потоками данных.

## 1.2. C3↯⬆₂ (Нативное разрешение DNS)

### Суть
Воркеры Dataflow разворачиваются непосредственно в подсети пользовательской VPC, что обеспечивает им естественный доступ к инфраструктуре Cloud DNS.
Это позволяет использовать стандартные механизмы разрешения имен для доступа к узлам Atlas, если настроена частная зона DNS или DNS-форвардинг.
В отличие от Datastream, который работает в изолированной сети Google, Dataflow не имеет ограничений на использование протокола DNS в приватных подключениях.
Это устраняет необходимость в ручном управлении IP-адресами и позволяет использовать SRV-записи (`mongodb+srv://`) при наличии корректной сетевой связности.

### Оценка
90

### Доводы за
Нахождение вычислительных ресурсов внутри периметра VPC гарантирует корректную работу всех сетевых протоколов, включая DNS и mTLS.
Устраняется проблема «Split-Horizon DNS», так как воркеры используют те же резолверы, что и остальные приложения в этой сети.
Это позволяет использовать доменные имена в сертификатах SSL, что автоматически решает проблему валидации `Hostname Mismatch`.
Упрощается сетевая диагностика, так как администратор имеет доступ к логам воркеров и может использовать стандартные утилиты типа `dig` или `telnet`.

### Доводы против
Для работы DNS все равно требуется корректная настройка Private Zone или DNS Peering, что само по себе является нетривиальной задачей.
Если сетевая связность с Atlas (пиринг или PSC) настроена некорректно, наличие DNS не решит проблему доступности портов.
Использование DNS может маскировать проблемы с задержкой распространения обновлений записей при смене топологии кластера.
Воркеры Dataflow требуют наличия внешнего IP или Cloud NAT для загрузки зависимостей, что усложняет сетевой периметр.

# 2. C3↯⬇⠿

## 2.1. C3↯⬇₁ (Архитектурная чистота и безопасность)

### Суть
Решение на базе Private Service Connect (PSC) обеспечивает строгую изоляцию трафика, который никогда не покидает магистральную сеть Google.
Это соответствует наиболее жестким стандартам безопасности и исключает риски, связанные с транзитивным пирингом или публичными IP-адресами.
PSC является целевой архитектурой интеграции сервисов в Google Cloud, обеспечивая однонаправленный доступ и гранулярное управление разрешениями.
Использование нативного механизма интеграции Datastream с Atlas через PSC минимизирует количество промежуточных компонентов, которыми нужно управлять.

### Оценка
40

### Доводы за
PSC устраняет проблему пересечения адресных пространств (IP overlapping), которая часто блокирует использование VPC Peering в крупных организациях.
Отсутствие необходимости в управлении виртуальными машинами (как в случае с прокси или Dataflow) снижает операционную нагрузку (NoOps).
Решение официально поддерживается обоими вендорами (Google и MongoDB) как рекомендуемый паттерн для Enterprise-сегмента.
Использование PSC Endpoint обеспечивает стабильную точку входа в кластер, абстрагируя изменения внутренней инфраструктуры Atlas.

### Доводы против
В текущей реализации Datastream для MongoDB через PSC сохраняется фундаментальная проблема отсутствия DNS-резолвинга.
Без использования промежуточного прокси или хака с `directConnection` (который недоступен в UI), чистое решение PSC **неработоспособно** для Replica Set.
Драйвер Datastream при подключении к IP PSC получит список внутренних хостнеймов Atlas и не сможет к ним подключиться.
Рекомендация использовать PSC игнорирует тот факт, что Datastream API не позволяет корректно настроить клиент для работы в такой топологии.

## 2.2. C3↯⬇₂ (Экономическая эффективность)

### Суть
Использование нативного коннектора Datastream через PSC обычно экономически выгоднее, чем запуск постоянных вычислительных кластеров.
Модель ценообразования Datastream основана на объеме переданных данных (CDC), что выгодно для сценариев с низкой или средней интенсивностью изменений.
Отсутствие постоянно работающих виртуальных машин (Dataflow workers или Proxy VMs) снижает базовую стоимость владения инфраструктурой.
Использование PSC позволяет избежать затрат на трафик через NAT-шлюзы или публичный интернет.

### Оценка
60

### Доводы за
Для проектов с небольшим трафиком Datastream может быть на порядок дешевле, чем минимальный кластер Dataflow.
Отсутствие скрытых расходов на межзональный трафик (при правильной настройке) делает бюджет предсказуемым.
Бессерверная природа Datastream означает отсутствие затрат на простой инфраструктуры или оверхед на управление ресурсами.
Снижаются затраты на инженерный ресурс, так как не требуется поддерживать код конвейеров или конфигурацию серверов.

### Доводы против
Экономия теряет смысл, если решение технически не способно обеспечить репликацию данных из-за ошибки подключения.
Необходимость покупки выделенного кластера MongoDB Atlas (M10+) для поддержки PSC может перекрыть экономию на трафике.
Если для работы PSC потребуется развертывание прокси-серверов (как выяснилось в анализе `R5`), экономическая выгода нивелируется стоимостью VM.
Потенциальные потери бизнеса от простоя репликации из-за нестабильности "чистого" PSC решения превышают экономию на инфраструктуре.

# 3. Вердикт

## 3.1. Анализ противоречия C3↯⠿
Конфликт `C3⊥` заключается в выборе между теоретически правильной архитектурой (`S⌖A2ᚖ-R2`, PSC), которая на практике не работает из-за ограничений реализации продукта, и тяжеловесным, но гарантированно рабочим обходным путем (`S⌖A2ᚖ-T`, Dataflow).
Анализ показывает, что рекомендация `S⌖A2ᚖ-R2` (чистый PSC) страдает от критического недостатка: она игнорирует неспособность Datastream разрешать имена и управлять топологией без дополнительных "костылей".
Без применения прокси-сервера (предложенного в `R5`, но отсутствующего в `R2`) или патча конфигурации через CLI, чистое PSC-подключение к Replica Set обречено на сбой.
Рекомендация `S⌖A2ᚖ-T` (Dataflow) технически безупречна, так как устраняет корневую причину (невозможность настройки драйвера), но является "стрельбой из пушки по воробьям".

## 3.2. Оценка правдоподобности Pⰳ(C3↯ᵢ)

### Pⰳ(C3↯⬆ - Dataflow)
**95**
Это решение гарантированно заработает, так как оно снимает все ограничения "черного ящика" Datastream.
Единственный риск — сложность внедрения, но техническая реализуемость абсолютна.

### Pⰳ(C3↯⬇ - PSC)
**20**
В контексте "чистой" рекомендации (без прокси) это решение неработоспособно для MongoDB Atlas Replica Set.
Оно заработает только если вы превратите его в гибридное решение с прокси (`A1ᚖ⠿-R5`), но как самостоятельная стратегия оно вводит в заблуждение.

## 3.3. Итоговая рекомендация R
Я рекомендую вам отказаться от попыток настроить "чистый" Datastream через PSC (`S⌖A2ᚖ-R2`), так как без сложных обходных путей это приведет к ошибкам соединения.
Если вы обладаете компетенциями в Java/Data engineering, выберите **Google Cloud Dataflow (`S⌖A2ᚖ-T`)**, так как это даст вам полный контроль и стабильность.
Если Dataflow слишком сложен, вам придется реализовать **гибридную схему с TCP-прокси (NGINX)** внутри вашей VPC, как описано в `A1ᚖ⠿-R5`, но это выходит за рамки чистого выбора между T и R2.
В рамках строгого выбора между `S⌖A2ᚖ-T` и `S⌖A2ᚖ-R2` побеждает **Dataflow** за явным преимуществом в технической реализуемости.